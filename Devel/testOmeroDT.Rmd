
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)
```


```{r }
#Author: Mark Dane, copyright 2015

source("./MEPLINCSFunctions.R")

analysisVersion <- "v1.3"
cellLine<- "PC3"
ss <- "SS1"

```



```{r setup}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

l3 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",analysisVersion,"_Level3.txt"), showProgress = FALSE)
l4 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",analysisVersion,"_Level4.txt"), showProgress = FALSE)

barcodes <- sort(unique(l3$Barcode))


#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.7

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

if(!analysisVersion=="v1"){
  # l3$OmeroDetailURL <- paste0('<a href="https://graylab.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank"> <img border="0" alt="Omero" src="https://graylab.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' width="50" height="50"></a>')
    l3$OmeroDetailURL <- paste0('<a href="https://graylab.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://graylab.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://graylab.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}


```


```{r Filtering, echo=FALSE}

#Remove the fiducial and blank data
setkey(l3,ECMp)
l3F <- l3[!"fiducial"]
l3F <- l3F[!"blank"]
setkey(l3F,"Ligand")
l3F <- l3F[!grepl("FBS", l3F$Ligand)]

#Remove failed QA wells
l3F <- l3F[!l3F$QA_LowWellQA]
l4F <- createl4(l3F)
#Add Robust Z Scores of the normalized Spot Cell Counts #across the entire staining set
l4F <- l4F[,Spot_PA_SpotCellCount_Norm_RobustZ := RZScore(Spot_PA_SpotCellCount_Norm)]

if (ss == "SS2"){
  #Add Robust Z Score of the Edu Signal
  l4F <- l4F[,Nuclei_PA_Gated_EduPositiveProportion_Norm_RobustZ := RZScore(Nuclei_PA_Gated_EduPositiveProportion_Norm)]
}

if (ss == "SS3"){
  #Add Robust Z Scores of the normalized lineage ratios
  l4F <- l4F[, Cytoplasm_PA_Intensity_LineageRatio_Norm_RobustZ:= RZScore(Cytoplasm_PA_Intensity_LineageRatio_Norm)]
  
}

#Filter for high spot occupancy and good quality DAPI####
l3HF <- l3F[l3F$Spot_PA_SpotCellCount > HFSCCThresh]
l3HF <- l3HF[!l3HF$QA_LowDAPIQuality]
l3HF <- l3HF[!l3HF$QA_LowRegionCellCount]
l4HF <- createl4(l3HF)
l4HF <- l4HF[l4HF$Spot_PA_ReplicateCount >= HFRepThresh]

```

```{r MitoTrackerHistogram, eval=ss=="SS1"}

setkey(l4HF,"Ligand")
dt <- l4HF[!"FBS"]

setkey(dt, Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker_Norm)
datatable(format(dt[,list(MEP,Barcode, Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker_Norm,Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker_Norm_SE,Spot_PA_ReplicateCount)], digits=1, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = c("MEP", "Barcode", "MitoTracker Int.", "MitoTracker Int. SE", "Replicate Count"))

if(!analysisVersion=="v1"){
  setkey(l3HF, Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker_Norm)
  datatable(format(l3HF[,list(MEP,Barcode,OmeroDetailURL,ArrayRow,ArrayColumn, Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker_Norm)], digits=1, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = c("MEP", "Barcode","Omero","Row","Column","MitoTracker Int."),escape = FALSE)
}
```

