
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r }
#Author: Mark Dane, copyright 2015

source("~/Documents/MEP-LINCS/MEPLINCSFunctions.R")

```



```{r setup,cache=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

l1 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine,"_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level1.txt"), showProgress = FALSE)
l2 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine,"_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level2.txt"), showProgress = FALSE)
l3 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level3.txt"), showProgress = FALSE)
l4 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level4.txt"), showProgress = FALSE)

barcodes <- sort(unique(l3$Barcode))


#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.8

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

# https://meplincs.ohsu.edu/webclient/

if(!analysisVersion=="v1"){
  l3$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}

```


#MEP-LINCS `r cellLine` `r ss` Phase 1 QA Report
####date: `r Sys.Date()`

##Summary
The MEP-LINCS `r cellLine` `r ss` datasets include four levels of high content imaging data from on Microenvironment Microarrays (MEMAs). After QA filtering, there are `r nrow(l4[!grepl("PBS|Fiducial",l4$ECMp),][!grepl("FBS",l4$Ligand)])` Microenvironment Perturbations (MEPs) that are pairwise combinations of `r length(unique(l4$ECMp[!grepl("PBS|Fiducial",l4$ECMp)]))` printed ECM proteins and `r length(unique(l4$Ligand[!grepl("FBS",l4$Ligand)]))` ligands or growth factors.  

##Introduction
The LINCS Pilot `r cellLine` `r ss` experiment was performed with cells grown in `r length(barcodes)` 8-well plates. The `r ss` staining set includes, DAPI, `r unique(l4$Endpoint488)`, `r unique(l4$Endpoint555)` and `r unique(l4$Endpoint647)`. Color images of the cells at each spot were gathered on a Nikon automated microscope. The CP Pipeline `r rawDataVersion` performed the segmentation and the analysis pipeline is `r analysisVersion`.

Intensity, position and a limited set of morphology data are gathered for each cell, merged with the experiment metadata, normalized, filtered and summarized. The dataset is organized into the four LINCS imaging categories as follows:

Level 1 - Raw data  
Level 2 - Normalized data  
Level 3 - Normalized data aggregated to the spot level  
Level 4 - Normalized data aggregated to the replicate (MEP) level  

The data merging and analysis is done in R using open source software. 

\newpage

##QA Scoring of the dataset
Each well is scored for even cell seeding according to the count of the DAPI-stained nuclei. A detailed explanation of the QA method is in the supplemental material. In brief, the level 2 and 3 data have cell counts at the spot level and locally-averaged cell counts at the neighborhood level. Both of these parameters are used to score the wells and filter the dataset. QA Scores range from 0 to 1 and represent the proportion of the spots that have at least one cell and are not in low cell count neighborhoods.

The following plots are pseudoimages of each MEMA's spot cell count and a histogram of the loess model used for QA scoring. 


```{r Heatmaps_QAScores, fig.width=3.7,fig.height=4, eval=TRUE}

plotSCCHeatmapsQAHistograms(l3, barcodes, lthresh=lthresh)

```

The following histograms show the raw spot cell counts for each array.  
```{r SCCHistograms, fig.width=3.7,fig.height=4, eval=TRUE}
xLimits <- quantile(l3$Spot_PA_SpotCellCount, probs=c(0,.995))
yLimits <- c(0,75)

for (barcode in barcodes){
  setkey(l3,"Barcode")
  dt <- l3[barcode]
  
  p <- ggplot(dt, aes(x=Spot_PA_SpotCellCount))+
    geom_histogram(binwidth = 1)+
    coord_cartesian(xlim=xLimits, ylim=yLimits)+
    ggtitle(paste("\n\n Spot Cell Count in",unique(dt$CellLine), "cells in plate",unique(dt$Barcode)))+
    xlab("Spot Cell Count")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)),
          axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.7)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.3)),
          legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
  suppressWarnings(print(p))
  
}

```

<br>

###Spot Cell Count Boxplots
Boxplots of the spot cell counts show the values stratified by plate and well.The blue line shows the dataset median.   

```{r SCCBoxplots, fig.height=5}

p <- ggplot(l3, aes(x=factor(Barcode), y=Spot_PA_SpotCellCount, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  #coord_cartesian(ylim = c(0,.2))+
  guides(colour=FALSE)+
  xlab("")+ylab("Spot Cell Count")+
  ggtitle("Spot Cell Count by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = median(l3$Spot_PA_SpotCellCount), colour="blue", alpha=.5)
print(p)

```

###DAPI QA
DAPI intensity plots include univariate plots of the total DAPI signal. The blue vertical line shows the auto-gate for classifying 2N and 4N populations.

<br>

```{r rawDAPIPlots, fig.width=3.7,fig.height=4}
l1$Well_Ligand <- paste(l1$Well,l1$Ligand, sep="_")
plotTotalDAPI(l1, barcodes)

```

<br>

Boxplots of the DAPI intensities show the values stratified by plate and well.

```{r DAPIBoxplots, fig.height=5}

p <- ggplot(l3, aes(x=factor(Barcode), y=log2(Nuclei_CP_Intensity_MedianIntensity_Dapi), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  #coord_cartesian(ylim = c(0,.2))+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity DAPI (log2)")+
  ggtitle("Median DAPI Intensity per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = log2(median(l3$Nuclei_CP_Intensity_MedianIntensity_Dapi)), colour="blue", alpha=.5)
print(p)

```


```{r, child='MEP-LINCS_MitoText.Rmd', eval=grepl("SS1",ss)}
```

<br>

```{r rawMitoHistograms, fig.width=3.7,fig.height=4, eval=grepl("SS1",ss)}

for (barcode in barcodes){
  mDT <- l1[l1$Barcode == barcode]
  mDT <- mDT[log2(mDT$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker) > quantile(log2(mDT$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker), probs=.01, na.rm=TRUE) & log2(mDT$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker) < quantile(log2(mDT$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker),probs=.98, na.rm=TRUE)]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker))+
    geom_histogram(binwidth = .001)+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("\n\n","Median MitoTracker Signal,",barcode))+
    ylab("Count")+xlab("Median Intensity MitoTracker")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = 5))
  suppressWarnings(print(p))
}

```


```{r rawMitoBoxplots, fig.height=5, eval=grepl("SS1",ss)}

p <- ggplot(l3, aes(x=factor(Barcode), y=log2(Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity MitoTracker (log2)")+
  ggtitle("Median Intensity MitoTracker per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = log2(median(l3$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker)), colour="blue", alpha=.5)
print(p)

```


```{r, child='MEP-LINCS_EdUText.Rmd', eval=grepl("SS2",ss)}
```

<br>

```{r rawEdUHistograms, fig.width=3.7,fig.height=4, eval=grepl("SS2",ss)}

for (barcode in barcodes){
  mDT <- l1[l1$Barcode == barcode]
  mDT <- mDT[log2(mDT$Nuclei_CP_Intensity_MedianIntensity_Edu) > quantile(log2(mDT$Nuclei_CP_Intensity_MedianIntensity_Edu), probs=.01, na.rm=TRUE) & log2(mDT$Nuclei_CP_Intensity_MedianIntensity_Edu) < quantile(log2(mDT$Nuclei_CP_Intensity_MedianIntensity_Edu),probs=.98, na.rm=TRUE)]
  p <- ggplot(mDT, aes(x=log2(Nuclei_CP_Intensity_MedianIntensity_Edu)))+
    geom_histogram(binwidth = .01)+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("\n\n","Median EdU Signal,",barcode))+
    ylab("Count")+xlab("Median Intensity EdU")+
    theme(strip.text = element_text(size = 5))
  suppressWarnings(print(p))
}

```


```{r rawEdUBoxplots, fig.height=5, eval=grepl("SS2",ss)}

p <- ggplot(l3, aes(x=factor(Barcode), y=log2(Nuclei_CP_Intensity_MedianIntensity_Edu), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity EdU (log2)")+
  ggtitle("Median Intensity EdU per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = log2(median(l3$Nuclei_CP_Intensity_MedianIntensity_Edu)), colour="blue", alpha=.5)
print(p)

```



```{r, child='MEP-LINCS_Krt5Krt19Text.Rmd', eval=grepl("SS3",ss)}
```

<br>

```{r rawKrt5Histograms, fig.width=3.7,fig.height=4, eval=grepl("SS3",ss)}

xMin <- quantile(l1$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1[l1$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2))+
    geom_histogram(binwidth = .01)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("\n\n","Median KRT5 Signal,",barcode))+
    ylab("Count")+xlab("Median Intensity KRT5")+
    theme(strip.text = element_text(size = 5))
  suppressWarnings(print(p))
}

```


```{r rawKrt5Boxplots, fig.height=5, eval=grepl("SS3",ss)}

p <- ggplot(l3, aes(x=factor(Barcode), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity KRT5 (log2)")+
  ggtitle("Median Intensity KRT5 per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = median(l3$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2), colour="blue", alpha=.5)
print(p)

```

<br>

```{r rawKrt19Histograms, fig.width=3.7,fig.height=4, eval=grepl("SS3",ss)}
xMin <- quantile(l1$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1[l1$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2))+
    geom_histogram(binwidth = .01)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("\n\n","Median KRT19 Signal,",barcode))+
    ylab("Count")+xlab("Median Intensity KRT19")+
    theme(strip.text = element_text(size = 5))
  suppressWarnings(print(p))
}

```


```{r rawKrt19Boxplots, fig.height=5, eval=grepl("SS3",ss)}

p <- ggplot(l3, aes(x=factor(Barcode), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity KRT19 (log2)")+
  ggtitle("Median Intensity KRT19 per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = median(l3$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2), colour="blue", alpha=.5)
print(p)

```


<br>

```{r rawlineageRatioHistograms, fig.width=3.7,fig.height=4, eval=grepl("SS3",ss)}
xMin <- quantile(l1$Cytoplasm_PA_Intensity_LineageRatioLog2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1$Cytoplasm_PA_Intensity_LineageRatioLog2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1[l1$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_PA_Intensity_LineageRatioLog2))+
    geom_histogram(binwidth = .01)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("\n\n","Median Lineage Ratio Signal,",barcode))+
    ylab("Count")+xlab("Median Intensity Lineage Ratio")+
    theme(strip.text = element_text(size = 5))
  suppressWarnings(print(p))
}

```


```{r rawLineageRatioBoxplots, fig.height=5, eval=grepl("SS3",ss)}

yMin <- quantile(l1$Cytoplasm_PA_Intensity_LineageRatioLog2,probs=.01, na.rm=TRUE)
yMax <- quantile(l1$Cytoplasm_PA_Intensity_LineageRatioLog2,probs=.99, na.rm=TRUE)
p <- ggplot(l3, aes(x=factor(Barcode), y=Cytoplasm_PA_Intensity_LineageRatioLog2, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim=c(yMin,yMax))+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity Lineage Ratio (log2)")+
  ggtitle("Median Intensity  Lineage Ratio per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p + geom_hline(yintercept = median(l3$Cytoplasm_PA_Intensity_LineageRatioLog2), colour="blue", alpha=.5)
print(p)

```

```{r Filtering, echo=FALSE, eval=TRUE}

#Remove the fiducial and blank data
setkey(l3,ECMp)
l3F <- l3[!grepl("fiducial|Fiducial|blank|PBS",l3$ECMp),]
l3F <- l3F[!grepl("FBS", l3F$Ligand)]

#Remove failed QA wells
l3F <- l3F[!l3F$QA_LowWellQA]
l3F <- l3F[l3F$QAScore>wellQAThresh]
l4F <- createl4(l3F,seNames=c("DNA2N","SpotCellCount","Edu","MitoTracker","KRT","Fibrillarin"))


if (grepl("SS2",ss)){
  #Add Robust Z Score of the Edu Signal
  l4F <- l4F[,Nuclei_PA_Gated_EduPositiveProportionRUV3Loess_RobustZ := RZScore(Nuclei_PA_Gated_EduPositiveProportionRUV3Loess)]
}

if (grepl("SS3",ss)){
  #Add Robust Z Scores of the normalized lineage ratios
  l4F <- l4F[, Cytoplasm_PA_Intensity_LineageRatioRUV3Loess_RobustZ:= RZScore(Cytoplasm_PA_Intensity_LineageRatioRUV3Loess)]
  
}

#Filter for high spot occupancy and good quality DAPI####
l3HF <- l3F[l3F$Spot_PA_SpotCellCount > HFSCCThresh]
l3HF <- l3HF[!l3HF$QA_LowDAPIQuality]
l3HF <- l3HF[!l3HF$QA_LowRegionCellCount]
l4HF <- createl4(l3HF, seNames=c("DNA2N","SpotCellCount","Edu","MitoTracker","KRT","Fibrillarin"))
l4HF <- l4HF[l4HF$Spot_PA_ReplicateCount >= HFRepThresh]

```

```{r, child='MEP-LINCS_RUV3Text.Rmd', eval=unique(l3$NormMethod)=="RUV3"}
```

```{r, child='MEP-LINCS_RUV3LoessResidualsText.Rmd', eval=unique(l3$NormMethod)=="RUV3LoessResiduals"}
```


##Spot Cell Count QA


```{r SCC_responseFull, fig.width=8,  fig.height=10, echo=FALSE, eval=TRUE}

dt <- l4F
dt <- l4F[,list(Barcode,Ligand,Spot_PA_SpotCellCount, Spot_PA_SpotCellCountLog2RUV3, Spot_PA_SpotCellCountLog2RUV3Loess )]
dt <- dt[,Spot_PA_SpotCellCountLog2:= log2(Spot_PA_SpotCellCount)]
dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3","Spot_PA_SpotCellCountLog2RUV3Loess"), variable.name = "Processed",value.name = "SpotCellCount", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2"
dt$Processed[grepl("RUV3$",dt$Processed)] <- "RUV3"
dt$Processed[grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess"


p <- ggplot(dt, aes(x = reorder(Barcode, SpotCellCount, FUN=median), y = SpotCellCount, colour = Ligand))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Spot Cell Count by Barcode (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))


p <- ggplot(dt, aes(x = reorder(Ligand, SpotCellCount, FUN=median), y = SpotCellCount, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Spot Cell Count by Ligand (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))
```


```{r, fig.width=8,  fig.height=3.5, echo=FALSE, eval=TRUE}
dt <- l4F

p <- ggplot(dt, aes(x = reorder(ECMp, Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median), y = Spot_PA_SpotCellCountLog2RUV3Loess))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized Spot Cell Count by ECM Protein (full dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r SCC_response, fig.width=8,  fig.height=6, echo=FALSE, eval=TRUE}
setkey(l4F,"Ligand")
dt <- l4F[!grepl("FBS",l4F$Ligand)]

p <- ggplot(dt, aes(x = reorder(Ligand, Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median), y = Spot_PA_SpotCellCountLog2RUV3Loess, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized Spot Cell Count by Ligand (HF Dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))
```

```{r, fig.width=8,  fig.height=3.5, echo=FALSE, eval=TRUE}
p <- ggplot(dt, aes(x = reorder(ECMp, Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median), y = Spot_PA_SpotCellCountLog2RUV3Loess))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized Spot Cell Count by ECM Protein (HF dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```



```{r MitoTrackerHistogram, eval=grepl("SS1",ss)}

setkey(l4,"Ligand")
dt <- l4[!"FBS"]

p <- ggplot(dt, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess))+geom_histogram(binwidth = .0002)+
  #geom_vline(xintercept = c(-2,2), colour = "blue")+
  ggtitle(paste("\n\n","MEP Normalized, MitoTracker Intensity Distribution"))+
  ylab("Count")+xlab("Normalized, MitoTracker Intensity")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```

```{r MitoTrackerByLigand, eval=grepl("SS1",ss)}

p <- ggplot(dt, aes(x = reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess, FUN=median), y = Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, MitoTracker Intensity by Ligand"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r MitoTrackerByECMp, eval=grepl("SS1",ss)}

p <- ggplot(dt, aes(x = reorder(ECMp, Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess, FUN=median), y = Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, MitoTracker Intensity by ECM Protein"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```


```{r, child='MEP-LINCS_ProliferationText.Rmd', eval=grepl("SS2",ss)}
```


```{r ProliferationHistogramFull, eval=grepl("SS2",ss)}

dt <- l4F

p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EduPositiveLogitRUV3Loess))+geom_histogram(binwidth = .02)+
  ggtitle(paste("\n\n","MEP Normalized, EdU+ Proportion Distribution (full dataset)"))+
  ylab("Count")+xlab("Normalized,  EdU+ Proportion")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```

```{r ProliferationByLigandFull, eval=grepl("SS2",ss)}

p <- ggplot(dt, aes(x = reorder(Ligand, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess, FUN=median), y = Nuclei_PA_Gated_EduPositiveLogitRUV3Loess, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, EdU+ Proportion by Ligand (full dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r ProliferationByECMpFull,eval=grepl("SS2",ss)}

p <- ggplot(dt, aes(x = reorder(ECMp, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess, FUN=median), y = Nuclei_PA_Gated_EduPositiveLogitRUV3Loess))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, EdU+ Proportion by ECM Protein (full dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```


```{r ProliferationHistogram, eval=grepl("SS2",ss)}

setkey(l4HF,"Ligand")
dt <- l4HF[!grepl("FBS",l4HF$Ligand)]

p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EduPositiveLogitRUV3Loess))+geom_histogram(binwidth = .02)+
  ggtitle(paste("\n\n","MEP Normalized, EdU+ Proportion Distribution (HF dataset)"))+
  ylab("Count")+xlab("Normalized,  EdU+ Proportion")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```

```{r ProliferationByLigand, eval=grepl("SS2",ss)}

p <- ggplot(dt, aes(x = reorder(Ligand, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess, FUN=median), y = Nuclei_PA_Gated_EduPositiveLogitRUV3Loess, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, EdU+ Proportion by Ligand (HF dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r ProliferationByECMp,eval=grepl("SS2",ss)}

p <- ggplot(dt, aes(x = reorder(ECMp, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess, FUN=median), y = Nuclei_PA_Gated_EduPositiveLogitRUV3Loess))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, EdU+ Proportion by ECM Protein (HF dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```


```{r, child='MEP-LINCS_LineageText.Rmd',eval=grepl("SS3",ss)}
```

```{r lineageRatioHistogram,eval=grepl("SS3",ss)}

p <- ggplot(dt, aes(x=Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess))+geom_histogram(binwidth = .02)+
  #geom_vline(xintercept = c(-2,2), colour = "blue")+
  ggtitle(paste("\n\n","MEP Normalized, Logged Lineage Ratio Distribution"))+
  ylab("Count")+xlab("Normalized, Logged Lineage Ratio")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```

```{r LineageRatioByLigand,eval=grepl("SS3",ss)}
p <- ggplot(dt, aes(x = reorder(Ligand, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess, FUN=median), y = Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, Logged Lineage Ratio by Ligand"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r lineageRatioByECMp,eval=grepl("SS3",ss)}

p <- ggplot(dt, aes(x = reorder(ECMp, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess, FUN=median), y = Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Normalized, Logged LineageRatio by ECM Protein"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

##DNA Content Analysis

All cells are stained with DAPI and classified as DNA 2n or 4n. The proportion of 2n and 4n cells at each spot is calculated and will always sum to 1. The proportions are plotted below and detailed in the datatables.


```{r DNAHistogramFull}

dt <- l3

p <- ggplot(dt, aes(x=Nuclei_PA_Cycle_DNA2NProportionLogit))+geom_histogram(binwidth = .1, alpha=.8)+
  ggtitle(paste("\n\n","Spot DNA 2N Proportion Histogam"))+
  ylab("Count")+xlab("DNA 2N Proportion")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```


```{r, eval=TRUE}


###PCA Unbiased Analysis  
# The unbiased analysis is extended by using Principal Component Analysis (PCA) to reduce the dimensions of the feature vector.
# 
# The unbiased PCA analysis method is:
# Use PCA to transform the entire normalized feature set to a much smaller number of principal components (PCFV).  
# Perform unsupervised hierarchical clustering of the first `r nrPCs` PCFVs.  
# 
# 
# The heatmap is arranged by unsupervised clustering of the rows and columns and colored by the normalized principal component values. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap. 
#l4F <- l4F[!grepl("NID1",l4F$ECMp)]

PCFVNames <- grep("Norm|Loess",colnames(l4F),value=TRUE)
PCFVNames <- grep("Euler|MaximumRadius|_SE|_RobustZ",PCFVNames,invert = TRUE, value = TRUE)

#Get the PCFVs
l4PCAModel <- prcomp(as.formula(paste(" ~ ", paste(PCFVNames, collapse = "+"))), data = l4F, scale= TRUE)

#Extract the first PCs of each MEP into a matrix
l4pcvDT <- data.table(l4PCAModel$x[,1:nrPCs],Barcode =l4F$Barcode, MEP = l4F$MEP)

#Convert to dataframe for use in D3heatmap
l4pcvDT <- data.frame(l4pcvDT)
rownames(l4pcvDT) <- l4pcvDT$MEP
l4pcvDT <- l4pcvDT[,!(names(l4pcvDT) %in% c("MEP", "Barcode"))]

```

```{r PCAHeatmap, fig.height=8, fig.width=7, eval=FALSE}
#Plot the heat map of the entire dataset
d3heatmap(l4pcvDT, scale="column", colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE)
```

```{r, fig.height=3, fig.width=4, eval=TRUE}

var <- l4PCAModel$sd[1:nrPCs]^2
var.percent <- var/sum(var) * 100
barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main  = paste("PCA Scree Plot for",cellLine,ss))

p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC2, col = l4F$Barcode)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Barcode")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC3, col = l4F$Barcode)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Barcode")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC2, y = PC3, col = l4F$Barcode)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Barcode")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC2, col = l4F$Well)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Well")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC3, col = l4F$Well)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Well")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC2, y = PC3, col = l4F$Well)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Well")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

if(grepl("SS1",ss)){
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC2, col = l4F$Cytoplasm_CP_Intensity_IntegratedIntensity_MitoTrackerRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Total MitoTracker")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC2, col = l4F$Cells_CP_AreaShape_PerimeterRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Perimeter ProportionStatus")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
} else if (ss=="SS2"){
  
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC2, col = l4F$Nuclei_CP_Intensity_MedianIntensity_EduRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Median Intensity EdU")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  
} else if (ss=="SS3"){
  
  
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC1, y = PC2, col = l4F$Cytoplasm_PA_Intensity_LineageRatioRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC3, y = PC4, col = l4F$Cytoplasm_PA_Intensity_LineageRatioRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC5, y = PC6, col = l4F$Cytoplasm_PA_Intensity_LineageRatioRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  p <- ggplot(data.frame(l4PCAModel$x), aes(x = PC7, y = PC8, col = l4F$Cytoplasm_PA_Intensity_LineageRatioRUV3Loess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
}

datatable(format(l4PCAModel$rotation[,1:nrPCs], digits=1, scientific = FALSE, nsmall=0), options = list(pageLength = 5))
#Extract the selectedPCs of each MEP into a matrix

```



```{r, eval=FALSE}


###PCA Unbiased Analysis  on raw l3 data


PCFVNames <- grep("Norm|Loess",colnames(l3F),value=TRUE)
PCFVNames <- grep("Euler|MaximumRadius|_SE|_RobustZ",PCFVNames,invert = TRUE, value = TRUE)
PCFVNames <- gsub("RUV3Loess","", PCFVNames)
tmp <- grep()

#Get the PCFVs
l4PCAModel <- prcomp(as.formula(paste(" ~ ", paste(PCFVNames, collapse = "+"))), data = l4F, scale= TRUE)

#Extract the first PCs of each MEP into a matrix
l4pcvDT <- data.table(l4PCAModel$x[,1:nrPCs],Barcode =l4F$Barcode, MEP = l4F$MEP)

#Convert to dataframe for use in D3heatmap
l4pcvDT <- data.frame(l4pcvDT)
rownames(l4pcvDT) <- l4pcvDT$MEP
l4pcvDT <- l4pcvDT[,!(names(l4pcvDT) %in% c("MEP", "Barcode"))]

```

\newpage

#Supplemental Material


##MEMA Layout
All MEMAs in the experiment are in separate wells and have the same design of 48 ECM proteins spotted in 35 rows and 20 columns. The proteins are randomly assigned to spots in the top 30 rows. Rows 31-35 are replicates of rows 1-5. The upper left and bottom right corners of each MEMA are image fiducials in the 488nm channel and there are four blank spots for checking orientation in all channels.   

```{r Content Layout,echo=FALSE, message=FALSE, warnings=FALSE, fig.width=7}

#Select the A row wells and delete the blanks
setkey(l1,Well)
DT <- unique(l1[grep("A",unique(l1$Well),value=TRUE),list(ArrayRow,ArrayColumn,ECMp)])
setkey(DT,ECMp)
DT <- DT[!grepl("blank|PBS",DT$ECMp),]

p <- ggplot(DT,aes(x = ArrayColumn, y = ArrayRow, fill=ECMp))+
  geom_point(shape=21, size = 2.2)+
  guides(fill=guide_legend(ncol = 2))+
  theme(legend.text = element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)),plot.title=element_text(size = rel(.8)))+
  scale_y_reverse()+
  xlab("")+ylab("")+
  ggtitle(" \n\nLINCS MEMA A Row Layout")
print(p)

DT <- DT[!grepl("Fiducial|fiducial",DT$ECMp),]

```

##Replicate Count
The average replicate count is `r  sprintf("%3.1f",mean(table(DT$ECMp)))` and the range of the replicate counts is `r range(table(DT$ECMp))`.  

```{r Layout Replicate Count,echo=FALSE, message=FALSE, warnings=FALSE, fig.width=6.5, fig.height=3}

p <- ggplot(DT, aes(x=ECMp))+
  geom_bar(width=.8)+geom_hline(yintercept = mean(table(DT$ECMp)), colour="blue")+
  ggtitle(" \n\nCount of Replicate ECM Proteins In Each MEMA")+
  xlab("Printed ECM Protein")+ylab("Number of spots")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(.8)),axis.title.y = element_text(size=rel(.8)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))

print(p)

```

##Quality Analysis
The variance of the signal in MEMA data comes from biological and technical factors. The technical factors create regions of low cell counts per spot and uneven staining across the array. The goal of the QA pipeline is to quantify the technical factors to identify wells or plates that need to be removed from downstream processing and/or be replaced by wells from a new experiment.

The hypothesis for the MEMA QA process is that the biological signal comes from individual spots while the technical variations come from regions of low signal. A bivariate loess model can be used to quantify the number of spots in low signal regions, leading to a MEMA QA score. 
\newpage

###Loess Model Explanation
The loess model of a MEMA is the mean value of a weighted version of each spot's region or neighborhood. In a 700 spot array, a loess span value of 0.1 sets the size of the neighborhood to be the nearest 70 points (within approximately 5 spots in all directions). The weights are a tricubic function of the euclidean distance between the spot being modeled and the neighborhood spots. These weights vary from 1 to 0 as distances increase from the nearest to the farthest neighbor. In other words, each spot in the model takes on the mean value of its 70 nearest neighbors with the closest neighbors having the largest impact. Therefore, the loess model is dominated by the technical regional factors as opposed to individual biological responses.

A MEMA's QA score is derived from the loess model of the control-well-normalized values by calculating the proportion of spots in low signal regions(LSR). A threshold for classifying spots as LSR is based on the median of each plate's control well. To have higher scores reflect increasing quality, the MEMA QA score is defined as the proportion of non-LSR spots to total spots. This value will be 1 for MEMAs with no low signal regions and approach 0 as the number of LSR spots increases.

Below are plots showing data from well B01 from plate LI8X00110 from LINCS staining set 2. The LSR spots are those to the left of the blue vertical line at the threshold value of `r lthresh ` in the histogram. 


```{r Loess_Model_explanation , echo=FALSE, fig.width=2.5,fig.height=4}
setkey(l3,Barcode,Well)
DT <-l3[.(barcodes[1],"A01")]
#Remove the fiducial entries
setkey(DT,ECMp)
DT <- DT[!"fiducial"]
DT <- DT[!"blank"]

p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=Spot_PA_SpotCellCount))+
  geom_point(size=1.8)+
  scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
  scale_colour_gradient(low = "white", high = "red")+
  guides(colour = guide_legend("Spot Cell\nCount", keywidth = .5, keyheight = .5))+
  ggtitle(paste("\n\n","Spot Cell Count for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
  xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=Spot_PA_LoessSCC))+
  geom_point(size=1.8)+
  scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
  scale_colour_gradient(low = "white", high = "red")+
  guides(colour = guide_legend("Normalized \nSpot Cell \nCount", keywidth = .5, keyheight = .5))+
  ggtitle(paste("\n\n","Loess Model of Spot Cell Count \nfor",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
  xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

DT <- DT[,QAScore := calcQAScore(.SD,threshold=lthresh,value="Spot_PA_LoessSCC"),by="Well"]
wellScores <- unique(DT[,list(Well,QAScore=sprintf("%.2f",QAScore))])

p <- ggplot(DT, aes(x=Spot_PA_LoessSCC))+
  geom_histogram(binwidth=.02)+
  geom_vline(xintercept=lthresh, colour="blue")+
  geom_text(data=wellScores, aes(label=paste0("QA\n",QAScore)), x = .9, y = 30, size = rel(5), colour="red")+
  ggtitle(paste("\n\n","Loess Model of Spot Cell Count \nfor",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Spot Cell Count")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))


```


##Stain Pseudoimages
The pseudoimages of each well's raw signals are shown in the plots below. Wells that could not be sucessfully imaged due to focus issues are missing from the pseudoimages.

```{r Pseudoimages_all_stains, echo=FALSE, fig.width=3.7,fig.height=4, eval=TRUE}

for (barcode in barcodes){
  DT <-l3[l3$Barcode==barcode,]
  #Remove the fiducial entries
  setkey(DT,ECMp)
  DT <- DT[!"fiducial"]
  DT <- DT[!"blank"]
  
  p <- create8WellPseudoImage(DT, pr = "Nuclei_CP_Intensity_MedianIntensity_Dapi", prDisplay = "Median DAPI")
  suppressWarnings(print(p))
  
  
  if (grepl("SS1",ss))  {
    p <- create8WellPseudoImage(DT, pr = "Cytoplasm_CP_Intensity_MedianIntensity_Actin", prDisplay = unique(DT$Endpoint488))
    suppressWarnings(print(p))
    
    p <- create8WellPseudoImage(DT, pr = "Cytoplasm_CP_Intensity_MedianIntensity_CellMask",prDisplay = unique(DT$Endpoint555))
    suppressWarnings(print(p))
    
    p <- create8WellPseudoImage(DT, pr = "Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker",prDisplay = unique(DT$Endpoint647))
    suppressWarnings(print(p))
  } else if (ss=="SS2"){
    
    p <- create8WellPseudoImage(DT, pr = "Nuclei_CP_Intensity_MedianIntensity_H3", prDisplay = unique(DT$Endpoint488))
    suppressWarnings(print(p))
    
  } else if (grepl("SS2",ss)){   
    p <- create8WellPseudoImage(DT, pr = "Nuclei_CP_Intensity_MedianIntensity_Fibrillarin",prDisplay = unique(DT$Endpoint555))
    suppressWarnings(print(p))
    
    p <- create8WellPseudoImage(DT, pr = "Nuclei_CP_Intensity_MedianIntensity_Edu",prDisplay = unique(DT$Endpoint647))
    suppressWarnings(print(p))
    
  } else if (grepl("SS3",ss)){
    
    p <- create8WellPseudoImage(DT, pr = "Cytoplasm_CP_Intensity_MedianIntensity_KRT5", prDisplay = unique(DT$Endpoint488))
    suppressWarnings(print(p))
    
    p <- create8WellPseudoImage(DT, pr = "Cytoplasm_CP_Intensity_MedianIntensity_KRT19",prDisplay = unique(DT$Endpoint555))
    suppressWarnings(print(p))
    
    p <- create8WellPseudoImage(DT, pr = "Cytoplasm_CP_Intensity_MedianIntensity_CellMask",prDisplay = unique(DT$Endpoint647))
    suppressWarnings(print(p))
    
  }
}

```


```{r, eval=("SS2"==ss)}
p <- ggplot(l3, aes(x=factor(Barcode), y=Nuclei_CP_Intensity_MedianIntensity_H3, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,.4))+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity H3")+
  ggtitle("Median H3 Intensity per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)    

```

```{r, eval=grepl("SS2",ss)}
p <- ggplot(l3, aes(x=factor(Barcode), y=Nuclei_CP_Intensity_IntegratedIntensity_Fibrillarin, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,20))+
  guides(colour=FALSE)+
  xlab("")+ylab("Total Intensity Fibrillarin")+
  ggtitle("Total Fibrillarin Intensity per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)    

p <- ggplot(l3, aes(x=factor(Barcode), y=Nuclei_CP_Intensity_MedianIntensity_Edu, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  #coord_cartesian(ylim = c(0,.04))+
  guides(colour=FALSE)+
  xlab("")+ylab("Median Intensity EdU")+
  ggtitle("Median EdU Intensity per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)


```


```{r, , fig.height=10, eval=grepl("SS2",ss)}

p <- ggplot(l1, aes(x=log2(Nuclei_CP_Intensity_MedianIntensity_Edu)))+
  geom_histogram(binwidth=.05)+
  xlab("Mean Intensity EdU (logged)")+
  coord_cartesian(xlim = c(-10,-5), ylim=c(0,2000))+
  ggtitle("EdU Distribution (logged)")+
  facet_grid(Barcode~Well,labeller = labeller(Barcode = label_value, Well = label_value))+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)


p <- ggplot(l3, aes(y=Nuclei_PA_Gated_EduPositiveProportion, x=Well, colour=Well))+
  geom_boxplot()+
  xlab("Well")+
  coord_cartesian( ylim=c(0,1))+
  ggtitle("EdU+ Proportion by Well")+
  facet_wrap(~Barcode)+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)


```

```{r Cell_cycle_plots,echo=FALSE, fig.width=8, fig.height=5, eval=grepl("SS2",ss)}

for (barcode in barcodes){
  mDT <- l1[l1$Barcode == barcode] 
  mDT <- mDT[mDT$Nuclei_CP_Intensity_IntegratedIntensity_Dapi > quantile(mDT$Nuclei_CP_Intensity_IntegratedIntensity_Dapi, probs=.01, na.rm=TRUE) & mDT$Nuclei_CP_Intensity_IntegratedIntensity_Dapi < quantile(mDT$Nuclei_CP_Intensity_IntegratedIntensity_Dapi,probs=.98, na.rm=TRUE)]
  
  p <- ggplot(mDT, aes(x=Nuclei_CP_Intensity_IntegratedIntensity_Dapi, y = log2(Nuclei_CP_Intensity_MedianIntensity_Edu), colour = Nuclei_PA_Gated_EduPositive))+geom_point(size = rel(.2), alpha = .6)+
    geom_rug(col=rgb(.5,0,0,alpha=.01))+
    coord_cartesian(xlim=c(0,160),ylim=c(-9,-4))+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+ggtitle(paste("\n\n","Edu vs. Total DAPI Signal,",barcode))+ylab("Edu (log2)")+xlab("Total Intensity DAPI")+
    guides(colour=FALSE)+
    theme(strip.text = element_text(size = 5),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  
  suppressWarnings(print(p))
}


```



```{r spectral, eval=FALSE}

DT <- l1[grepl("COL1_EGF",l1$MEP)]
DT <- DT[DT$Spot==391,]

p <- ggplot(DT, aes(x=log2(MeanIntensityDAPI+1), y=log2(MeanIntensityAlexa488Cyto+1)))+
  geom_point(size=.1)+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
  ggtitle("KRT5 vs. Mean DAPI in NegCtrl")+
  facet_wrap(~Well,scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

p <- ggplot(DT, aes(x=log2(Cytoplasm_CP_Intensity_MedianIntensity_KRT19+1), y=log2(Cytoplasm_CP_Intensity_MedianIntensity_KRT5+1)))+
  geom_point(size=.1)+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
  ggtitle("KRT19 vs. KRT5")+
  coord_cartesian(xlim=c(0,.25),ylim=c(0,0.05))+
  facet_wrap(~Well,scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

p <- ggplot(DT, aes(x=log2(MeanIntensityAlexa555Cyto+1), y=log2(MeanIntensityAlexa647+1)))+
  geom_point(size=.1)+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
  ggtitle("EdU vs. KRT19 in NegCtrl")+
  facet_wrap(~Well,scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

```

