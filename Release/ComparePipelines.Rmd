
```{r "setup", include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)
knitr::opts_knit$set(root.dir = "/graylab/share/dane/MEP-LINCS/MEP_LINCS/Release")

#Author: Mark Dane, copyright 2017

library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

path <- "/lincs/share/lincs_user/lincs96well"
datasetName <- "LE96_3_ECM_MEMAs_2"

```


```{r readLevel3and4Data, echo=FALSE}

l3CB <- fread(paste0(path,"/",datasetName,"/Annotated/",datasetName,"_Level3.tsv"),verbose = FALSE, showProgress = FALSE)
l4CB <- fread(paste0(path,"/",datasetName,"/Annotated/",datasetName,"_Level4.tsv"),verbose = FALSE, showProgress = FALSE)

l3IC <- rbind(
  fread(paste0(path,"/LI9V01610/Analysis/MCF10A_SSF_v18x8_Level3.txt"),verbose = FALSE, showProgress = FALSE),
  fread(paste0(path,"/LI9V01611/Analysis/MCF10A_SSF_v18x8_Level3.txt"),verbose = FALSE, showProgress = FALSE),  fread(paste0(path,"/LI9V01612/Analysis/MCF10A_SSF_v18x8_Level3.txt"),verbose = FALSE, showProgress = FALSE))

l4IC <- rbind(
  fread(paste0(path,"/LI9V01610/Analysis/MCF10A_SSF_v18x8_Level4.txt"),verbose = FALSE, showProgress = FALSE),
  fread(paste0(path,"/LI9V01611/Analysis/MCF10A_SSF_v18x8_Level4.txt"),verbose = FALSE, showProgress = FALSE),  fread(paste0(path,"/LI9V01612/Analysis/MCF10A_SSF_v18x8_Level4.txt"),verbose = FALSE, showProgress = FALSE))
annotations <- fread(paste0(path,"/",datasetName,"/Annotated/",datasetName,"_Level3Annotations.tsv"),header = FALSE)

CellLine = annotations$V2[annotations$V1=="CellLine"]
Preprocess = annotations$V2[annotations$V1=="Preprocess"]
DataType = annotations$V2[annotations$V1=="DataType"]
Consortia = annotations$V2[annotations$V1=="Consortia"]
Drug = annotations$V2[annotations$V1=="Drug"]
Segmentation = annotations$V2[annotations$V1=="Segmentation"]
StainingSet = annotations$V2[annotations$V1=="StainingSet"]
Level = annotations$V2[annotations$V1=="Level"]



#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.7

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

# https://meplincs.ohsu.edu/webclient/


```
###Spot Cell Count Comparisons
These figures compare the raw spt cell counts for each spot in the devel combined CP&IC pipeline vs the separate INCell pipeline.  

```{r SCCScatterplots}
l3CB <- setnames(l3CB,"Spot_PA_SpotCellCount","Spot_PA_SpotCellCount_CB")
l3CB <- setnames(l3CB,"Nuclei_PA_Gated_EdUPositiveProportion","Nuclei_PA_Gated_EdUPositiveProportion_CB")

dt <-merge(l3CB[,.(Barcode,Well,Spot,Spot_PA_SpotCellCount_CB)],
           l3IC[,.(Barcode,Well,Spot,Spot_PA_SpotCellCount)],by=c("Barcode","Well","Spot"))
p <- ggplot(dt, aes(x=Spot_PA_SpotCellCount, y=Spot_PA_SpotCellCount_CB))+
  geom_point()+
  facet_wrap((~Barcode))+
  xlab("INCell Pipeline Spot Cell Count")+ylab("CP & INCell Pipeline Spot Cell Count")+
  ggtitle("Comparing Spot Cell Count from the Dedicated and Combined Pipelines")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))

print(p)

```


<br>
###Proliferation Cell Count Comparisons
These figures compare the EdU-based proliferation for each spot in the devel combined CP&IC pipeline vs the separate INCell pipeline.  

```{r ProliferationScatterplots}

dt <-merge(l3CB[,.(Barcode,Well,Spot,Nuclei_PA_Gated_EdUPositiveProportion_CB,Spot_PA_SpotCellCount_CB)],
           l3IC[,.(Barcode,Well,Spot,Nuclei_PA_Gated_EdUPositiveProportion,Spot_PA_SpotCellCount)],
           by=c("Barcode","Well","Spot"))
p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EdUPositiveProportion, y=Nuclei_PA_Gated_EdUPositiveProportion_CB, colour=Spot_PA_SpotCellCount))+
  geom_point(alpha=.5)+
  facet_wrap((~Barcode))+
  xlab("INCell Pipeline Proliferation")+ylab("Combined Pipeline Proliferation")+
  ggtitle("Comparing Proliferation from the Dedicated and Combined Pipelines")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))

print(p)

```

###MEP-Spot Cell Count Comparisons
These figures compare the raw MEP spot cell counts for each spot in the devel combined CP&IC pipeline vs the separate INCell pipeline.  

```{r MEPSCCScatterplots}
l4CB <- setnames(l4CB,"Spot_PA_SpotCellCount","Spot_PA_SpotCellCount_CB")
l4CB <- setnames(l4CB,"Nuclei_PA_Gated_EdUPositiveProportion","Nuclei_PA_Gated_EdUPositiveProportion_CB")

dt <-merge(l4CB[,.(MEP,Spot_PA_SpotCellCount_CB)],
           l4IC[,.(Barcode,MEP,Spot_PA_SpotCellCount)],by=c("MEP"))
p <- ggplot(dt, aes(x=Spot_PA_SpotCellCount, y=Spot_PA_SpotCellCount_CB))+
  geom_point()+
  xlab("INCell Pipeline Spot Cell Count")+ylab("CP & INCell Pipeline Spot Cell Count")+
  ggtitle("Comparing Spot Cell Count from the Dedicated and Combined Pipelines")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))

ggplotly(p)

```


<br>
###MEP-Level Proliferation Cell Count Comparisons
These figures compare the MEP-levelEdU-based proliferation for each spot in the devel combined CP&IC pipeline vs the separate INCell pipeline.  

```{r MEPProliferationScatterplots}

dt <-merge(l3CB[,.(Barcode,Well,Spot,Nuclei_PA_Gated_EdUPositiveProportion_CB,Spot_PA_SpotCellCount_CB)],
           l3IC[,.(Barcode,Well,Spot,Nuclei_PA_Gated_EdUPositiveProportion,Spot_PA_SpotCellCount)],
           by=c("Barcode","Well","Spot"))
p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EdUPositiveProportion, y=Nuclei_PA_Gated_EdUPositiveProportion_CB, colour=Spot_PA_SpotCellCount))+
  geom_point(alpha=.5)+
  facet_wrap((~Barcode))+
  xlab("INCell Pipeline Proliferation")+ylab("Combined Pipeline Proliferation")+
  ggtitle("Comparing Proliferation from the Dedicated and Combined Pipelines")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))

print(p)

```
