
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8X00","",dt$Barcode), sep="_")
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle, xlim=NULL, ylim=NULL, colorByCtrls=TRUE, highlightName=NULL){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  
  if(is.null(highlightName)){
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
  } else {
    #Dim out all MEPs except the selected
    dimColour<-"cornflowerblue"
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
  }
  
  if(colorByCtrls){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
  }
  
  if(!is.null(highlightName)){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
  }
  
  print(p12)
  print(p23)
  print(p13)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}

shortenHA <- function(x){
  x$ECMp <- gsub("hyaluronicacid","HA",x$ECMp)
  x$ECMp <- gsub("lessthan","<",x$ECMp)
  x$ECMp <- gsub("greaterthan",">",x$ECMp)
  x$MEP <- paste(x$ECMp,x$Ligand,sep = "_")
  return(x)
}

addOmeroIDs <- function(dt){
  if(any(grepl("^ImageID$",colnames(dt)))){
    dt <- dt[,OmeroDetailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroThumbnailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroImageURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',ImageID,'/"',' target="_blank">Omero</a>')]
  }
  return(dt)
}

addLigandPlate <- function(dt){
  barcodeFBS <- unique(dt[grepl("FBS",dt$Ligand),list(Barcode,Ligand)])
  barcodeFBS$LigandPlate <- sub(".*_","",barcodeFBS$Ligand)
  barcodeFBS <- barcodeFBS[,Ligand :=NULL]
  barcodeLigandPlate <- merge(dt,barcodeFBS,by="Barcode")
}

create8WellPseudoImage <- function(DT, pr, prDisplay,highThresh = .99, lowThresh = .01, highThreshValue=NULL, lowThreshValue=NULL){
  #find high and low values
  if(is.null(highThreshValue)) highThreshValue<-quantile(DT[[pr]],probs = highThresh,na.rm=TRUE)
  if(is.null(lowThreshValue)) lowThreshValue<-quantile(DT[[pr]],probs = lowThresh,na.rm=TRUE)
  p <- ggplot(DT, aes_string(x="ArrayColumn", y="ArrayRow",colour=pr))+
    geom_point(size=rel(.25))+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red", limits=c(lowThreshValue, highThreshValue), oob=squish)+
    guides(colour = guide_legend(prDisplay, keywidth = .5, keyheight = .5))+
    ggtitle(paste("\n\n",prDisplay,"for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),
          axis.title.x = element_text(size=rel(.5)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.4)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
}
medianSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMedians <- dtKeep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMedians)
}

meanSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMeans)
}

meanSummarizel3 <- function(dt){
  #median summarize the Spot replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|PrintSpot|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well,PrintSpot"]
  return(dtMeans)
}

numericMean <- function(x){
  as.numeric(mean(x, na.rm=TRUE))
}
```



```{r setup}

library("ggplot2")
library(scales)
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)
library(RUVnormalize)
library(ruv)
library(Rtsne)
library(XLConnect)

#Use x structure for future fleixbility
x <- data.frame(cellLine="MCF10A",
                drug= "none",
                analysisVersion="av1.6",
                rawDataVersion="v2",
                stringsAsFactors = FALSE)
#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol <- selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
PCAOnly <- TRUE
cellLine <- x[["cellLine"]]

l3n <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l4 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

#Match the FBS wells up as replicates and change to common names
tmp <- l4[grepl("FBS",l4$Ligand),]
suffixes <- sort(sub("FBS","",unique(tmp$Ligand)))
replacements <- rep(paste0("_P",1:8), times=3)
for(i in 1:24){
  l4$MEP[grepl(suffixes[i],l4$MEP)] <- sub(suffixes[i],replacements[i],l4$MEP[grepl(suffixes[i],l4$MEP)])
  l4$Ligand[grepl(suffixes[i],l4$Ligand)] <- sub(suffixes[i],replacements[i],l4$Ligand[grepl(suffixes[i],l4$Ligand)])
}

l3SS1 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS1_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS2 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS2_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS3 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS3_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS3 <- l3SS3[!grepl("CSF2",l3SS3$Ligand),]

l4SS1 <- addLigandPlate(addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS1_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE))))


l4SS2 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS2_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

l4SS2LP <- addLigandPlate(addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS2_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE))))

l4SS3 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS3_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

l4SS3LP <- addLigandPlate(addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS3_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE))))


l4SS3 <- l4SS3[!grepl("CSF2",l4SS3$Ligand),]
l4SS3LP <- l4SS3LP[!grepl("CSF2",l4SS3LP$Ligand),]



#Create a data.table that holds every spot in the cell line
#that can be used to index to the images
l3SS123 <- rbindlist(list(l3SS1[!grepl("FBS",l3SS1$MEP),],l3SS2[!grepl("FBS",l3SS2$MEP),],l3SS3[!grepl("FBS",l3SS3$MEP),]),use.names=TRUE,fill=TRUE)

# #Merge the spot level data
# l3nMean <- meanSummarizel3(l3n[!grepl("FBS",l3n$MEP),])
# l3SS1SS2 <- merge(l3SS1[!grepl("FBS",l3SS1$MEP),grep("MEP|PrintSpot|MitoTracker",colnames(l3SS1), value=TRUE), with=FALSE],
#                   l3SS2[!grepl("FBS",l3SS2$MEP),grep("MEP|PrintSpot|EdU|Fibrillarin",colnames(l3SS2), value=TRUE), with=FALSE],by = c("MEP","PrintSpot"))
# l3Merge <- merge(l3SS1SS2,
#                  l3SS3[!grepl("FBS",l3SS3$MEP),grep("MEP|PrintSpot|KRT",colnames(l3SS3), value=TRUE), with=FALSE],by = c("MEP","PrintSpot"))
# l3Merge <- merge(l3Merge,l3nMean,by = c("MEP","PrintSpot"))

l4nMean <- meanSummarizel4(l4)

blp <- unique(l4SS1[,list(LigandPlate, Ligand)])
l4nMean <- merge(l4nMean,blp,by="Ligand")


l4SS1SS2 <- merge(l4SS1[!grepl("FBS",l4SS1$MEP),grep("MEP|MitoTracker|LigandPlate",colnames(l4SS1), value=TRUE), with=FALSE],
                  l4SS2[!grepl("FBS",l4SS2$MEP),grep("MEP|EdU|Fibrillarin",colnames(l4SS2), value=TRUE), with=FALSE],by = "MEP")

l4SS1SS2FBS <- merge(l4SS1[,grep("MEP|MitoTracker|LigandPlate",colnames(l4SS1), value=TRUE), with=FALSE],
                     l4SS2[,grep("MEP|EdU|Fibrillarin",colnames(l4SS2), value=TRUE), with=FALSE],by = "MEP")

l4Merge <- merge(l4SS1SS2,
                 l4SS3[!grepl("FBS",l4SS3$MEP),grep("MEP|KRT",colnames(l4SS3), value=TRUE), with=FALSE],by = "MEP")

l4MergeFBS <- merge(l4SS1SS2FBS,
                    l4SS3[,grep("MEP|KRT",colnames(l4SS3), value=TRUE), with=FALSE],by = "MEP")

l4Merge <- merge(l4Merge, l4nMean[!grepl("FBS",l4nMean$MEP),], by="MEP")

l4MergeFBS <- merge(l4MergeFBS, l4nMean, by="MEP")

#Read in ligand metadata
ligandMetadata <- readWorksheetFromFile("../Ligand-cellsource&effects_v1.xlsx", sheet="Sheet1",startRow=1, header=TRUE)
ligandMetadataDT <- convertColumnNames(data.table(ligandMetadata))
ligandMetadataDT$Ligand <- sub("_[[:alnum:]]*$","",ligandMetadataDT$protein)
ligandMetadataDT$Growth <- grepl("Growth",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Migration <- grepl("Migration",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Invasion <- grepl("Invasion",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TherapeuticResistance <- grepl("therapeutic resistance",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Metastasis <- grepl("metastasis",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Survival <- grepl("survival",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Angiogenesis <- grepl("angiogenesis",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Proliferation <- grepl("Proliferation",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Immunomodulatory <- grepl("Immunomodulatory",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TumorProgression <- grepl("tumor progression",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TherapeuticResponse <- grepl("therapeutic response",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$StemCellMaintenance <- grepl("stem cell maintenance",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TumorInitiation <- grepl("tumor initiation",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$VascularHomeostasis <- grepl("vascular homeostasis",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Inflammation <- grepl("inflammation",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$ImmuneEffects <- grepl("immune effects",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Progression <- grepl("progression",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Adhesion <- grepl("adhesion",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TumorEffects <- grepl("tumor effects",ligandMetadataDT$Effect, ignore.case = TRUE)

l4Merge <- merge(l4Merge, ligandMetadataDT, by="Ligand")
l4Merge <- unique(l4Merge,by = "MEP")

l4MergeFBS <- merge(l4MergeFBS, ligandMetadataDT, by="Ligand")
l4MergeFBS <- unique(l4MergeFBS,by = "MEP")
```

<br>

#MEP-LINCS MCF10A MEP Nominations 
####date: `r Sys.Date()`

##Introduction
This analysis is of the MEP-LINCS MCF10A MEMA experiments performed in eight well plates. The data is collected at the cell level from images captured on an automated Nikon microscope. The cell level data is summarized for each MEMA spot, RUV3 and loess normalized, then replicate spots are summarized to the MEP level.  

The MEP-level dataset is stored and manipulated as a matrix where each of the `r dim(l4Merge)[1]` rows are a unique MEP and each of the `r dim(l4Merge)[2]` columns are signals or metadata. Some signals are based on the DAPI staining that is present in all wells. This creates three replicate ligand wells which each have ~fifteen replicates of spotted ECM proteins. The rest of the signals are based on unique stains and the ~fifteen replicate spots are all in the same well. It's important to note that the MEP level data comes from three different experiments run over three week period.

The Spot-level dataset is a matrix where each of the `r dim(l3SS123)[1]` rows is a spot and each of the `r dim(l3SS123)[2]` columns are signals or metadata. The spot level data is a sparse matrix where the each row has values from one staining set and NA values for the other two.

```{r PCAData, eval=TRUE}


###PCA Unbiased Analysis  

#Get a PCA model from the raw data
rawFVNames <- grep("Log2|Logit", grep("ECMp|Ligand|MEP|Barcode|Well|StainingSet|Loess|RUV3",colnames(l4nMean),invert = TRUE, value = TRUE), value=TRUE)
rawPCAModel <- createPCAModel(dt=l4nMean, fvNames = rawFVNames)

#Get a PCA model from the RUV3 data
RUV3Names <- grep("Loess",grep("Log2RUV3$|LogitRUV3$",colnames(l4nMean), value=TRUE),value=TRUE,invert=TRUE)
RUV3PCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3Names)

#Get a PCA model from the RUV3Loess data
RUV3LoessNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4nMean), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessPCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3LoessNames)

#Get a PCA model from the RUV3Loess of all signals
RUV3LoessMEPNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4Merge), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessMEPPCAModel <- createPCAModel(dt=l4Merge, fvNames = RUV3LoessMEPNames)

RUV3LoessMEPFBSPCAModel <- createPCAModel(dt=l4MergeFBS, fvNames = RUV3LoessMEPNames)


```


### tSNE of all MEP Signals

```{r tSNEFBS_Data}
#Need to remove FBS entries that are duplicated after normalization
l4MergeFBS$Ligand <- sub("FBS.*","FBS",l4MergeFBS$Ligand)
l4MergeFBS$MEP <- sub("FBS.*","FBS",l4MergeFBS$MEP)
l4MergeFBSU <- unique(l4MergeFBS)
data_matrix <- scale(as.matrix(l4MergeFBSU[,RUV3LoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4MergeFBSU <- cbind(l4MergeFBSU,data_tsne$Y)

data_matrix <- scale(as.matrix(l4SS1[,colnames(l4SS1) %in% RUV3LoessNames, with=FALSE]))
set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4SS1 <- cbind(l4SS1,data_tsne$Y)

data_matrix <- scale(as.matrix(l4SS2LP[,colnames(l4SS2LP) %in% RUV3LoessNames, with=FALSE]))
set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4SS2LP <- cbind(l4SS2LP,data_tsne$Y)

data_matrix <- scale(as.matrix(l4SS3LP[,colnames(l4SS3LP) %in% RUV3LoessNames, with=FALSE]))
set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4SS3LP <- cbind(l4SS3LP,data_tsne$Y)

data_matrix <- scale(as.matrix(l4SS3LP[,colnames(l4SS3LP) %in% RUV3LoessNames, with=FALSE]))
set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4SS3LP <- cbind(l4SS3LP,data_tsne$Y)

data_matrix <- scale(as.matrix(l4nMean[,colnames(l4nMean) %in% RUV3LoessNames, with=FALSE]))
set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4nMean <- cbind(l4nMean,data_tsne$Y)

```


```{r plottSNELigandSS1,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4SS1, aes(x=V1, y=V2, colour=LigandPlate, text=MEP))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A SS1 MEPs Colored by LigandPlate"))+
  guides(colour = FALSE)
ggplotly(p)

```



```{r plottSNELigandSS2,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4SS2LP, aes(x=V1, y=V2, colour=LigandPlate, text=MEP))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A SS2 MEPs Colored by LigandPlate"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r plottSNELigandSS3,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4SS3LP, aes(x=V1, y=V2, colour=LigandPlate, text=MEP))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A SS3 MEPs Colored by LigandPlate"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r plottSNELigandCS,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4nMean, aes(x=V1, y=V2, colour=LigandPlate, text=MEP))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A Common Signal MEPs Colored by LigandPlate"))+
  guides(colour = FALSE)
ggplotly(p)

```



```{r plottSNELigandFBSU,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4MergeFBSU, aes(x=V1, y=V2, colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A MEPs with FBS Colored by Ligand"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r tSNEData,fig.width=8, fig.height=5, eval=TRUE}
data_matrix <- scale(as.matrix(l4Merge[,RUV3LoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15)
l4Merge <- cbind(l4Merge,data_tsne$Y)
```

```{r plottSNELigand,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A MEPs Colored by Ligand"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r plottSNEECMp,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=ECMp, text=paste("Ligand:",Ligand)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A MEPs Colored by ECM Protein"))+
  guides(colour =FALSE)
ggplotly(p)

```


```{r plottSNELigandPlate,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate.x, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A MEPs Colored by Ligand Plate"))+
  guides(colour =FALSE)
ggplotly(p)

```

```{r tSNE_exploreeedsData, fig.width=3, fig.height=3, eval=FALSE}

seed <- 42
set.seed(seed)
data_tsne <- Rtsne(data_matrix, perplexity = 30)
l4Merge$V1 <- data_tsne$Y[,1]
l4Merge$V2 <- data_tsne$Y[,2]

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot Colored by Ligand Plate, seed:",seed))+
  guides(colour =FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

seed <- 1
set.seed(seed)
data_tsne <- Rtsne(data_matrix, perplexity = 30)
l4Merge$V1 <- data_tsne$Y[,1]
l4Merge$V2 <- data_tsne$Y[,2]

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot Colored by Ligand Plate, seed:",seed))+
  guides(colour =FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)


seed <- 1999
set.seed(seed)
data_tsne <- Rtsne(data_matrix, perplexity = 30)
l4Merge$V1 <- data_tsne$Y[,1]
l4Merge$V2 <- data_tsne$Y[,2]

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot Colored by Ligand Plate, seed:",seed))+
  guides(colour =FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)



```


```{r plottSNEFeatures,fig.width=3, fig.height=3, eval=FALSE}

tmp <- lapply(
  ,function(sigName){
  p <- ggplot(l4Merge, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

tmp <- lapply(grep("TissueExpression|PrimaryCellSource|Growth|Migration|Invasion|TherapeuticResistance|Metastasis|Survival|Angiogenesis|Proliferation|Immunomodulatory|TumorProgression|TherapeuticResponse|StemCellMaintenance|TumorInitiation|VascularHomeostasis|Inflammation|ImmuneEffects|Progression|Adhesion|TumorEffects", colnames(l4Merge), value=TRUE),function(sigName){
  p <- ggplot(l4Merge, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

```
