
```{r "setup", include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)
knitr::opts_knit$set(root.dir = "/graylab/share/dane/MEP-LINCS/MEP_LINCS/Release")

#Author: Mark Dane, copyright 2015

#source("MEPLINCSFunctions.R")

#' Summarize spot level data to the MEP level
#' 
#' Median summarize the spot level normalized values the most biologically 
#' interpretable raw data at each spot, calculate the standard errors and add
#' SE columns for all median summarized data
#' @param l3 The datatable of spot level data to be summarized
#' @return A datatable of MEP level, median summarized data with standard error values and 
#'  metadata
#' @export
preprocessLevel4 <- function(dt, seNames=NULL){
  #Add a count of replicates
  dt <- dt[,Spot_PA_ReplicateCount := .N,by="Ligand,ECMp,Drug,CellLine"]
  rawSignalNames <- grep("_SE",grep("Log2|Logit|_PA_|Intensity|AreaShape",colnames(dt), value=TRUE), value=TRUE, invert=TRUE)
  l4Signals<- dt[,lapply(.SD, numericMedian), by="Ligand,ECMp,Drug,CellLine", .SDcols=rawSignalNames]
  
  #Use seNames to select the parameters that get SE values
  if(!is.null(seNames)){
    seNamesPattern<-paste(seNames,collapse="|")
    seSignalNames <- grep(seNamesPattern,rawSignalNames,value=TRUE)
    l4Ses <- dt[,lapply(.SD,MEMA:::se),keyby="Ligand,ECMp,Drug,CellLine", .SDcols=seSignalNames]
  } else{
    l4Ses <- dt[,lapply(.SD,MEMA:::se),keyby="Ligand,ECMp,Drug,CellLine"]
  }
  
  #Add _SE to the standard error column names
  setnames(l4Ses, grep("Ligand|ECMp|Drug|CellLine",colnames(l4Ses), value = TRUE, invert = TRUE), paste0(grep("Ligand|ECMp|Drug|CellLine",colnames(l4Ses), value = TRUE, invert = TRUE),"_SE"))
  
  #Merge back in the replicate metadata
  #Remove the plate specific metadata and the signal data
   metadataNames <- grep("_SE|Barcode|^BW$|ArrayRow|ArrayColumn|^Well$|^Spot$|^PrintSpot$|^Well_Ligand$|ImageID|QA_|ECMSet|QAScore|LigandSet",colnames(dt), value=TRUE,invert=TRUE) %>%
    setdiff(rawSignalNames)
  mdDT <- unique(dt[,metadataNames, with=FALSE])
  setkey(l4Signals,Ligand,ECMp,Drug,CellLine)
  setkey(l4Ses,Ligand,ECMp,Drug,CellLine)
  setkey(mdDT,Ligand,ECMp,Drug,CellLine)
  l4DT <- merge(mdDT,merge(l4Signals,l4Ses))
  #Add back in a concatenated string of the data's barcodes
   barcodesList <- sapply(unique(l4DT$MEP_Drug), function(m){
    paste(unique(dt$Barcode[dt$MEP_Drug==m]),collapse=",")
  })
  bmdDT <- data.table(Barcode = barcodesList, MEP_Drug=names(barcodesList))
  l4DT <- merge(bmdDT,l4DT,by="MEP_Drug")
  return(l4DT)
}#End of preprocesslevel4

library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(readxl)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
```


```{r readLevel3and4Data, echo=FALSE}

l3 <- fread(paste0(path,"/",datasetName,"/Annotated/",datasetName,"_Level3.tsv"),verbose = FALSE, showProgress = FALSE)
l4 <- fread(paste0(path,"/",datasetName,"/Annotated/",datasetName,"_Level4.tsv"),verbose = FALSE, showProgress = FALSE)

annotations <- fread(paste0(path,"/",datasetName,"/Annotated/",datasetName,"_Level3Annotations.tsv"),header = FALSE)
CellLine = annotations$V2[annotations$V1=="CellLine"]
Preprocess = annotations$V2[annotations$V1=="Preprocess"]
DataType = annotations$V2[annotations$V1=="DataType"]
Consortia = annotations$V2[annotations$V1=="Consortia"]
Drug = annotations$V2[annotations$V1=="Drug"]
Segmentation = annotations$V2[annotations$V1=="Segmentation"]
StainingSet = annotations$V2[annotations$V1=="StainingSet"]
Level = annotations$V2[annotations$V1=="Level"]


barcodes <- sort(unique(l3$Barcode))

#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.7

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

if(!Segmentation=="v1"){
  l3$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}

```



#MEP-LINCS `r datasetName` Analysis  
####date: `r Sys.Date()`

<br>

##Introduction  
The LINCS `r datasetName` experiment was performed with `r CellLine` cells grown in `r length(barcodes)` 8-well plates. The `r StainingSet` staining set includes, DAPI, `r unique(l4$Endpoint488)`, `r unique(l4$Endpoint555)` and `r unique(l4$Endpoint647)`. Color images of the cells at each spot were gathered on a Nikon automated microscope. The CP Pipeline `r Segmentation` performed the segmentation and the analysis pipeline is `r Preprocess`.

Intensity, position and morphology data are gathered for each cell, merged with the experiment metadata, normalized with `r unique(l3$NormMethod)`, filtered and summarized. 


```{r Filtering}

#Remove the fiducial and blank data
setkey(l3,ECMp)
l3F <- l3[!grepl("fiducial|Fiducial|blank|PBS",l3$ECMp),]

#Remove failed QA wells
#Read in manually cureated list
PoorQualityWells <- read_excel("/graylab/share/dane/MEP-LINCS/PoorQualityWells.xlsx")
PoorQualityWells$QA_LowWellQA <- TRUE
l3F <- l3F[,QA_LowWellQA :=NULL]
l3F <- merge(l3F,PoorQualityWells,by=c("Barcode","Well"),all=TRUE)
l3F$QA_LowWellQA[is.na(l3F$QA_LowWellQA)]<-FALSE

#Delete wells that have been flagged for low well quality
l3F <- l3F[!l3F$QA_LowWellQA]
l3F <- l3F[l3F$QAScore>wellQAThresh]

#Remove features that will not be accessed in this analysis
l3KeepNames <- grep("Omero|MEP|ECMp|Ligand|Array|QA|Barcode|Spot_PA_SpotCellCount|Nuclei_PA_Gated_EdUPositiveProportionLogit|Cytoplasm_PA_Intensity_LineageRatioLog2|Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess|Spot_PA_ReplicateCount|Cytoplasm_PA_Intensity_LineageRatioLog2|Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2|Cytoplasm_CP_Intensity_MedianIntensity_KRT|Nestin",colnames(l3),value=TRUE)
l3F <- l3F[,l3KeepNames, with=FALSE]

#Combine FBS replicates
l3FFBS <- l3F
l3FFBS$Ligand[grepl("FBS",l3FFBS$Ligand)] <- gsub("_.*","",l3FFBS$Ligand[grepl("FBS",l3FFBS$Ligand)])
l4F <- createl4(l3FFBS,  seNames=c("DNA2N","SpotCellCount","EdU","MitoTracker","KRT","Lineage","Fibrillarin","Nestin"))
#Summarize the FBS MEPs
l4F <- summarizeFBS(l4F)

#Add Robust Z Scores of the normalized Spot Cell Counts #across the entire staining set
l4F <- l4F[,Spot_PA_SpotCellCountLog2RUVLoess_RobustZ := RZScore(Spot_PA_SpotCellCountLog2RUVLoess)]

if  (any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F))))  {
  #Add Robust Z Score of the EdU Signal
  l4F <- l4F[,Nuclei_PA_Gated_EdUPositiveProportionRUVLoess_RobustZ := RZScore(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)]
}

if  (any(grepl("LineageRatioLog2RUVLoess",colnames(l4F)))) {
  #Add Robust Z Scores of the normalized lineage ratios
  
  l4F <- l4F[, Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess_RobustZ:= RZScore(Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess)]
}

```




##Spot Cell Count Analysis
The spot cell count analysis identifies MEPs with extreme population sizes. The normalized spot cell counts in the plot below are summarized by the median and standard error of their replicates. Hovering over the the interactive plot below shows the MEP identities. Clicking and dragging over a section of the plot will zoom into the selected location. Double clicking on the zooomed plot will restore the original plot.

<br>



```{r SCCByMEPFull, fig.width=8, fig.height=6}
dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Spot_PA_SpotCellCountLog2RUVLoess), y = Spot_PA_SpotCellCountLog2RUVLoess))+
  geom_errorbar(aes(ymin=Spot_PA_SpotCellCountLog2RUVLoess-Spot_PA_SpotCellCountLog2RUVLoess_SE, ymax=Spot_PA_SpotCellCountLog2RUVLoess+Spot_PA_SpotCellCountLog2RUVLoess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized Spot Cell Count")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized Spot Cell Count (Full dataset)")

p <- p + geom_point(aes(y=Spot_PA_SpotCellCountLog2RUVLoess),colour = "darkblue", alpha = .5)

ggplotly(p)

```


###Normalized Spot Cell Counts

The interactive heatmaps below are arranged by unsupervised clustering of the rows and columns and colored by the normalized spot cell count. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.  

```{r SCCHeatmapFull, fig.width=8, fig.height=5}
#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUVLoess,Barcode)]),ECMp~Ligand, value.var = "Spot_PA_SpotCellCountLog2RUVLoess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```

<br>

##Interactive Datatables   
The first datatable below shows the MEP summarized values while the second table shows the spot-level data. The spot-level datatable includes links to the images stored in OHSU's Omero database.  

The tables can be sorted by the values in any column, filtered by any search term and adjusted to display from 5 to 100 rows.  

A useful mining method to use the first table to identify a MEP of interest as this table uses robust methods to summarize the replicates, then view the individual replicate data and images in the second table.  

<br> 


```{r SCCTable}
if(any(grepl("MitoTrackerLog2RUVLoess",colnames(l4F)))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed MitoTracker Intnsity","Replicate Count")
} else if(any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Replicate Count")
} else if(any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))&
          any(grepl("MedianIntensity_CaspaseLog2RUVLoess",colnames(l4F)))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess","Nuclei_CP_Intensity_MedianIntensity_CaspaseLog2RUVLoess")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Normed Caspase")
} else if(any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))&
          any(grepl("NestinLog2RUVLoess",colnames(l4F)))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess","Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Normed Nestin")
} else if (any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))&
          any(grepl("KRT5Log2RUVLoess",colnames(l4F)))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess","Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Normed KRT5")
} else if (any(grepl("LineageRatioLog2RUVLoess",colnames(l4F)))){
  if (CellLine=="MCF10A"){
    colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess", "Spot_PA_ReplicateCount")
    colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
  }else{
    colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess","Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess", "Spot_PA_ReplicateCount")
    colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
    
  }
} else {
   colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUVLoess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Replicate Count")
}

dt <- setorder(l4F,-Spot_PA_SpotCellCountLog2RUVLoess)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

colNamesSpots <- c(colNames[1],"ArrayRow","ArrayColumn","OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"ArrayRow","ArrayColumn","Image Link",colNamesDisplay[2:length(colNamesDisplay)])
setkey(dt,"Ligand")

dt <- setorder(l3F, -Spot_PA_SpotCellCountLog2RUVLoess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```

<br>

##DNA Content Analysis

All cells are stained with DAPI and autogated as DNA 2N or 4N. The proportion of 2N and 4N cells at each spot is calculated and will always sum to 1. The proportions are logit transformed then RUV and loess normalized. Lower normalized values have smaller 2N populations and therefore larger 4N populations.

<br>

```{r DNA2NByMEPFull, fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess), y = Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess-Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess_SE, ymax=Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess+Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized DNA 2N Proportion Ratio")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized DNA Proportion (Full dataset)")

p <- p + geom_point(aes(y=Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess),colour = "blue", alpha = .5)

ggplotly(p)

```

<br>

###Normalized DNA 2N Heatmaps

The interactive heatmaps below are arranged by unsupervised clustering of the rows and columns and colored by the normalized DNA 2N proportions. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.    

```{r DNA2NHeatmapFull, fig.width=8, fig.height=5}

#Cast again to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```



```{r, child='MEP-LINCS_MitoText.Rmd', eval=any(grepl("MitoTracker",colnames(l4F)))}
```

<br>

```{r MitoTrackerByMEPFull, , eval=any(grepl("MitoTracker",colnames(l4F))), fig.width=8, fig.height=6}
dt <- l4F

yLimits <- quantile(c(dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess-dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess_SE, dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess+dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess_SE), probs=c(.002, .998))

p <- ggplot(dt, aes(x =reorder(MEP, Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess), y = Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess))+
  geom_errorbar(aes(ymin=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess-Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess_SE, ymax=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess+Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess_SE), width=.01, colour="black") +
  coord_cartesian(ylim=yLimits)+
  xlab("MEP")+ylab("Normalized MitoTracker Intensity Ratio")+
  geom_point(colour = "green", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized MitoTracker Intensity with SE Bars (Full dataset)")

ggplotly(p)
```


```{r MitotrackerHeatmapFull, eval=any(grepl("MitoTracker",colnames(l4F))), fig.width=8, fig.height=5}

#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess,Barcode)]),ECMp~Ligand, value.var = "Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r, child='MEP-LINCS_ProliferationText.Rmd', eval=any(grepl("EdU",colnames(l4F)))}
```



```{r NormedProliferationByMEPFull, eval=any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F))), fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), y = Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess-Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess_SE, ymax=Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess+Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized EdU+ Proportion Logit")+
  geom_point(colour = "red", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized EdU+ Proportion")

ggplotly(p)
```



```{r, child='MEP-LINCS_ProliferationHeatMapsText.Rmd', eval=any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))}
```


```{r EdUHeatmapFull, fig.width=8, fig.height=5, eval=any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))}

#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


try(d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r EdUBoxplotsFull, fig.width=12, fig.height=5, eval=any(grepl("EdUPositiveProportionLogitRUVLoess",colnames(l4F)))}

p <- ggplot(l4F, aes(x=Ligand, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)))+
  geom_boxplot(outlier.colour = NA, fill=NA)+geom_jitter(aes(colour=ECMp),size=rel(.4))+
  coord_cartesian(ylim = c(0,.5))+
  guides(colour=FALSE)+
  xlab("Ligand")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

print(p)
#ggplotly(p, tooltip="colour")

```

```{r NormedNestinByMEP, eval=any(grepl("NestinLog2RUVLoess",colnames(l4F))), fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess), y = Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess))+
  geom_errorbar(aes(ymin=Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess-Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess_SE, ymax=Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess+Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized Nestin Intensity")+
  geom_point(colour = "red", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized Nestin Intensity")

ggplotly(p)
```



```{r NestinHeatmapFull, fig.width=8, fig.height=5, eval=any(grepl("NestinLog2RUVLoess",colnames(l4F)))}

#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


try(d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r NestinBoxplotsFull, fig.width=12, fig.height=5, eval=any(grepl("NestinLog2RUVLoess",colnames(l4F)))}

p <- ggplot(l4F, aes(x=Ligand, y=Nuclei_CP_Intensity_MedianIntensity_NestinLog2RUVLoess))+
  geom_boxplot(outlier.colour = NA, fill=NA)+geom_jitter(aes(colour=ECMp),size=rel(.4))+
  guides(colour=FALSE)+
  xlab("Ligand")+ylab("Normalized Nestin Intensity (log2)")+
  ggtitle("MEP Nestin Intensity by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

print(p)
#ggplotly(p, tooltip="colour")

```

```{r, child='MEP-LINCS_LineageText.Rmd',eval=any(grepl("LineageRatioLog2RUVLoess",colnames(l4F)))}
```

```{r LineageRatioByMEP,eval=any(grepl("LineageRatioLog2RUVLoess",colnames(l4F))), fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess), y = Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess))+
  geom_errorbar(aes(ymin=Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess-Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess_SE, ymax=Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess+Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized Logged Lineage Ratio")+
  geom_point(colour = "blue", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized Lineage Ratio with SE Bars")

ggplotly(p)
```



```{r LineageMarkers, echo=FALSE, fig.width=8, fig.height=6,eval=any(grepl("KRT5Log2RUVLoess",colnames(l4F)))& any(grepl("KRT19Log2RUVLoess",colnames(l4F)))}

dt <- l4F

p <- ggplot(dt, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess, y = Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUVLoess, colour = Ligand))+
  geom_point(alpha=.5)+
  guides(colour=FALSE)+
  xlab("Normalized KRT5 Median Intensity")+ylab("Normalized KRT19 Median Intensity")+
  ggtitle("Normalized MEP Lineage Marker Intensities by Ligand")
(gg <- ggplotly(p))
```


```{r LineagRatioHeatmapFull, fig.width=8, fig.height=5, eval=any(grepl("LineageRatioLog2RUVLoess",colnames(l4F)))}

#Cast to get ECMps in rows and ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand, Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess,Barcode)]),ECMp~Ligand, value.var = "Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


try(d3heatmap(dfZoom(df, 0.0, .97), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r EdUvsLineageMarkers, echo=FALSE, fig.width=8, fig.height=6, eval=any(grepl("LineageRatioLog2RUVLoess",colnames(l4F)))}

dt <- l4

p <- ggplot(dt, aes(x=Cytoplasm_PA_Intensity_LineageRatioLog2RUVLoess, y = btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), colour = Ligand))+
  geom_point(alpha=.5)+
  guides(colour=FALSE)+
  xlab("Lineage Ratio")+ylab("EdU Proliferation")+
  ggtitle("EdU vs Lineage by Ligand")
(gg <- ggplotly(p))
```

##Unbiased Analysis

The unbiased analysis method is:  
Median summarize the cell level data at each spot  
Normalize the spot level data using RUV and loess methods  
Median summarize the normalized replicate spot values to the MEP level  
Perform hierarchical clustering on a curated feature vector of MEP intensities and morphologies  

The heatmap below is arranged by unsupervised clustering on the euclidean distance between the non-linearly compressed, scaled feature vectors. The rows are MEPs and the columns are the features. The squares are colored by the normalized MEP feature values.  

Clicking and dragging will zoom in on a section. Double clicking on the zoomed image will return to the full heatmap. This enables identifying MEPS that elicit similar responses on endpoints of interest.  

<br> 

```{r, eval=FALSE}

lowQALigands <- unique(l3$Ligand[l3$QA_LowWellQA])
fvDT <- filterl4RUV(l4, lowQALigands)
setkey(fvDT, MEP)
fvDT <- fvDT[!grepl("FBS|Fiducial|fiducial|blank|PBS",fvDT$MEP),]
fvDT <- fvDT[,Barcode := NULL]

#Shorten the feature names
setnames(fvDT,grep("Barcode|MEP",colnames(fvDT), value = TRUE, invert = TRUE),gsub(".*_","",gsub("RUVLoess","",grep("Barcode|MEP",colnames(fvDT), value = TRUE, invert = TRUE))))
#Remove when not needed
if("2NProportion" %in% colnames(fvDT)) setnames(fvDT,"2NProportion","DNA2NProportion")

#Convert to dataframe for use in D3heatmap
fvDT <- data.frame(fvDT)
rownames(fvDT) <- fvDT$MEP

fvDT <- fvDT[,!(names(fvDT) %in% c("MEP"))]
```


```{r, fig.height=8, fig.width=7, eval = FALSE}
fvDTC <- apply(fvDT,2,fvZoom, min=.02, max=.98)
try(d3heatmap(fvDTC, scale="column", colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE), TRUE)

```


```{r createtSNE, eval=FALSE}

tSNEParameters <- grep("MEP|Ligand|ECMp|Replicate|Barcode",colnames(filterl4RUV(l4, lowQALigands)), invert=TRUE, value=TRUE)
data_matrix <- scale(as.matrix(dt[,tSNEParameters, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15)
dtt <- cbind(dt,data_tsne$Y)

```

```{r plottSNEBarcode,fig.width=4, fig.height=3, eval=FALSE}

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "Barcode"))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of Barcode"))+
  #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
  guides(colour = guide_legend(title.theme = element_text(angle=0, size=12),override.aes = list(size=rel(.7),alpha=1)))
print(p)

```


```{r plottSNEFeatures,fig.width=3, fig.height=3, eval=FALSE}

tmp <- lapply(c(tSNEParameters),function(sigName){
  p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

```


```{r ggplotlytSNEMEPs,fig.width=6, fig.height=6, eval=FALSE}

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "ECMp"))+
  geom_point(size=rel(1.2), alpha=.5)+
  ggtitle(paste("tSNE plot by ECMp"))+
  guides(colour = FALSE)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

(gg <- ggplotly(p))

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "Ligand"))+
  geom_point(size=rel(1.2), alpha=.5)+
  ggtitle(paste("tSNE plot by Ligand"))+
  guides(colour = FALSE)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
(gg <- ggplotly(p))
```

```{r plottSNEMEPs,fig.width=6, fig.height=6, eval=FALSE }
p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "MEP"))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot by MEP"))+
  guides(colour = FALSE)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

```


