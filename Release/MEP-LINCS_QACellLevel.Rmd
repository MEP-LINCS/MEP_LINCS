
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

```


```{r }
#Author: Mark Dane, copyright 2015

source("MEPLINCSFunctions.R")

```



```{r setup,cache=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
sampleProportion <- .1

```

```{r readLevel1}
l1 <- fread(paste0("../AnnotatedData/",cellLine,"_",ss,"_Level1.txt"), showProgress = FALSE)
```


```{r}
set.seed(42)

l1S <- l1[sample(1:nrow(l1),sampleProportion*nrow(l1),replace=FALSE),grep("Barcode|Well|Ligand|ECMp|TotalDNANormed|DNAThresh|Ligand|Nuclei_CP_Intensity_IntegratedIntensity_Dapi|Nuclei_PA_Cycle_State|Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker|Nuclei_CP_Intensity_MedianIntensity_EdU|Nuclei_PA_Gated_EdUPositive|Cytoplasm_CP_Intensity_MedianIntensity_KRT|LineageRatio|Cytoplasm_PA_Gated_KRTClass|Cytoplasm_PA_Gated_KRT19Positive|Cells_PA_Gated",colnames(l1)), with=FALSE]
l1S <- l1S[,Well_Ligand :=  paste(Well,Ligand, sep="\n")]
l1S <- l1S[,TotalDNANormed := Nuclei_CP_Intensity_IntegratedIntensity_Dapi/median(Nuclei_CP_Intensity_IntegratedIntensity_Dapi[Nuclei_PA_Cycle_State==1]), by="Barcode,Well"]
l1S <- l1S[,DNAThresh := min(TotalDNANormed[Nuclei_PA_Cycle_State==2]), by="Barcode,Well"]

barcodes <- sort(unique(l1S$Barcode))

#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.7

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

```


#MEP-LINCS `r cellLine` `r ss` Cell-Level QA Report
####date: `r Sys.Date()`

##Summary
This report covers the cell-level data for the `r cellLine` `r ss` dataset. There are additional reports for the spot and MEP QA and the analysis of this staining set. 

##Introduction
The LINCS `r cellLine` `r ss` experiment was performed with cells grown in `r length(barcodes)` 8-well plates. The `r ss` staining set includes, DAPI, `r unique(l1$Endpoint488)`, `r unique(l1$Endpoint555)` and `r unique(l1$Endpoint647)`. Color images of the cells at each spot were gathered on a Nikon automated microscope. The CP Pipeline `r rawDataVersion` performed the segmentation and the analysis pipeline is `r analysisVersion`.

Most of the histograms and scatterplots that display cell level data are from a randomly sampled subset of the full dataset (sample proportion = `r sampleProportion`).

<br>

###DAPI QA
Histograms of the total DAPI signal are typicaly bimodal with peaks at the 2N and 4N DNA positions. The blue vertical line shows the auto-gate value for classifying 2N and 4N populations.

We want to normalize the DNA signal so that the G0/G1 peak has a value of 1. This should yield G2 peak at 2. To achieve this, the total DAPI intensity is divided by the median total DAPI intensity for all cells that have a DNA Cycle State value of 1 (to the left of the blue line).

The plots below are of a randomly sampled subset of the cell-level data.

<br>

```{r rawDAPIPlots, fig.width=3.7,fig.height=3, eval=exists("l1")}

binwidth=.04
cummulativeMaxCount<-0
for(barcode in barcodes){
  setkey(l1S, Barcode)
  dtb <- l1S[barcode]
  p <- ggplot(dtb, aes(x=TotalDNANormed))+geom_histogram(binwidth = binwidth)+
    facet_grid(Barcode~Well_Ligand)
  currentMaxCount <- max(ggplot_build(p)$data[[1]]$count)
  cummulativeMaxCount<- max(cummulativeMaxCount,currentMaxCount)
}
for(barcode in barcodes){
  setkey(l1S, Barcode)
  dtb <- l1S[barcode]
  p <- ggplot(dtb, aes(x=TotalDNANormed))+geom_histogram(binwidth = binwidth)+
    coord_cartesian(x=c(0,4), y=c(0,cummulativeMaxCount))+
    geom_vline(data = dtb, aes(xintercept = DNAThresh), colour = "blue")+
 facet_wrap(~Well_Ligand, nrow=2) +
    ylab("Count")+xlab("Total Intensity DAPI")+ggtitle(paste("Total DAPI Intensity:",barcode))+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.8)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)),strip.text.x = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}
```

<br>


```{r, child='MEP-LINCS_MitoText.Rmd', eval=grepl("SS1",ss)}
```

<br>

```{r rawMitoHistograms, fig.width=3.7,fig.height=4, eval=exists("l1")&grepl("SS1",ss)}

for (barcode in barcodes){
  setkey(l1S, Barcode)
  dtb <- l1S[barcode]
  dtb <- dtb[log2(dtb$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker) > quantile(log2(dtb$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker), probs=.01, na.rm=TRUE) & log2(dtb$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker) < quantile(log2(dtb$Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker),probs=.98, na.rm=TRUE)]
  p <- ggplot(dtb, aes(x=log2(Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker)))+
    geom_histogram(binwidth = binwidth)+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("MitoTracker Intensity,",barcode))+
    ylab("Count")+xlab("Median Intensity MitoTracker\nLog2")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}
```

```{r rawCOL1Histograms, fig.width=10,fig.height=10, eval=exists("l1")&grepl("SS1",ss)&FALSE}
#Display histograms for one COl1 spot of each ligand
p <- ggplot(l1[l1$PrintSpot==193,], aes(x=log2(Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker)))+
  geom_density(fill="blue", alpha=.5)+
  facet_wrap(~Ligand, scales = "free")+
  ggtitle(paste("Median MitoTracker Signal in Sampled COL1 Spots"))+
  ylab("Count")+xlab("Median Intensity MitoTracker")+
  theme(axis.text.x=element_blank(), axis.text.y=element_blank(), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
suppressWarnings(print(p))

#Display density plots for one COl1 spot of each ligand
p <- ggplot(l1[grepl("VEGF",l1$Ligand)&grepl("COL1",l1$ECMp),], aes(x=log2(Cytoplasm_CP_Intensity_MedianIntensity_MitoTracker)))+
  geom_density(fill="blue", alpha=.5)+
  facet_wrap(~Spot, scales = "free")+
  ggtitle(paste("Median MitoTracker Signal in VEGF COL1 Spots"))+
  ylab("Count")+xlab("Median Intensity MitoTracker")+
  theme(axis.text.x=element_blank(), axis.text.y=element_blank(), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
suppressWarnings(print(p))
```


```{r, child='MEP-LINCS_EdUText.Rmd', eval=grepl("SS2|SS4|SS6",ss)}
```

<br>

```{r rawEdUHistograms, fig.width=3.7,fig.height=4, eval=exists("l1")&grepl("SS2|SS4|SS6",ss)}

for (barcode in barcodes){
  setkey(l1S,Barcode)
  mDT <- l1S[barcode]
  mDT <- mDT[mDT$Nuclei_CP_Intensity_MedianIntensity_EdULog2 > quantile(mDT$Nuclei_CP_Intensity_MedianIntensity_EdULog2, probs=.01, na.rm=TRUE) & mDT$Nuclei_CP_Intensity_MedianIntensity_EdULog2 < quantile(mDT$Nuclei_CP_Intensity_MedianIntensity_EdULog2,probs=.98, na.rm=TRUE),]
  p <- ggplot(mDT, aes(x=Nuclei_CP_Intensity_MedianIntensity_EdULog2))+
    geom_histogram(binwidth = .01)+
    facet_wrap(~Well_Ligand, nrow=2, scales="free_x")+
    ggtitle(paste("EdU Intensity,",barcode))+
    ylab("Count")+xlab("Median Intensity EdU\nLog2")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```



```{r, child='MEP-LINCS_Krt5Krt19Text.Rmd', eval=grepl("SS3|SS4",ss)}
```

<br>

```{r rawKrt5Histograms, fig.width=3.7,fig.height=4, eval=exists("l1")&grepl("SS3|SS4",ss)}

xMin <- quantile(l1S$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1S$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1S[l1S$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2))+
    geom_histogram(binwidth = .01)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2)+
    ggtitle(paste("KRT5 Intensity,",barcode))+
    ylab("Count")+xlab("Median Intensity KRT5\nLog2")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```


```{r, child='MEP-LINCS_Krt14Krt19Text.Rmd', eval=grepl("SS6",ss)}
```

<br>


```{r rawKrt14Histograms, fig.width=3.7,fig.height=4, eval=exists("l1")&grepl("SS6",ss)}
xMin <- quantile(l1S$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1S$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1S[l1S$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2))+
    geom_histogram(binwidth = .01)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2)+
    ggtitle(paste("KRT5 Intensity,",barcode))+
    ylab("Count")+xlab("Median Intensity KRT5\nLog2")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```


<br>

```{r rawKrt19Histograms, fig.width=3.7,fig.height=4, eval=exists("l1")&grepl("SS3|SS4|SS6",ss)}
xMin <- quantile(l1S$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1S$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1S[l1S$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2))+
    geom_histogram(binwidth = .01)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2)+
    ggtitle(paste("KRT19 Intensity,",barcode))+
    ylab("Count")+xlab("Median Intensity KRT19\nLog2")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```


<br>

```{r rawlineageRatioHistograms, fig.width=3.7,fig.height=4, eval=exists("l1")&grepl("SS3|SS4",ss)}
xMin <- quantile(l1S$Cytoplasm_PA_Intensity_LineageRatioLog2,probs=.01, na.rm=TRUE)
xMax <- quantile(l1S$Cytoplasm_PA_Intensity_LineageRatioLog2,probs=.99, na.rm=TRUE)

for (barcode in barcodes){
  mDT <- l1S[l1S$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_PA_Intensity_LineageRatioLog2))+
    geom_histogram(binwidth = .1)+
    coord_cartesian(xlim=c(xMin,xMax))+
    facet_wrap(~Well_Ligand, nrow=2)+
    ggtitle(paste("Lineage Ratio,",barcode))+
    ylab("Count")+xlab("Median Intensity Lineage Ratio\nLog2")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```


```{r gatedKRTScatterplots, fig.width=8,fig.height=4, eval=exists("l1")&grepl("SS3|SS4",ss)}

for (barcode in barcodes){
  mDT <- l1S[l1S$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2,y=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2, colour=factor(Cytoplasm_PA_Gated_KRTClass)))+
    geom_point(size=rel(.2), alpha=.2)+
    geom_rug(col=rgb(.5,0,0,alpha=.01))+
    facet_wrap(~Well_Ligand, nrow=2)+
    ggtitle(paste("KRT19 vs KRT5 Intensities,",barcode))+
    guides(colour=guide_legend(title="KRT Class", override.aes = list(alpha = 1, size=1)))+
    ylab("Median KRT19 Intensity\nLog2")+xlab("Median KRT5 Intensity\nLog2")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(.5)),axis.title.x = element_text(size = rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.title.y = element_text(size = rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```


```{r gatedKRTLigandboxplots, fig.width=10,fig.height=4, eval=exists("l1")&grepl("SS3|SS4",ss)}

  p <- ggplot(l1S, aes(x=factor(Ligand),y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2, colour=factor(Cytoplasm_PA_Gated_KRT19Positive)))+
    geom_boxplot(outlier.colour = NA)+
    ggtitle(paste("KRT5 Intensities by KRT19 State and Ligand"))+
    guides(colour=guide_legend(title="KRT19+", override.aes = list(alpha = 1, size=1)))+
    ylab("Median KRT5 Intensity\nLog2")+xlab("Ligand")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(.5)),axis.title.x = element_text(size = rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.title.y = element_text(size = rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
```


```{r EdUgatedKRTScatterplots, fig.width=8,fig.height=4, eval=exists("l1")&grepl("SS4",ss)}

for (barcode in barcodes){
  mDT <- l1S[l1S$Barcode == barcode]
  p <- ggplot(mDT, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2,y=Nuclei_CP_Intensity_MedianIntensity_EdULog2, colour=factor(Cells_PA_Gated_EdUKRT19Class)))+
    geom_point(size=rel(.2), alpha=.2)+
    geom_rug(col=rgb(.5,0,0,alpha=.01))+
    facet_wrap(~Well_Ligand, nrow=2)+
    ggtitle(paste("EdU vs KRT19 Intensities,",barcode))+
    guides(colour=guide_legend(title="KRT EdU Class", override.aes = list(alpha = 1, size=1)))+
    ylab("Median EdU Intensity\nLog2")+xlab("Median KRT19 Intensity\nLog2")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(.5)),axis.title.x = element_text(size = rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.title.y = element_text(size = rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
}

```

```{r EdUbygatedKRTLigandboxplots, fig.width=10,fig.height=4, eval=exists("l1")&grepl("SS4",ss)}

  p <- ggplot(l1S, aes(x=factor(Ligand),y=log2(Nuclei_CP_Intensity_MedianIntensity_EdU), colour=factor(Cytoplasm_PA_Gated_KRT19Positive)))+
    geom_boxplot(outlier.colour = NA)+
  coord_cartesian(ylim = c(6,8))+
    ggtitle(paste("EdU Intensities by KRT19 State and Ligand"))+
    guides(colour=guide_legend(title="KRT19+", override.aes = list(alpha = 1, size=1)))+
    ylab("Median EdU Intensity\nLog2")+xlab("Ligand")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(.5)),axis.title.x = element_text(size = rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.title.y = element_text(size = rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)), strip.text = element_text(size = rel(.5)))
  suppressWarnings(print(p))
```

```{r rawCOL1KRT5Densities, fig.width=10,fig.height=10, eval=exists("l1")&grepl("SS3|SS4",ss)&FALSE}
#Display density plots for one COl1 spot of each ligand
p <- ggplot(l1[l1$PrintSpot==193,], aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2))+
  geom_density(fill="blue", alpha=.5)+
  facet_wrap(~Ligand, scales = "free")+
  ggtitle(paste("Median KRT5 Signal in Sampled COL1 Spots"))+
  ylab("Count")+xlab("Median Intensity KRT5")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(.5)),axis.title.x = element_text(size = rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.title.y = element_text(size = rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)), strip.text = element_text(size = rel(.5)))
suppressWarnings(print(p))

#Display density plots for one COl1 spot of each ligand
p <- ggplot(l1[grepl("VEGF",l1$Ligand)&grepl("COL1",l1$ECMp),], aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2))+
  geom_density(fill="blue", alpha=.5)+
  facet_wrap(~Spot, scales = "free")+
  ggtitle(paste("KRT5 Intensity in VEGF COL1 Spots"))+
  ylab("Count")+xlab("Median KRT5 Intensity")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(.5)),axis.title.x = element_text(size = rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.title.y = element_text(size = rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)), strip.text = element_text(size = rel(.5)))
suppressWarnings(print(p))
```


```{r rawCOL1KRT19Histograms, fig.width=10,fig.height=10, eval=exists("l1")&grepl("SS3|SS4",ss)&FALSE}
#Display histograms for one COl1 spot of each ligand
p <- ggplot(l1[l1$PrintSpot==193,], aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2))+
  geom_density(fill="blue", alpha=.5)+
  facet_wrap(~Ligand, scales = "free")+
  ggtitle(paste("Median KRT19 Signal in Sampled COL1 Spots"))+
  ylab("Count")+xlab("Median Intensity KRT19")+
  theme(axis.text.x=element_blank(), axis.text.y=element_blank(), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
suppressWarnings(print(p))

#Display density plots for one COl1 spot of each ligand
p <- ggplot(l1[grepl("VEGF",l1$Ligand)&grepl("COL1",l1$ECMp),], aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2))+
  geom_density(fill="blue", alpha=.5)+
  facet_wrap(~Spot, scales = "free")+
  ggtitle(paste("KRT19 Intensity in VEGF COL1 Spots"))+
  ylab("Count")+xlab("Median KRT19 Intensity")+
  theme(axis.text.x=element_blank(), axis.text.y=element_blank(), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)), strip.text = element_text(size = rel(.5)))
suppressWarnings(print(p))
```



<br>

#Supplemental Material

```{r Cell_cycle_plots,echo=FALSE, fig.width=8, fig.height=5, eval=exists("l1")&grepl("SS2|SS4|SS6",ss)}
binwidth=.04
for (barcode in barcodes){
  setkey(l1S, Barcode)
  dtb <- l1S[barcode]
  p <- ggplot(dtb, aes(x=TotalDNANormed, y = log2(Nuclei_CP_Intensity_MedianIntensity_EdU), colour = Nuclei_PA_Gated_EdUPositive))+geom_point(size = rel(.2), alpha = .4)+
    geom_rug(col=rgb(.5,0,0,alpha=.01))+
     coord_cartesian(x=c(0,6))+
    scale_x_continuous(name="Total Intensity DAPI",breaks=0:6)+
    facet_wrap(~Well_Ligand, nrow=2)+ggtitle(paste("EdU vs. DAPI,",barcode))+ylab("EdU\n(log2)")+
    guides(colour=FALSE)+
    theme(strip.text = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p))
}
```

