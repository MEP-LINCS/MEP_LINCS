
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8X00","",dt$Barcode), sep="_")
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle, xlim=NULL, ylim=NULL, colorByCtrls=TRUE, highlightName=NULL){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  
  if(is.null(highlightName)){
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
  } else {
    #Dim out all MEPs except the selected
    dimColour<-"cornflowerblue"
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
  }
  
  if(colorByCtrls){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
  }
  
  if(!is.null(highlightName)){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="yellow",size = rel(.5), alpha = .8)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="yellow",size = rel(.5), alpha = .8)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="yellow",size = rel(.5), alpha = .8)
  }
  
  print(p12)
  print(p23)
  print(p13)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}


```

<br>

#MEP-LINCS `r cellLine` MCF10A MEP Nominations 
####date: `r Sys.Date()`

##Summary


```{r setup}

library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)
library(RUVnormalize)
library(ruv)

#Use x structure for future fleixbility
x <- data.frame(cellLine="MCF10A",
                drug= "none",
                analysisVersion="av1.6",
                rawDataVersion="v2",
                stringsAsFactors = FALSE)
#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol <- selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
PCAOnly <- TRUE

l3n <- fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)

l3n$ECMp <- gsub("hyaluronicacid","HA",l3n$ECMp)
l3n$ECMp <- gsub("lessthan","<",l3n$ECMp)
l3n$ECMp <- gsub("greaterthan",">",l3n$ECMp)

l4 <- fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)

l4$ECMp <- gsub("hyaluronicacid","HA",l4$ECMp)
l4$ECMp <- gsub("lessthan","<",l4$ECMp)
l4$ECMp <- gsub("greaterthan",">",l4$ECMp)

medianSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMedians <- dtKeep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMedians)
}

meanSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMeans)
}

numericMean <- function(x){
  as.numeric(mean(x, na.rm=TRUE))
}

l4nMean <- meanSummarizel4(l4)

```


```{r PCARawData, eval=TRUE}


###PCA Unbiased Analysis  
# The unbiased analysis is extended by using Principal Component Analysis (PCA) to reduce the dimensions of the feature vector.
# 
# The unbiased PCA analysis method is:
# Use PCA to transform the entire raw feature set to a much smaller number of principal components (PCFV).  
# Perform unsupervised hierarchical clustering of the first `r nrPCs` PCFVs.  
# 


#Get a PCA model from the raw data
rawFVNames <- grep("Log2|Logit", grep("ECMp|Ligand|MEP|Barcode|Well|StainingSet|Loess|RUV3",colnames(l4nMean),invert = TRUE, value = TRUE), value=TRUE)
rawPCAModel <- createPCAModel(dt=l4nMean, fvNames = rawFVNames)

#Get a PCA model from the RUV3 data
RUV3Names <- grep("Loess",grep("Log2RUV3$|LogitRUV3$",colnames(l4nMean), value=TRUE),value=TRUE,invert=TRUE)
RUV3PCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3Names)

#Get a PCA model from the RUV3Loess data
RUV3LoessNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4nMean), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessPCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3LoessNames)

#Get a PCA model from the RUV3LoessRUV3 data
RUV3LoessRUV3Names <- grep("Log2RUV3LoessRUV3$|LogitRUV3LoessRUV3$",colnames(l4nMean), value=TRUE)
RUV3LoessRUV3PCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3LoessRUV3Names)

#Get a PCA model from the RUV3LoessRUV3Loess data
RUV3LoessRUV3LoessNames <- grep("Log2RUV3LoessRUV3Loess$|LogitRUV3LoessRUV3Loess$",colnames(l4nMean), value=TRUE)
RUV3LoessRUV3LoessPCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3LoessRUV3LoessNames)

```

<br>

##Raw Signals
Below are the names of the signals used in the raw data PCA model. The other models have only their corresponding state (RUV3, RUV3Loess, etc) of these signals.  

`r rawFVNames `

<br>

###PCA Plots

The following scatter plots show principal component values of the MEPs (median of replicate spots within an array and then mean across the three staining sets) after PCA of all signals. The state of all signals within a PCA model are the same, that is they are all raw or at the same level of normalization. 

FBS MEPs are colored black, Nidogen 1 MEPS are brown, a selected ligand, ECM protein or combination is yellow and the rest of the MEPS are light blue. The selected MEP(s) are described in each plot title. TNC is a printed ECM protein and BMP7 is a ligand.  


```{r plotRawPCA, fig.height=3, fig.width=4}
plotScree(m = rawPCAModel, main=list("PCA Scree Plot of Raw Data",cex = .9))
plotScree(m = RUV3PCAModel, main=list("PCA Scree Plot of RUV3 Normalized Data",cex = .9))
plotScree(m = RUV3LoessPCAModel, main=list("PCA Scree Plot of RUV3Loess Normalized Data",cex = .9))
plotScree(m = RUV3LoessRUV3PCAModel, main=list("PCA Scree Plot of RUV3LoessRUV3 Normalized Data",cex = .9))
plotScree(m = RUV3LoessRUV3LoessPCAModel, main=list("PCA Scree Plot of RUV3LoessRUV3Loess Normalized Data",cex = .9))

```

```{r, fig.height=2, fig.width=3}
plotPCs(m = rawPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of Raw Data", legendTitle = "Ligand", xlim = c(-15,15), ylim=c(-10,10),highlightName = "TNC")

plotPCs(m = rawPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of Raw Data", legendTitle = "Ligand", xlim = c(-15,15), ylim=c(-10,10),highlightName = "BMP7")

```

```{r, fig.height=2, fig.width=3}
plotPCs(m = RUV3PCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3 Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "TNC")

plotPCs(m = RUV3PCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3 Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP7")

```

```{r, fig.height=2, fig.width=3}
plotPCs(m = RUV3LoessPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3Loess Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "TNC")
        
plotPCs(m = RUV3LoessPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3Loess Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP7")

```

```{r, fig.height=2, fig.width=3}
plotPCs(m = RUV3LoessRUV3PCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3LoessRUV3 Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "TNC")

plotPCs(m = RUV3LoessRUV3PCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3LoessRUV3 Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP7")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessRUV3LoessPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3LoessRUV3Loess Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "TNC")

plotPCs(m = RUV3LoessRUV3LoessPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of RUV3LoessRUV3Loess Normalized Data", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP7")


```


##Heatmaps

The following heatmaps are the summarized values of each MEP across the replicates of the common signal dataset.  

Spot values are median summarized within each plate to get MEP values for each staining set. 

The MEP values of each staining set are mean summarized and displayed in the heatmaps below.  


```{r medianHeatMaps, fig.width=4.5, fig.height=3.5}

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3Loess"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3Loess"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3Loess", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3LoessRUV3"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3LoessRUV3"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3LoessRUV3", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess", titleExpression=titleExpression, limits=limits)

```

###Static Heatmaps
The static heatmaps display the same data as above but with unsupervised clustering in the rows and columns using the complete linkage method which finds similar clusters. These maps use three colors to highlight the data sturcture however the white color is merely the center of the data, it does not have specific biological meaning.  

<br>

```{r medianHeatMaps2, fig.width=9, fig.height=5.5}

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2RUV3", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3Loess"
plotLEHmap(l4nMean, hclustfun = "hclust", fill="Spot_PA_SpotCellCountLog2RUV3Loess", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3LoessRUV3"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2RUV3LoessRUV3", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess", titleExpression=titleExpression, limits=limits)

```

###Calculate RLE Values
The relative log expression (RLE) values are the residuals where each item has had the median of all such items subtracted. The advantage of this is that all boxes will (nominally) be centered about zero, and systematic deviations from that are more readily noticed. In the ligand RLE boxplots, the groupings are all ECM proteins paired with each ligand within one staining set. In the ECM protein RLE boxplots, the groupings are all ligands paired with the ECM protein within each staining set.  

<br>

```{r SCC}

dt <- l4[,list(Barcode,Ligand,Spot_PA_SpotCellCountLog2LigandRLE,
               Spot_PA_SpotCellCountLog2RUV3LigandRLE,
               Spot_PA_SpotCellCountLog2RUV3LoessLigandRLE,
               Spot_PA_SpotCellCountLog2RUV3LoessRUV3LigandRLE,
               Spot_PA_SpotCellCountLog2RUV3LoessRUV3LoessLigandRLE)]

dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Spot_PA_SpotCellCountLog2LigandRLE","Spot_PA_SpotCellCountLog2RUV3LigandRLE","Spot_PA_SpotCellCountLog2RUV3LoessLigandRLE","Spot_PA_SpotCellCountLog2RUV3LoessRUV3LigandRLE","Spot_PA_SpotCellCountLog2RUV3LoessRUV3LoessLigandRLE"), variable.name = "Processed",value.name = "SpotCellCountLog2LigandRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3LigandRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"
dt$Processed[grepl("RUV3LoessRUV3LigandRLE$",dt$Processed)] <- "RUV3LoessRUV3 RLE"
dt$Processed[grepl("RUV3LoessRUV3Loess",dt$Processed)] <- "RUV3LoessRUV3Loess RLE"


p <- ggplot(dt, aes(x = factor(Ligand), y = SpotCellCountLog2LigandRLE, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by Ligand at Each Normalization Stage (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(dt[grepl("FBS", dt$Ligand),], aes(x = factor(Ligand), y = SpotCellCountLog2LigandRLE, colour = Processed))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by Ligand at Each Normalization Stage (FBS wells Only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(dt[!grepl("FBS", dt$Ligand),], aes(x = factor(Ligand), y = SpotCellCountLog2LigandRLE, colour = Processed))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by Ligand at Each Normalization Stage (Ligand wells Only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

dt <- l4[,list(Barcode,ECMp,Spot_PA_SpotCellCountLog2ECMpRLE, Spot_PA_SpotCellCountLog2RUV3ECMpRLE, Spot_PA_SpotCellCountLog2RUV3LoessECMpRLE,Spot_PA_SpotCellCountLog2RUV3LoessRUV3ECMpRLE, Spot_PA_SpotCellCountLog2RUV3LoessRUV3LoessECMpRLE  )]
dt <- melt(dt,id.vars=c("Barcode","ECMp"),measure.vars=c("Spot_PA_SpotCellCountLog2ECMpRLE","Spot_PA_SpotCellCountLog2RUV3ECMpRLE","Spot_PA_SpotCellCountLog2RUV3LoessECMpRLE","Spot_PA_SpotCellCountLog2RUV3LoessRUV3ECMpRLE","Spot_PA_SpotCellCountLog2RUV3LoessRUV3LoessECMpRLE"), variable.name = "Processed",value.name = "SpotCellCountLog2ECMpRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3ECMpRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"
dt$Processed[grepl("RUV3LoessRUV3ECMpRLE$",dt$Processed)] <- "RUV3LoessRUV3 RLE"
dt$Processed[grepl("RUV3LoessRUV3Loess",dt$Processed)] <- "RUV3LoessRUV3Loess RLE"

p <- ggplot(dt, aes(x = factor(ECMp), y = SpotCellCountLog2ECMpRLE))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by ECM Protein at Each Normalization Stage (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(ECMp), y = SpotCellCountLog2ECMpRLE, colour=Processed))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by ECM Protein at Each Normalization Stage (full dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

```


```{r log2AreaBoxplotsControlsOnly, eval=any(grepl("Nuclei_CP_AreaShape_AreaLog2",colnames(l4)))&!PCAOnly}

dt <- l4[grepl("FBS",l4$Ligand),list(Barcode,Ligand,Nuclei_CP_AreaShape_AreaLog2LigandRLE,
                                     Nuclei_CP_AreaShape_AreaLog2RUV3LigandRLE,
                                     Nuclei_CP_AreaShape_AreaLog2RUV3LoessLigandRLE,
                                     Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3LigandRLE,
                                     Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3LoessLigandRLE)]

dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Nuclei_CP_AreaShape_AreaLog2LigandRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LigandRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessLigandRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3LigandRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3LoessLigandRLE"), variable.name = "Processed",value.name = "AreaLog2LigandRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3LigandRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"
dt$Processed[grepl("RUV3LoessRUV3LigandRLE$",dt$Processed)] <- "RUV3LoessRUV3 RLE"
dt$Processed[grepl("RUV3LoessRUV3Loess",dt$Processed)] <- "RUV3LoessRUV3Loess RLE"

p <- ggplot(dt, aes(x = reorder(Barcode, AreaLog2LigandRLE, FUN=median), y = AreaLog2LigandRLE, colour = Ligand))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area(log2) RLE by Barcode (FBS wells only)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  guides(colour=guide_legend(ncol=3))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(Ligand), y = AreaLog2LigandRLE, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by Ligand (FBS wells only)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(Ligand), y = AreaLog2LigandRLE, colour = Processed))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by Ligand (FBS wells only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

dt <- l4[grepl("FBS",l4$Ligand),list(Barcode,ECMp,Nuclei_CP_AreaShape_AreaLog2ECMpRLE, Nuclei_CP_AreaShape_AreaLog2RUV3ECMpRLE, Nuclei_CP_AreaShape_AreaLog2RUV3LoessECMpRLE,Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3ECMpRLE, Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3LoessECMpRLE  )]
dt <- melt(dt,id.vars=c("Barcode","ECMp"),measure.vars=c("Nuclei_CP_AreaShape_AreaLog2ECMpRLE","Nuclei_CP_AreaShape_AreaLog2RUV3ECMpRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessECMpRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3ECMpRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3LoessECMpRLE"), variable.name = "Processed",value.name = "AreaLog2ECMpRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3ECMpRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"
dt$Processed[grepl("RUV3LoessRUV3ECMpRLE$",dt$Processed)] <- "RUV3LoessRUV3 RLE"
dt$Processed[grepl("RUV3LoessRUV3Loess",dt$Processed)] <- "RUV3LoessRUV3Loess RLE"

p <- ggplot(dt, aes(x = factor(ECMp), y = AreaLog2ECMpRLE))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by ECM Protein (FBS wells only)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(ECMp), y = AreaLog2ECMpRLE, colour=Processed))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by ECM Protein (FBS wells only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

```

###Correlation Across Staining Sets
The raw, RUV3 and RUV3Loess versions of the spot cell count signal for each staining set are plotted against each other to show the correlation of results at the MEP level.


```{r compareDatasetsSCC, fig.height=3, fig.width=3}

plotSSs <- function(dt, signalName){
  #Organize the normalized spot cell count by staining sets
  dtc <- dcast(dt,MEP~StainingSet,value.var=signalName)
  xlim<-quantile(c(dtc$SS1,dtc$SS2,dtc$SS3),probs = c(.01,.99), na.rm = TRUE)
  ylim<-xlim
  
  p <- ggplot(dtc,aes(x=SS1,y=SS2))+
    geom_point(size=rel(.5), alpha=.5)+
    geom_smooth(method = "lm")+
    coord_cartesian(xlim, ylim)+
    annotate("text", label=paste0("r=",round(cor(dtc$SS1,dtc$SS2,method = "pearson", use="complete.obs"),2)), x = xlim[1]+.1*xlim[2], y = xlim[2], size = rel(3), colour="red")+
    xlab(paste("SS1",signalName))+ylab(paste("SS2",signalName))+
    ggtitle(paste(signalName, "of SS2 vs SS1"))+
    theme(axis.title=element_text(size=rel(.5)),axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p)) 
  
  p <- ggplot(dtc,aes(x=SS2,y=SS3))+
    geom_point(size=rel(.5), alpha=.5)+
    geom_smooth(method = "lm")+
    coord_cartesian(xlim, ylim)+ 
    annotate("text",label=paste0("r=",round(cor(dtc$SS2,dtc$SS3,method = "pearson", use="complete.obs"),2)), x = xlim[1]+.1*xlim[2], y = xlim[2], size = rel(3), colour="red")+
    xlab(paste("SS2",signalName))+ylab(paste("SS3",signalName))+
    ggtitle(paste(signalName, "of SS3 vs SS2"))+
    theme(axis.title=element_text(size=rel(.5)),axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p)) 
  
  p <- ggplot(dtc,aes(x=SS1,y=SS3))+
    geom_point(size=rel(.5), alpha=.5)+
    geom_smooth(method = "lm")+
    coord_cartesian(xlim, ylim)+
    annotate("text",label=paste0("r=",round(cor(dtc$SS1,dtc$SS3,method = "pearson", use="complete.obs"),2)), x = xlim[1]+.1*xlim[2], y = xlim[2], size = rel(3), colour="red")+
    xlab(paste("SS1",signalName))+ylab(paste("SS3",signalName))+
    ggtitle(paste(signalName, "of SS3 vs SS1"))+
    theme(axis.title=element_text(size=rel(.5)),axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p)) 
}

tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2")
tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2RUV3")
tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2RUV3Loess")
tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2RUV3LoessRUV3")
tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess")
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3Loess")
# 
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3LoessRUV3Loess")
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3LoessRUV3Loess")
# 
# if(any(grepl("Nuclei_PA_AreaShape_EccentricityLogit", colnames(l4)))){
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogit")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3Loess")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3LoessRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3LoessRUV3Loess")
# }
# 
# if(any(grepl("Nuclei_CP_AreaShape_EccentricityLogit", colnames(l4)))){
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogit")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3Loess")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3LoessRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3LoessRUV3Loess")
# }
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogit")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3LoessRUV3Loess")

```

###Pseudo Images of SpotCellCount
The following plots show the raw and normalized Spot Cell Count values at the plate level for three replicate plates.  

```{r pseudoImages,  fig.width=3, fig.height=3.2}
create8WellPseudoImage <- function(DT, pr, prDisplay,highThresh = .99, lowThresh = .01){
  #find high ad low values
  highThreshValue<-quantile(DT[[pr]],probs = highThresh,na.rm=TRUE)
    lowThreshValue<-quantile(DT[[pr]],probs = lowThresh,na.rm=TRUE)
  p <- ggplot(DT, aes_string(x="ArrayColumn", y="ArrayRow",colour=pr))+
    geom_point(size=rel(.25))+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red", limits=c(lowThreshValue, highThreshValue), oob=squish)+
    guides(colour = guide_legend(prDisplay, keywidth = .5, keyheight = .5))+
    ggtitle(paste("\n\n",prDisplay,"for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),
          axis.title.x = element_text(size=rel(.5)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.4)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
}
 l3nn$Well_Ligand <- paste(l3nn$Well,l3nn$Ligand,sep="_")
 
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3","Spot_PA_SpotCellCountLog2RUV3Loess","Spot_PA_SpotCellCountLog2RUV3LoessRUV3","Spot_PA_SpotCellCountLog2RUV3LoessRUV3Loess")){
  
   p <- create8WellPseudoImage(l3nn[l3nn$Barcode==unique(l3nn$Barcode)[1],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
   p <- create8WellPseudoImage(l3nn[l3nn$Barcode==unique(l3nn$Barcode)[9],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
     p <- create8WellPseudoImage(l3nn[l3nn$Barcode==unique(l3nn$Barcode)[17],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
 
```
