---
title: MEP-LINCS MCF10A Population Class Analysis 
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8X00","",dt$Barcode), sep="_")
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle, xlim=NULL, ylim=NULL, colorByCtrls=TRUE, highlightName=NULL){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  
  if(is.null(highlightName)){
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
  } else {
    #Dim out all MEPs except the selected
    dimColour<-"cornflowerblue"
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
  }
  
  if(colorByCtrls){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
  }
  
  if(!is.null(highlightName)){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
  }
  
  print(p12)
  print(p23)
  print(p13)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}

shortenHA <- function(x){
  x$ECMp <- gsub("hyaluronicacid","HA",x$ECMp)
  x$ECMp <- gsub("lessthan","<",x$ECMp)
  x$ECMp <- gsub("greaterthan",">",x$ECMp)
  x$MEP <- paste(x$ECMp,x$Ligand,sep = "_")
  return(x)
}
#Add an index for the plate in the ligand set
addLigandPlate <- function(dt){
  
}
addOmeroIDs <- function(dt){
  if(any(grepl("^ImageID$",colnames(dt)))){
    dt <- dt[,OmeroDetailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroThumbnailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroImageURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',ImageID,'/"',' target="_blank">Omero</a>')]
  }
  return(dt)
}

create8WellPseudoImage <- function(DT, pr, prDisplay,highThresh = .99, lowThresh = .01, highThreshValue=NULL, lowThreshValue=NULL){
  #find high and low values
  if(is.null(highThreshValue)) highThreshValue<-quantile(DT[[pr]],probs = highThresh,na.rm=TRUE)
  if(is.null(lowThreshValue)) lowThreshValue<-quantile(DT[[pr]],probs = lowThresh,na.rm=TRUE)
  p <- ggplot(DT, aes_string(x="ArrayColumn", y="ArrayRow",colour=pr))+
    geom_point(size=rel(.25))+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red", limits=c(lowThreshValue, highThreshValue), oob=squish)+
    guides(colour = guide_legend(prDisplay, keywidth = .5, keyheight = .5))+
    ggtitle(paste("\n\n",prDisplay,"for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),
          axis.title.x = element_text(size=rel(.5)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.4)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
}
medianSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMedians <- dtKeep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMedians)
}

meanSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMeans)
}

meanSummarizel3 <- function(dt){
  #median summarize the Spot replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|PrintSpot|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well,PrintSpot"]
  return(dtMeans)
}

numericMean <- function(x){
  as.numeric(mean(x, na.rm=TRUE))
}

btLogit <- function(x){
  2^x/(1+2^x)
}

#Given a vector of values, return a factor vector of the same
#length with Low values for the smallest 3 cells, 
#High for the biggest three and Middle for the rest
classifySCC <- function(x){
  xf <- factor(rep("Middle",length(x)),levels=c("Low","Middle","High"), ordered=TRUE)
  y <- order(x)
  xNr <- length(x)
  if (xNr==1){
    xf<-"Middle"
  } else if(xNr<6) {
    mid <- ceiling(xNr/2)
    xf[y[1:mid]]<- "Low"
    xf[y[(mid+1):xNr]] <- "High"
  } else{
      xf[y[1:3]] <- "Low"
  xf[y[(xNr-2):xNr]] <- "High"
  }
  return(xf)
}


#Given a vector of values, return a factor vector of the same
#length with Q1, Q2, Q3 and Q4 values for the four quartile bins. 
classifySCCQuartiles <- function(x){
  xf <- factor(rep("Q1",length(x)),levels=c("Q1","Q2","Q3","Q4"), ordered=TRUE)
  xNr <- length(x)
  qs <- quantile(x, probs=c(.25, .5, .75))
  xf[x<=qs[1]] <- "Q1"
  xf[qs[1]<x&x<=qs[2]] <- "Q2"
  xf[qs[2]<x&x<=qs[3]] <- "Q3"
  xf[qs[3]<x] <- "Q4"
  return(xf)
}
```



```{r setup}

library("ggplot2")
library(scales)
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
#library(corrplot)
library(RUVnormalize)
library(ruv)
library(Rtsne)
library(XLConnect)


#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol <- selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

cellLine <- "MCF10A"
stainingSets <- c("SS1", "SS2", "SS3")

PCAOnly <- TRUE
if(cellLine=="MCF10A"){
  ssNr <- 3
} else {
  ssNr <- 2
}

#Read in the data.table that holds every spot in the cell line
#and can be used to index to the images
l3L <- lapply(stainingSets, function(ss){
  dt <- fread(paste0("../AnnotatedData/",cellLine,"_",ss,"_Level3.txt"),verbose = FALSE,showProgress = FALSE)
  dt$StainingSet <- ss
  return(dt)
  })
  
l3 <-rbindlist(l3L, use.names=TRUE, fill=TRUE)

l3 <- l3[,SCCClass := classifySCC(Spot_PA_SpotCellCount), by=c("Barcode","MEP")]
l3 <- l3[,SCCQuartile := classifySCCQuartiles(Spot_PA_SpotCellCount)]
l3$SCCBMPQuartile <- factor("Q0",levels=c("Q0","Q1","Q2","Q3","Q4"), ordered=TRUE)
l3$SCCBMPQuartile[grepl("SS2",l3$StainingSet)&grepl("BMP|FBS_P5",l3$Ligand)] <- classifySCCQuartiles(l3$Spot_PA_SpotCellCount[grepl("SS2",l3$StainingSet)&grepl("BMP|FBS_P5",l3$Ligand)])
```



###Population Classification Boxplots. The Population Classes Low, Middle and High are based on the raw spot cell counts of each set of replicate MEPs. The three least populated spots are Low, the three most populated spots are High and the rest are Middle.

```{r SCCBoxplotsFull, fig.width=4, fig.height=4}
dt <- l3[grepl("SS2",l3$StainingSet),]

p <- ggplot(dt, aes(x=SCCClass, y=Spot_PA_SpotCellCountLog2))+
  geom_boxplot()+
  guides(fill=FALSE, colour=FALSE)+
  xlab("Spot Cell Count Class")+ylab("Spot Cell Count (log2)")+
  ggtitle("Spot Cell Count by Population Class")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.1)
print(p)


```

***
These boxplots show the values and distributions of the spots in the three population classes. The colors are the ECM protein.

###Normalized EdU+ Proportion by Population Class. These boxplots summarize the proliferation of all spots stratified by population class.

```{r EdUPopBoxplots, fig.width=12, fig.height=5}

dt <- l3[grepl("SS2",l3$StainingSet),]

p <- ggplot(dt, aes(x=SCCClass, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)))+
  geom_boxplot()+
  guides(fill=FALSE, colour=FALSE)+
  xlab("Spot Cell Count Class")+ylab("EdU+ Proportion (Normalized)")+
  ggtitle("Proliferation by Population Class")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.1)
print(p)
```

***
The Edu+ proportion is RUV then loess normalized to remove spatial artifacts.

###Raw EdU+ Proportion by Population Class . These boxplots summarize the raw proliferation values of all spots stratified by population class.

```{r EdURawPopBoxplots, fig.width=12, fig.height=5}

dt <- l3[grepl("SS2",l3$StainingSet),]

p <- ggplot(dt, aes(x=SCCClass, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit)))+
  geom_boxplot()+
  guides(fill=FALSE, colour=FALSE)+
  xlab("Spot Cell Count Class")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by Population Class")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.1)
print(p)
```

***


###Raw EdU+ Proportion by Ligand and Population Class . These boxplots summarize the raw proliferation values of all spots stratified by ligand and population class.

```{r EdULigandPopBoxplots, fig.width=20, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet),]

p <- ggplot(dt, aes(x=SCCClass, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot()+
  coord_cartesian(ylim=c(0,.6))+
  facet_wrap(~Ligand)+
  guides(colour=FALSE)+
  xlab("Spot Cell Count Class")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by Population Class")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.1)
print(p)
```

***

###Raw EdU+ Proportion by ECM Protein and Ligand for the Low Population Class . 

```{r EdULigandLowPopBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Low",l3$SCCClass),]

p <- ggplot(dt, aes(x=ECMp, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot()+
  coord_cartesian(ylim=c(0,.6))+
  facet_wrap(~Ligand, ncol=10)+
  guides(colour=FALSE)+
  xlab("ECM Protein")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by ECM Protein and Ligand in the Low Population Class")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.4)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

print(p)
```

***

###Raw EdU+ Proportion by ECM Protein and Ligand for the Low Population Class in BMP MEPs. 

```{r EdULigandLowPopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Low",l3$SCCClass)&grepl("BMP",l3$MEP),]

p <- ggplot(dt, aes(x=ECMp, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  facet_wrap(~Ligand, ncol=2)+
  guides(colour=FALSE)+
  xlab("ECM Protein")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by ECM Protein and Ligand in the Low Population Class of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(size=rel(2),alpha=1)

print(p)
```

***


###Raw EdU+ Proportion by ECM Protein and Ligand for the High Population Class in BMP MEPs. 

```{r EdULigandHighPopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("High",l3$SCCClass)&grepl("BMP",l3$MEP),]

p <- ggplot(dt, aes(x=ECMp, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  facet_wrap(~Ligand, ncol=2)+
  guides(colour=FALSE)+
  xlab("ECM Protein")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by ECM Protein and Ligand in the High Population Class of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(size=rel(2),alpha=1)

print(p)
```

***



###Raw EdU+ Proportion by Ligand and ECM for the Q1 Population Class in BMP MEPs. 

```{r EdULigandECMpQ1PopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Q[1]",l3$SCCBMPQuartile),]

p <- ggplot(dt, aes(x=ECMp, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  facet_wrap(~Ligand, ncol=2)+
  guides(colour=FALSE)+
  xlab("ECM Protein")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by ECM Protein and Ligand in the Q1 Population Class of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(size=rel(2),alpha=1)

print(p)
```

***

###Raw EdU+ Proportion by Ligand and ECM for the Q4 Population Class in BMP MEPs. 

```{r EdULigandECMQ4PopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Q4",l3$SCCBMPQuartile),]

p <- ggplot(dt, aes(x=ECMp, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  facet_wrap(~Ligand, ncol=2)+
  guides(colour=FALSE)+
  xlab("ECM Protein")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by ECM Protein and Ligand in the Q4 Population Class of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(size=rel(2),alpha=1)

print(p)
```

***



###Raw EdU+ Proportion by Ligand for the Q1 Population Class in BMP MEPs. 

```{r EdULigandQ1PopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Q[1]",l3$SCCBMPQuartile),]

p <- ggplot(dt, aes(x=Ligand, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  guides(colour=FALSE)+
  xlab("Ligand")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by Ligand in the Q1 Population Class of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(size=rel(2),alpha=1)

print(p)
```

***
The Q1-Q4 populations in the BMP MEPs are the 1st through 4th quartiles based on the spot cell count for all spots in the six BMP wells. 

###Raw EdU+ Proportion by Ligand for the Q4 Population Class in BMP MEPs. 

```{r EdULigandQ4PopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Q4",l3$SCCBMPQuartile),]

p <- ggplot(dt, aes(x=Ligand, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=Barcode))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  guides(colour=FALSE)+
  xlab("Ligand")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by Ligand in the Q4 Population Class of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(size=rel(2),alpha=1)

print(p)
```

***
The Q1-Q4 populations in the BMP MEPs are the 1st through 4th quartiles based on the spot cell count for all spots in the six BMP wells. 

###Raw EdU+ Proportion by Ligand for the Q1 throughQ4 Population Class in BMP MEPs. 

```{r EdULigandQ14PopBMPBoxplots, fig.width=30, fig.height=12}

dt <- l3[grepl("SS2",l3$StainingSet)&grepl("Q[1234]",l3$SCCBMPQuartile),]

p <- ggplot(dt, aes(x=Ligand, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogit), fill=SCCBMPQuartile))+
  geom_boxplot(alpha=.3)+
  coord_cartesian(ylim=c(0,.6))+
  #guides(colour=FALSE)+
  xlab("Ligand")+ylab("EdU+ Proportion (raw)")+
  ggtitle("Proliferation by Ligand in the Population Classes of BMP MEPs")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))


print(p)
```

***
The Q1-Q4 populations in the BMP MEPs are the 1st through 4th quartiles based on the spot cell count for all spots in the six BMP wells. 
