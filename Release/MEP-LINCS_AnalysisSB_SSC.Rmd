---
title: MEP-LINCS `r cellLine` Cell Line Analysis 
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8X00","",dt$Barcode), sep="_")
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle, xlim=NULL, ylim=NULL, colorByCtrls=TRUE, highlightName=NULL){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  
  if(is.null(highlightName)){
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
  } else {
    #Dim out all MEPs except the selected
    dimColour<-"cornflowerblue"
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
  }
  
  if(colorByCtrls){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
  }
  
  if(!is.null(highlightName)){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
  }
  
  print(p12)
  print(p23)
  print(p13)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}

shortenHA <- function(x){
  x$ECMp <- gsub("hyaluronicacid","HA",x$ECMp)
  x$ECMp <- gsub("lessthan","<",x$ECMp)
  x$ECMp <- gsub("greaterthan",">",x$ECMp)
  x$MEP <- paste(x$ECMp,x$Ligand,sep = "_")
  return(x)
}
#Add an index for the plate in the ligand set
addLigandPlate <- function(dt){
  
}
addOmeroIDs <- function(dt){
  if(any(grepl("^ImageID$",colnames(dt)))){
    dt <- dt[,OmeroDetailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroThumbnailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroImageURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',ImageID,'/"',' target="_blank">Omero</a>')]
  }
  return(dt)
}

create8WellPseudoImage <- function(DT, pr, prDisplay,highThresh = .99, lowThresh = .01, highThreshValue=NULL, lowThreshValue=NULL){
  #find high and low values
  if(is.null(highThreshValue)) highThreshValue<-quantile(DT[[pr]],probs = highThresh,na.rm=TRUE)
  if(is.null(lowThreshValue)) lowThreshValue<-quantile(DT[[pr]],probs = lowThresh,na.rm=TRUE)
  p <- ggplot(DT, aes_string(x="ArrayColumn", y="ArrayRow",colour=pr))+
    geom_point(size=rel(.25))+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red", limits=c(lowThreshValue, highThreshValue), oob=squish)+
    guides(colour = guide_legend(prDisplay, keywidth = .5, keyheight = .5))+
    ggtitle(paste("\n\n",prDisplay,"for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),
          axis.title.x = element_text(size=rel(.5)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.4)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
}
medianSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMedians <- dtKeep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMedians)
}

meanSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMeans)
}

meanSummarizel3 <- function(dt){
  #median summarize the Spot replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|PrintSpot|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well,PrintSpot"]
  return(dtMeans)
}

numericMean <- function(x){
  as.numeric(mean(x, na.rm=TRUE))
}

btLogit <- function(x){
  2^x/(1+2^x)
}
```



```{r setup}

library("ggplot2")
library(scales)
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
#library(corrplot)
library(RUVnormalize)
library(ruv)
library(Rtsne)
library(XLConnect)


#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol <- selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

PCAOnly <- TRUE
if(cellLine=="MCF10A"){
  ssNr <- 3
} else {
  ssNr <- 2
}

#Read in the data.table that holds every spot in the cell line
#and can be used to index to the images
l3C <- fread(unique(paste0("../AnnotatedData/",cellLine, "_SSC","_Level3.txt")), showProgress = FALSE)
#Add backtransformed values for some logit transformed signals
l3C <- l3C[,Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoess)]
l3C <- l3C[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)]

#Read in the MEP-Level datasset for the cell line
l4C <- fread(unique(paste0("../AnnotatedData/",cellLine, "_SSC","_Level4.txt")), showProgress = FALSE)

#Add backtransformed values for some logit transformed signals
l4C <- l4C[,Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoess)]
l4C <- l4C[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)]


```

###Introduction
This analysis is of the MEP-LINCS `r cellLine`  MEMA experiments performed in eight well plates. The data is collected at the cell level from images captured on an automated Nikon microscope. The cell level data is summarized for each MEMA spot, RUV and loess normalized, then replicate spots are summarized to the MEP level.  

The MEP-level dataset is stored and manipulated as a matrix where each of the `r dim(l4C)[1]` rows are a unique MEP and each of the `r dim(l4C)[2]` columns are signals or metadata. Some signals are based on the DAPI staining that is present in all wells. This creates `r ssNr` replicate ligand wells which each have ~fourteen replicates of spotted ECM proteins. The rest of the signals are based on unique stains and the ~fourteen replicate spots are all in the same well. It's important to note that the MEP level data comes from `r ssNr` different experiments run over several weeks.

The Spot-level dataset is a matrix where each of the `r dim(l3C)[1]` rows is a spot and each of the `r dim(l3C)[2]` columns are signals or metadata. The spot level data is a sparse matrix where the each row has values from one staining set and NA values for the other.

###The cell cycle boxplots are based on gating the cells on their total DAPI signals into 2N or 4N classes. 


```{r CellCycleBoxplots, fig.width=12, fig.height=5}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-3,0))+
  xlab("Ligand")+ylab("Normalized DNA4N")+
  ggtitle("MEP DNA4N Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)
```

***
This data is RUV and loess normalized and then summarized across all staining sets where each ligand has `r ssNr` replicates and there are 16 control wells. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

###Proliferation Boxplots


```{r EdUBoxplotsFull, fig.width=12, fig.height=5}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)


```

***
These boxplots show the RUV and loess normalized MEP level data for the gated EdU+ proliferation signal stratifed by the ligands. The BMP values are highlighted as these are part of the validation datasets. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

###Spot Cell Count boxplots based on the DAPI signals in all wells. 


```{r SCCBoxplots, fig.width=12, fig.height=5}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Spot_PA_SpotCellCountLog2RUVLoess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Spot_PA_SpotCellCountLog2RUVLoess, FUN=median), y=Spot_PA_SpotCellCountLog2RUVLoess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized Spot Cell Count\n(Log2)")+
  ggtitle("MEP Spot Cell Count Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)
```

***
This data is RUV and loess normalized and then summarized across all staining sets where each ligand has `r ssNr` replicates and there are `r ssNr*8` control wells. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

###MEP Level interactive datatable displays data filtered on keywords and sorted by values.


```{r datatable}

colNames <- c("MEP","Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed", "Spot_PA_SpotCellCountLog2RUVLoess", "Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed","Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUVLoess")
colNamesDisplay <- c("MEP","Normed EdU+ Prop.","Normed SCC (log2)","Normed DNA 4N Prop.", "Normed KRT5", "Normed MitoTracker")

dt <- setorder(dt,Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed)
datatable(format(dt[, colNames, with=FALSE], digits=3, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)
```

###The Spot Level Interactive Datatable can be filtered on keywords and sorted by values. Each spot's image is displayed by clicking on the Omero link (OHSU Gray Lab Omero account needed).  

```{r}
#Setup for spots to display images
dt <- l3C[!grepl("NID1|ELN",l3C$ECMp),]
colNamesSpots <- c(colNames[1],"Barcode","Well","ArrayRow","ArrayColumn","OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"Barcode","Well","ArrayRow","ArrayColumn","Image Link",colNamesDisplay[2:length(colNamesDisplay)])
dt <- setorder(dt, -Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=3, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```

###KRT5 Intensity Lineage Boxplots


```{r KRT5BoxplotsFull, fig.width=20, fig.height=8}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("MEP Cytoplasmic KRT5 Median Intensity by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)

```

***
The boxplots show the RUV and loess normalized MEP level data for the KRT5 and KRT19 cytoplasmic median intensity signal stratifed by the ligands.  

###KRT19 Intensity Lineage Boxplots


```{r KRT19BoxplotsFull, fig.width=20, fig.height=8}

textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUVLoess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUVLoess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUVLoess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT19 Intensity\n(Log2)")+
  ggtitle("Cytoplasmic KRT19 Intensity by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)
```

###KRT19 Gated Proportions Boxplots

```{r gatedKRT19Boxplots, fig.width=20, fig.height=8}
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess), FUN=median), y=btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess), fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT19 Proportion")+
  ggtitle("Proportion of KRT19 High by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)


```

***
The KRT19 Gated Proportion signal is the porportion of cells in each spot that were in the KRT19 high gate. The gate threshold is automatically determined by kmeans clustering (k=2) the median KRT19 intensity of all cells in each plate.  

###Proliferation vs Spot Cell Count Scatterplot


```{r, fig.width=20, fig.height=8}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=.7, alpha=.4)+
  guides(colour=FALSE, size=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Spot Cell Count (raw)")+ylab("EdU+ Proportion (Normalized)")+
  ggtitle("Proliferation vs. Cell Count (raw)")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
ggplotly(p)


```

***

These figure shows the proportion of cells in S phase during the last hour of the experiment vs the raw cell count.


###Lineage vs. Proliferation Scatterplot


```{r, fig.width=10, fig.height=7, eval=TRUE}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
p <- ggplot(dt, aes(x=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), y=btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess), colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=.7, alpha=.4)+
  guides(colour=FALSE, size=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Normalized EdU+")+ylab("Normalized KRT19+")+
  ggtitle("MEP KRT19 vs Proliferation")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
ggplotly(p)

```

***
This scatter plot shows the normalized KRT19+ proportion vs. the normalized EdU+ measured proliferation. The colors represent the ligands. The ECM protein is displayed in the tool tip box that appears while hovering over a spot.  

```{r, fig.width=10, fig.height=7, eval=FALSE}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
p <- ggplot(dt, aes(x=factor(ECMp), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUVLoess, colour=Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess< (-.5), size=Spot_PA_SpotCellCountLog2, text=paste("ECMp:",ECMp)))+
  geom_boxplot()+
  guides(colour=FALSE, size=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("ECMp")+ylab("Normalized KRT5 Intensity")+
  ggtitle("MEP KRT19 vs Proliferation")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

```


```{r PCAData}
###PCA Unbiased Analysis  

#Get a PCA model from the raw data
rawFVNames <- grep("Log2|Logit", grep("ECMp|Ligand|MEP|Barcode|Well|StainingSet|Loess|RUV",colnames(l4C),invert = TRUE, value = TRUE), value=TRUE)
rawPCAModel <- createPCAModel(dt=l4C, fvNames = rawFVNames)

#Get a PCA model from the RUV data
RUVNames <- grep("Loess",grep("Log2RUV$|LogitRUV$",colnames(l4C), value=TRUE),value=TRUE,invert=TRUE)
RUVPCAModel <- createPCAModel(dt=l4C, fvNames = RUVNames)

#Get a PCA model from the RUVLoess data
RUVLoessNames <- grep("LoessRUV",grep("Log2RUVLoess$|LogitRUVLoess$",colnames(l4C), value=TRUE), value=TRUE, invert=TRUE)
RUVLoessPCAModel <- createPCAModel(dt=l4C, fvNames = RUVLoessNames)

#Get a PCA model from the RUVLoess of all signals
RUVLoessMEPNames <- grep("LoessRUV",grep("Log2RUVLoess$|LogitRUVLoess$",colnames(l4C), value=TRUE), value=TRUE, invert=TRUE)
RUVLoessMEPPCAModel <- createPCAModel(dt=l4C, fvNames = RUVLoessMEPNames)

RUVLoessMEPFBSPCAModel <- createPCAModel(dt=l4C, fvNames = RUVLoessMEPNames)


```

###PCA of All MEP Signals


```{r, fig.height=2, fig.width=3}
xlim<-c(-15,15)
ylim<-c(-10,10)
dt <- cbind(data.table(RUVLoessMEPFBSPCAModel$x),Ligand=l4C$Ligand, MEP=l4C$MEP, ECMp=l4C$ECMp)

p12 <- ggplot(dt, aes(x = PC1, y = PC2, colour = Ligand)) +
      geom_point(size = rel(.6), alpha = .4) +
      labs(colour = "Ligand")+
      ggtitle("PCA of All MEP Signals")+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
ggplotly(p12)

```

***
The scatterplot shows the first 2 principal components of all MEP signals, colored by ligand. Hovering over a spot shows its ligand and ECM protein. Below are the signals used in the MEP PCA model. 

`r RUVLoessMEPNames ` 


###MEP PCA Datatable enables sorting MEPs by their principal component values.

```{r MEPPCADatatable}

colNames <- c("MEP","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9")
colNamesDisplay <- c("MEP","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9")

dt <- setorder(dt,PC1)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

```


```{r tSNEFBS_Data}
#Need to remove FBS entries that are duplicated after normalization
l4C$Ligand <- sub("FBS.*","FBS",l4C$Ligand)
l4C$MEP <- sub("FBS.*","FBS",l4C$MEP)
l4CU <- unique(l4C)
data_matrix <- scale(as.matrix(l4CU[,RUVLoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4CU <- cbind(l4CU,data_tsne$Y)

```

###tSNE plot of all MEP Signals

```{r plottSNELigandFBSU,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4CU, aes(x=V1, y=V2, colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=rel(.3), alpha=.5)+
  ggtitle(paste("tSNE plot of", cellLine,"MEPs with FBS Coloured by Ligand"))+
  guides(colour = FALSE)
ggplotly(p)

```

***
The scatterplot shows the 2 tSNE components of all MEP signals colored by ligand. Hovering over a spot shows its ligand and ECM protein. The signals are the same as those used in the MEP PCA model.


```{r tSNEData,fig.width=8, fig.height=5, eval=FALSE}
data_matrix <- scale(as.matrix(l4C[,RUVLoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15)
l4C <- cbind(l4C,data_tsne$Y)
```

###Spot Level Proliferation Responses


```{r, fig.width=20, fig.height=8}
dt <- l3C[grepl("BMP",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("Spot level EdU+ Response by ECMp")+
  facet_wrap(~Ligand, ncol=3)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter(aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```

***

These boxplots show the proliferation values for the replicate ECM protein spots paired with the BMP family of ligands.



###Spot Level KRT19 Responses

```{r, fig.width=20, fig.height=8}
dt <- l3C[grepl("BMP",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess), FUN=median), y=btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUVLoess)))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized KRT19+")+
  ggtitle("Spot level KRT19+ by ECMp")+
  facet_wrap(~Ligand, ncol=3)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```

***

These boxplots show the gated KRT19 high proportion values for the replicate ECM protein spots paired with the BMP family of ligands.

###DAPI DNA Cell Cycle

```{r, fig.width=20, fig.height=8}
dt <- l3C[grepl("BMP",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUVLoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized DNA4N\n(Logit)")+
  ggtitle("Spot level DNA4N Response by ECMp")+
  facet_wrap(~Ligand, ncol=3)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```

***

These boxplots show the cell cycle proportions as measured by total DAPI for the replicate ECM protein spots paired with the BMP family of ligands.


###Clustered Spot Cell Count Heatmap
 


```{r medianHeatMaps2, fig.width=9, fig.height=5.5}

limits=c(.05, .95)
titleExpression <-"Raw Spot Cell Count (log2)"
plotLEHmap(l4C,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)
```

***
This heatmap uses unsupervised clustering in the rows and columns using the complete linkage method which finds similar clusters. These maps use three colors to highlight the data sturcture however the white color is merely the center of the data, it does not have specific biological meaning. 

###Clustered Normalized Spot Cell Count Heatmap

```{r}
limits=c(.05, .95)
titleExpression <-"Normalized Spot Cell Count (log2)"
plotLEHmap(l4C, hclustfun = "hclust", fill="Spot_PA_SpotCellCountLog2RUVLoess", titleExpression=titleExpression, limits=limits)

```

***
This heatmap uses unsupervised clustering in the rows and columns using the complete linkage method which finds similar clusters. These maps use three colors to highlight the data sturcture however the white color is merely the center of the data, it does not have specific biological meaning. 