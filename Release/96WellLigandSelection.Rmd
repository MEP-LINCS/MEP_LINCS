---
title: 96 Well Ligand Selection 
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)
```


```{r , cache=FALSE}
#Author: Mark Dane, copyright 2015
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)
library(magrittr)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

datasetName <- "MCF10A_DMSO_2"

l4 <- fread(paste0("/lincs/share/lincs_user/",datasetName,"/Annotated/",datasetName,"_Level4.tsv"), showProgress = FALSE)

l4f <- l4[grepl("NID1|COL1|FN1",l4$ECMp),]
  
```



###Spot Cell Count and Proliferation in the `r datasetName` dataset



```{r SCCBoxplotsbyLigand, fig.height=3}

p <- ggplot(l4f, aes(x=factor(Ligand), y=2^Spot_PA_SpotCellCountLog2RUVLoess, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,500))+
  labs(x="Ligand",y="Spot Cell Count",colour="Barcode", title="Spot Cell Count by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(2^l4f$Spot_PA_SpotCellCountLog2RUVLoess), colour="blue", alpha=.5)
print(p)

p <- ggplot(l4f, aes(x=factor(Ligand), y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,.5))+
  labs(x="Ligand",y="EDU+ Proportion",colour="Barcode", title="Proliferation by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(btLogit(l4f$Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)), colour="blue", alpha=.5)
print(p)

p <- ggplot(l4f, aes(x=reorder(factor(Ligand),Spot_PA_SpotCellCountLog2RUVLoess,fun=median), y=2^Spot_PA_SpotCellCountLog2RUVLoess, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,500))+
  labs(x="Ligand",y="Spot Cell Count",colour="Barcode", title="Spot Cell Count by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(2^l4f$Spot_PA_SpotCellCountLog2RUVLoess), colour="blue", alpha=.5)
print(p)

p <- ggplot(l4f, aes(x=reorder(factor(Ligand),Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess,fun=median), y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,.5))+
  labs(x="Ligand",y="EDU+ Proportion",colour="Barcode", title="Proliferation by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(btLogit(l4f$Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)), colour="blue", alpha=.5)
print(p)


```

***
The data is filtered down to MEPs that contain `r unique(l4f$ECMp)` as these match the ECM proteins in the 96 well development plates. The normalized Spot Cell Count and EdU+ proliferation boxplots are shown in these figures.


###Proliferation vs Cell Count Colored by ECM Protein


```{r, fig.width=7, fig.height=7}

 
p <- ggplot(l4f, aes(x=2^Spot_PA_SpotCellCountLog2RUVLoess, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), label=Ligand, colour=ECMp))+
  geom_point(size=rel(1), alpha=.9)+
  ggtitle(paste("Proliferation vs. Density"))+
  ylab("EdU+ Proportion")+
  xlab("Spot Cell Count")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)))
ggplotly(p)

```

***
This interactive plot will show the ECM protein and ligand by hovering the cursor over any dot.


###Proliferation vs Cell Count Colored by Ligand


```{r, fig.width=7, fig.height=7}


p <- ggplot(l4f, aes(x=2^Spot_PA_SpotCellCountLog2RUVLoess, y=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), label=ECMp, colour=Ligand))+
  geom_point(size=rel(1), alpha=.9)+
  ggtitle(paste("Proliferation vs. Density"))+
  ylab("EdU+ Proportion")+
  xlab("Spot Cell Count")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)))
ggplotly(p)

```

***
This interactive plot will show the ECM protein and ligand by hovering the cursor over any dot.



###Cell Cycle



```{r CellCycleBoxplots, fig.height=3}

p <- ggplot(l4f, aes(x=factor(Ligand), y=btLogit(Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess), colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,1))+
  labs(x="Ligand",y="DNA 2n Proportion",colour="Barcode", title="Cell Cycle by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l4f$Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess), colour="blue", alpha=.5)
print(p)


p <- ggplot(l4f, aes(x=reorder(factor(Ligand),Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess,fun=median), y=btLogit(Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess), colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(ylim = c(0,1))+
  labs(x="Ligand",y="DNA 2n Proportion",colour="Barcode", title="Cell Cycle by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(btLogit(l4f$Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess)), colour="blue", alpha=.5)
print(p)


```

***
2n and 4n are based on the total DAPI intensity.


###Cell Cycle vs Cell Count Colored by ECM Protein


```{r, fig.width=7, fig.height=7}

 
p <- ggplot(l4f, aes(x=2^Spot_PA_SpotCellCountLog2RUVLoess, y=btLogit(Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess), label=Ligand, colour=ECMp))+
  geom_point(size=rel(1), alpha=.9)+
  ggtitle(paste("Cell Cycle vs. Density"))+
  ylab("DNA 2n Proportion")+
  xlab("Spot Cell Count")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)))
ggplotly(p)

```

***
This interactive plot will show the ECM protein and ligand by hovering the cursor over any dot.



###Cell Cycle vs Proliferation Colored by ECM Protein


```{r, fig.width=7, fig.height=7}

 
p <- ggplot(l4f, aes(x=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess), y=btLogit(Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess), label=Ligand, colour=ECMp))+
  geom_point(size=rel(1), alpha=.9)+
  ggtitle(paste("Cell Cycle vs. Proliferation"))+
  ylab("DNA 2n Proportion")+
  xlab("EdU+ Proportion")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)))
ggplotly(p)

```

***
This interactive plot will show the ECM protein and ligand by hovering the cursor over any dot.
