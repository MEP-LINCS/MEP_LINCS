
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8X00","",dt$Barcode), sep="_")
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle, xlim=NULL, ylim=NULL, colorByCtrls=TRUE, highlightName=NULL){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  
  if(is.null(highlightName)){
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
  } else {
    #Dim out all MEPs except the selected
    dimColour<-"cornflowerblue"
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
  }
  
  if(colorByCtrls){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
  }
  
  if(!is.null(highlightName)){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
  }
  
  print(p12)
  print(p23)
  print(p13)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}

shortenHA <- function(x){
  x$ECMp <- gsub("hyaluronicacid","HA",x$ECMp)
  x$ECMp <- gsub("lessthan","<",x$ECMp)
  x$ECMp <- gsub("greaterthan",">",x$ECMp)
  x$MEP <- paste(x$ECMp,x$Ligand,sep = "_")
  return(x)
}

addOmeroIDs <- function(dt){
  if(any(grepl("^ImageID$",colnames(dt)))){
    dt <- dt[,OmeroDetailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroThumbnailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroImageURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',ImageID,'/"',' target="_blank">Omero</a>')]
  }
  return(dt)
}

addLigandPlate <- function(dt){
  barcodeFBS <- unique(dt[grepl("FBS",dt$Ligand),list(Barcode,Ligand)])
  barcodeFBS$LigandPlate <- sub(".*_","",barcodeFBS$Ligand)
  barcodeFBS <- barcodeFBS[,Ligand :=NULL]
  barcodeLigandPlate <- merge(dt,barcodeFBS,by="Barcode")
}

create8WellPseudoImage <- function(DT, pr, prDisplay,highThresh = .99, lowThresh = .01, highThreshValue=NULL, lowThreshValue=NULL){
  #find high and low values
  if(is.null(highThreshValue)) highThreshValue<-quantile(DT[[pr]],probs = highThresh,na.rm=TRUE)
  if(is.null(lowThreshValue)) lowThreshValue<-quantile(DT[[pr]],probs = lowThresh,na.rm=TRUE)
  p <- ggplot(DT, aes_string(x="ArrayColumn", y="ArrayRow",colour=pr))+
    geom_point(size=rel(.25))+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red", limits=c(lowThreshValue, highThreshValue), oob=squish)+
    guides(colour = guide_legend(prDisplay, keywidth = .5, keyheight = .5))+
    ggtitle(paste("\n\n",prDisplay,"for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),
          axis.title.x = element_text(size=rel(.5)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.4)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
}
medianSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMedians <- dtKeep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMedians)
}

meanSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMeans)
}

meanSummarizel3 <- function(dt){
  #median summarize the Spot replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|PrintSpot|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well,PrintSpot"]
  return(dtMeans)
}

numericMean <- function(x){
  as.numeric(mean(x, na.rm=TRUE))
}

btLogit <- function(x){
  2^x/(1+2^x)
}
```



```{r setup}

library("ggplot2")
library(scales)
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
#library(corrplot)
library(RUVnormalize)
library(ruv)
library(Rtsne)
library(XLConnect)

#Use x structure for future fleixbility
x <- data.frame(cellLine="HMEC240L",
                drug= "none",
                analysisVersion="av1.6",
                rawDataVersion="v2",
                stringsAsFactors = FALSE)
#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol <- selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
PCAOnly <- TRUE
cellLine <- x[["cellLine"]]

l3n <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l4 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

#Match the FBA wells up as replicates and change to common names
tmp <- l4[grepl("FBS",l4$Ligand),]
suffixes <- sort(sub("FBS","",unique(tmp$Ligand)))
replacements <- rep(paste0("_P",1:8), times=3)
for(i in 1:16){
  l4$MEP[grepl(suffixes[i],l4$MEP)] <- sub(suffixes[i],replacements[i],l4$MEP[grepl(suffixes[i],l4$MEP)])
  l4$Ligand[grepl(suffixes[i],l4$Ligand)] <- sub(suffixes[i],replacements[i],l4$Ligand[grepl(suffixes[i],l4$Ligand)])
}

l3SS1 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS1_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS4 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS4_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l4SS1 <- addLigandPlate(addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS1_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE))))

l4SS4 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS4_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

#Create a data.table that holds every spot in the cell line
#that can be used to index to the images
l3SS14 <- rbindlist(list(l3SS1[!grepl("FBS",l3SS1$MEP),],l3SS4[!grepl("FBS",l3SS4$MEP)]),use.names=TRUE,fill=TRUE)
l3SS14 <- l3SS14[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed :=  2^Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess/(1+2^Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)]
l3SS14 <- l3SS14[,Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed :=  2^Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess/(1+2^Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess)]

l4nMean <- meanSummarizel4(l4)
l4Merge <- merge(l4SS1[!grepl("FBS",l4SS1$MEP),grep("MEP|MitoTracker|LigandPlate",colnames(l4SS1), value=TRUE), with=FALSE],
                  l4SS4[!grepl("FBS",l4SS4$MEP),grep("MEP|EdU|KRT",colnames(l4SS4), value=TRUE), with=FALSE],by = "MEP")

l4MergeFBS <- merge(l4SS1[,grep("MEP|MitoTracker|LigandPlate",colnames(l4SS1), value=TRUE), with=FALSE],
                     l4SS4[,grep("MEP|EdU|Fibrillarin|KRT",colnames(l4SS4), value=TRUE), with=FALSE],by = "MEP")

l4Merge <- merge(l4Merge, l4nMean[!grepl("FBS",l4nMean$MEP),], by="MEP")

l4MergeFBS <- merge(l4MergeFBS, l4nMean, by="MEP")

#Read in ligand metadata
ligandMetadata <- readWorksheetFromFile("../Ligand-cellsource_effects_v1.xlsx", sheet="Sheet1",startRow=1, header=TRUE)
ligandMetadataDT <- convertColumnNames(data.table(ligandMetadata))
ligandMetadataDT$Ligand <- sub("_[[:alnum:]]*$","",ligandMetadataDT$protein)
ligandMetadataDT$Growth <- grepl("Growth",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Migration <- grepl("Migration",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Invasion <- grepl("Invasion",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TherapeuticResistance <- grepl("therapeutic resistance",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Metastasis <- grepl("metastasis",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Survival <- grepl("survival",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Angiogenesis <- grepl("angiogenesis",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Proliferation <- grepl("Proliferation",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Immunomodulatory <- grepl("Immunomodulatory",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TumorProgression <- grepl("tumor progression",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TherapeuticResponse <- grepl("therapeutic response",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$StemCellMaintenance <- grepl("stem cell maintenance",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TumorInitiation <- grepl("tumor initiation",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$VascularHomeostasis <- grepl("vascular homeostasis",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Inflammation <- grepl("inflammation",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$ImmuneEffects <- grepl("immune effects",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Progression <- grepl("progression",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$Adhesion <- grepl("adhesion",ligandMetadataDT$Effect, ignore.case = TRUE)
ligandMetadataDT$TumorEffects <- grepl("tumor effects",ligandMetadataDT$Effect, ignore.case = TRUE)

l4Merge <- merge(l4Merge, ligandMetadataDT, by="Ligand")
l4Merge <- unique(l4Merge,by = "MEP")

l4Merge <- l4Merge[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed :=  2^Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess/(1+2^Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)]
l4Merge <- l4Merge[,Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed :=  2^Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess/(1+2^Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess)]

l4MergeFBS <- merge(l4MergeFBS, ligandMetadataDT, by="Ligand")
l4MergeFBS <- unique(l4MergeFBS,by = "MEP")
l4MergeFBS <- l4MergeFBS[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed :=  2^Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess/(1+2^Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)]
l4MergeFBS <- l4MergeFBS[,Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed :=  2^Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess/(1+2^Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess)]
```

<br>

#MEP-LINCS HMEC240L MEP Nominations 
####date: `r Sys.Date()`

##Introduction
This analysis is of the MEP-LINCS HMEC240L MEMA experiments performed in eight well plates. The data is collected at the cell level from images captured on an automated Nikon microscope. The cell level data is summarized for each MEMA spot, RUV and loess normalized, then replicate spots are summarized to the MEP level.  

The MEP-level dataset is stored and manipulated as a matrix where each of the `r dim(l4Merge)[1]` rows are a unique MEP and each of the `r dim(l4Merge)[2]` columns are signals or metadata. Some signals are based on the DAPI staining that is present in all wells. This creates two replicate ligand wells which each have ~fourteen replicates of spotted ECM proteins. The rest of the signals are based on unique stains and the ~fourteen replicate spots are all in the same well. It's important to note that the MEP level data comes from two different experiments run over several weeks.

The Spot-level dataset is a matrix where each of the `r dim(l3SS14)[1]` rows is a spot and each of the `r dim(l3SS14)[2]` columns are signals or metadata. The spot level data is a sparse matrix where the each row has values from one staining set and NA values for the other.

###Cell Cycle 
The cell cycle boxplots are based on gating the cells on their total DAPI signals into 2N or 4N classes. This data is RUV and loess normalized and then summarized across all staining sets where each ligand has two replicates and there are 16 control wells. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

```{r CellCycleBoxplots, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-3,0))+
  xlab("Ligand")+ylab("Normalized DNA4N")+
  ggtitle("MEP DNA4N Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)
```


###Proliferation Boxplots
The boxplots show the RUV and loess normalized MEP level data for the gated EdU+ proliferation signal stratifed by the ligands. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  


```{r EdUBoxplotsFull, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)


```


###Spot Cell Count
The spot cell count boxplots are based on the DAPI signals in all wells. This data is RUV and loess normalized and then summarized across all staining sets where each ligand has three replicates and there are 24 control wells. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

```{r SCCBoxplots, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median), y=Spot_PA_SpotCellCountLog2RUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized Spot Cell Count\n(Log2)")+
  ggtitle("MEP Spot Cell Count Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)
```

###MEP Level Data
The interactive datatable of the MEP level data displays MEPs filtered on keywords and sorted by values.


```{r datatable}

colNames <- c("MEP","Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed", "Spot_PA_SpotCellCountLog2RUV3Loess", "Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed","Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess")
colNamesDisplay <- c("MEP","Normed EdU+ Prop.","Normed SCC (log2)","Normed DNA 4N Prop.", "Normed KRT5", "Normed MitoTracker")

dt <- setorder(dt,Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed)
datatable(format(dt[, colNames, with=FALSE], digits=3, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)
```

###Spot Level Data
The interactive datatable of the spot level data displays spots filtered on keywords and sorted by values. There is one image of each spot which is displayed by clicking on the Omero link (OHSU Gray Lab Omero account needed).  

```{r}
#Setup for spots to display images
dt <- l3SS14[!grepl("NID1|ELN",l3SS14$ECMp),]
colNamesSpots <- c(colNames[1],"Barcode","Well","ArrayRow","ArrayColumn","OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"Barcode","Well","ArrayRow","ArrayColumn","Image Link",colNamesDisplay[2:length(colNamesDisplay)])
dt <- setorder(dt, -Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=3, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```

###Lineage Boxplots
The boxplots show the RUV and loess normalized MEP level data for the KRT5 and KRT19 cytoplasmic median intensity signal stratifed by the ligands.  

```{r KRT5BoxplotsFull, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("MEP Cytoplasmic KRT5 Median Intensity by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)

```


```{r KRT19BoxplotsFull, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUV3Loess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT19 Intensity\n(Log2)")+
  ggtitle("Cytoplasmic KRT19 Intensity by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)
```

###Gated Proportions
The KRT19 Proportion signal is the porportion of cells in each spot that were in the KRT19 high gate. The gate threshold is automatically determined by kmeans clustering (k=2) the median KRT19 intensity of all cells in each plate.  

```{r gatedKRT19Boxplots}
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess), FUN=median), y=btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess), fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT19 Proportion")+
  ggtitle("Proportion of KRT19 High by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)


```

###Lineage and Proliferation
The scatter plot below shows the normalized KRT19+ proportion vs the normalized EdU+ measured proliferation. The spot size represents the relative number of cells. The colors represent the ligands. The ECM protein is displayed in the tool tip box that appears while hovering over a spot.  

```{r, fig.width=10, fig.height=7}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
p <- ggplot(dt, aes(x=btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess), y=btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess), colour=Ligand, size=Spot_PA_SpotCellCountLog2, text=paste("ECMp:",ECMp)))+
  geom_point(alpha=.4)+
  guides(colour=FALSE, size=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Normalized EdU+")+ylab("Normalized KRT19+")+
  ggtitle("MEP KRT19 vs Proliferation")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
ggplotly(p)

```

```{r, fig.width=10, fig.height=7, eval=FALSE}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
p <- ggplot(dt, aes(x=factor(ECMp), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, colour=Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess< (-.5), size=Spot_PA_SpotCellCountLog2, text=paste("ECMp:",ECMp)))+
  geom_boxplot()+
  guides(colour=FALSE, size=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("ECMp")+ylab("Normalized KRT5 Intensity")+
  ggtitle("MEP KRT19 vs Proliferation")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

```


```{r PCAData, eval=TRUE}
###PCA Unbiased Analysis  

#Get a PCA model from the raw data
rawFVNames <- grep("Log2|Logit", grep("ECMp|Ligand|MEP|Barcode|Well|StainingSet|Loess|RUV3",colnames(l4nMean),invert = TRUE, value = TRUE), value=TRUE)
rawPCAModel <- createPCAModel(dt=l4nMean, fvNames = rawFVNames)

#Get a PCA model from the RUV3 data
RUV3Names <- grep("Loess",grep("Log2RUV3$|LogitRUV3$",colnames(l4nMean), value=TRUE),value=TRUE,invert=TRUE)
RUV3PCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3Names)

#Get a PCA model from the RUV3Loess data
RUV3LoessNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4nMean), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessPCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3LoessNames)

#Get a PCA model from the RUV3Loess of all signals
RUV3LoessMEPNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4Merge), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessMEPPCAModel <- createPCAModel(dt=l4Merge, fvNames = RUV3LoessMEPNames)

RUV3LoessMEPFBSPCAModel <- createPCAModel(dt=l4MergeFBS, fvNames = RUV3LoessMEPNames)


```

<br>

###PCA of All MEP Signals
The following scatter plots show principal component values of the MEPs after PCA of all MEP signals. 

FBS MEPs are colored black, Nidogen 1 MEPS are brown, a selected ligand, ECM protein or combination is gold and the rest of the MEPS are light blue. The selected MEP(s) are described in each plot title.   

Below are the signals used in the MEP PCA model. 

`r RUV3LoessMEPNames `

<br>



```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP2")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP3")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP4")

```


```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP5")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP6")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP7")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "HGF")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "Wnt5a")

```

####PCA Coloured by Ligand Plate
```{r, fig.height=2, fig.width=3, eval =FALSE}
#Start debug here
p <- ggplot(data.frame(RUV3LoessMEPFBSPCAModel$x), aes(x = PC1, y = PC2))+geom_point(size = rel(.5), alpha = .5)+
      guides(colour=FALSE)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))

p <- p + geom_point(l4MergeFBS, aes(colour=factor(LigandPlate)))
print(p)

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4MergeFBS$LigandPlate", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10))
print(p)

```


```{r MEPPCADatatable}
dt <- data.frame(RUV3LoessMEPFBSPCAModel$x)
dt$MEP <- rownames(dt)
dt<- data.table(dt)
colNames <- c("MEP","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9")
colNamesDisplay <- c("MEP","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9")

dt <- setorder(dt,PC1)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

```


### tSNE of all MEP Signals

```{r tSNEFBS_Data}
#Need to remove FBS entries that are duplicated after normalization
l4MergeFBS$Ligand <- sub("FBS.*","FBS",l4MergeFBS$Ligand)
l4MergeFBS$MEP <- sub("FBS.*","FBS",l4MergeFBS$MEP)
l4MergeFBSU <- unique(l4MergeFBS)
data_matrix <- scale(as.matrix(l4MergeFBSU[,RUV3LoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15,check_duplicates = FALSE)
l4MergeFBSU <- cbind(l4MergeFBSU,data_tsne$Y)

```


```{r plottSNELigandFBSU,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4MergeFBSU, aes(x=V1, y=V2, colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of HMEC240L MEPs with FBS Coloured by Ligand"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r tSNEData,fig.width=8, fig.height=5, eval=TRUE}
data_matrix <- scale(as.matrix(l4Merge[,RUV3LoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15)
l4Merge <- cbind(l4Merge,data_tsne$Y)
```

```{r plottSNELigand,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of HMEC240L MEPs Coloured by Ligand"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r plottSNEECMp,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=ECMp, text=paste("Ligand:",Ligand)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of HMEC240L MEPs Coloured by ECM Protein"))+
  guides(colour =FALSE)
ggplotly(p)

```


```{r plottSNELigandPlate,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of HMEC240L MEPs Coloured by Ligand Plate"))+
  guides(colour =FALSE)
ggplotly(p)


```

```{r tSNE_exploreeedsData, fig.width=3, fig.height=3}

seed <- 42
set.seed(seed)
data_tsne <- Rtsne(data_matrix, perplexity = 30)
l4Merge$V1 <- data_tsne$Y[,1]
l4Merge$V2 <- data_tsne$Y[,2]

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot Coloured by Ligand Plate, seed:",seed))+
  guides(colour =FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

seed <- 1
set.seed(seed)
data_tsne <- Rtsne(data_matrix, perplexity = 30)
l4Merge$V1 <- data_tsne$Y[,1]
l4Merge$V2 <- data_tsne$Y[,2]

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot Coloured by Ligand Plate, seed:",seed))+
  guides(colour =FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)


seed <- 1999
set.seed(seed)
data_tsne <- Rtsne(data_matrix, perplexity = 30)
l4Merge$V1 <- data_tsne$Y[,1]
l4Merge$V2 <- data_tsne$Y[,2]

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=LigandPlate, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot Coloured by Ligand Plate, seed:",seed))+
  guides(colour =FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)



```

```


```

```{r plottSNELigandAnnotations,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=Proliferation, text=paste("Ligand:",Ligand,"ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of HMEC240L MEPs Coloured by Ligand Effect"))+
  guides(colour =FALSE)
ggplotly(p)

```

```{r plottSNEFeatures,fig.width=3, fig.height=3, eval=TRUE}

tmp <- lapply(RUV3LoessMEPNames,function(sigName){
  p <- ggplot(l4Merge, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

tmp <- lapply(grep("TissueExpression|PrimaryCellSource|Growth|Migration|Invasion|TherapeuticResistance|Metastasis|Survival|Angiogenesis|Proliferation|Immunomodulatory|TumorProgression|TherapeuticResponse|StemCellMaintenance|TumorInitiation|VascularHomeostasis|Inflammation|ImmuneEffects|Progression|Adhesion|TumorEffects", colnames(l4Merge), value=TRUE),function(sigName){
  p <- ggplot(l4Merge, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

```


```{r, fig.width=4.5, fig.height=3.5, eval=FALSE}
dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt <- dt[grepl("BMP4|BMP6|BMP7",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed), by=Ligand]

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized EdU+")+
  ggtitle("Nominated MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=ECMp),size=rel(.5),alpha=.5)

p <- p+geom_text(data=dt[grepl("^1$|^45$",ECMpRank)|grepl("COL1",ECMp),],aes(label=ECMp),nudge_x = 0.2, colour="blue")

p <- p+geom_text(data=dt[grepl("^2$|^46$",ECMpRank),],aes(label=ECMp),nudge_x = -0.2, colour="blue")
print(p)

#Save BMP7 MEPs for comparison in DNA4N
BMP7MEPs <- dt[(grepl("^1$|^45$|^2$|^46$",ECMpRank)|grepl("COL1",ECMp))&grepl("BMP7",dt$Ligand),][["MEP"]]

nomMEPS <- rbind(dt[grepl("^1$|^45$",ECMpRank)|grepl("COL1",ECMp),],dt[grepl("^2$|^46$",ECMpRank),])

```


```{r, fig.width=4, fig.height=3.5, eval=FALSE}
dt <- l4Merge[!grepl("ELN",l4Merge$ECMp),]
dt <- dt[grepl("HGF|FGF2",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess), by=Ligand]

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("Nominated MEP KRT5 Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=ECMp),size=rel(.5),alpha=.5)

p <- p+geom_text(data=dt[(grepl("^1$|^2$",ECMpRank)|grepl("COL1",ECMp))&grepl("HGF",Ligand),],aes(label=ECMp),nudge_x = 0.15, colour="blue")

p <- p+geom_text(data=dt[(grepl("^45$",ECMpRank)|grepl("COL1|NID1",ECMp))&grepl("FGF2",Ligand),],aes(label=ECMp),nudge_x = 0.2, colour="blue")

p <- p+geom_text(data=dt[grepl("^46$",ECMpRank)&grepl("FGF2",Ligand),],aes(label=ECMp),nudge_x = -0.2, colour="blue")
print(p)

nomMEPS <- rbind(nomMEPS,
                 dt[(grepl("^1$|^2$",ECMpRank)|grepl("COL1",ECMp))&grepl("HGF",Ligand),],
                 dt[(grepl("^45$",ECMpRank)|grepl("COL1|NID1",ECMp))&grepl("FGF2",Ligand),],
                 dt[grepl("^46$",ECMpRank)&grepl("FGF2",Ligand),])

```


```{r, fig.width=4, fig.height=3.5, eval=FALSE}
dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt <- dt[grepl("Wnt5a|BMP7",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed), by=Ligand]

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized DNA4N")+
  ggtitle("Nominated MEP DNA4N Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=ECMp),size=rel(.5),alpha=.5)

p <- p+geom_text(data=dt[(grepl("^45$",ECMpRank)&grepl("Wnt5a",Ligand)),],aes(label=ECMp),nudge_x = -0.2, colour="blue")

p <- p+geom_text(data=dt[((grepl("^46$",ECMpRank)|grepl("COL1",ECMp))&grepl("Wnt5a",Ligand)),],aes(label=ECMp),nudge_x = 0.2, colour="blue")

#use BMP7MEPs selected from EdU response
p <- p+geom_text(data=dt[(MEP %in% BMP7MEPs[c(1)]),],aes(label=ECMp),nudge_x = 0, colour="blue")
p <- p+geom_text(data=dt[(MEP %in% BMP7MEPs[c(3,5)]),],aes(label=ECMp),nudge_x = -0.4, colour="blue")
p <- p+geom_text(data=dt[(MEP %in% BMP7MEPs[c(2,4)]),],aes(label=ECMp),nudge_x = 0.4, colour="blue")

print(p)

nomMEPS <- rbind(nomMEPS,
                 dt[(grepl("^45$",ECMpRank)&grepl("Wnt5a",Ligand)),],
                 dt[((grepl("^46$",ECMpRank)|grepl("COL1",ECMp))&grepl("Wnt5a",Ligand)),])

```

```{r, eval=FALSE}

nomMEPSCurated <- (nomMEPS[,grep("Barcode|^Well$|^Spot$|Array|MEP|ECMp|^Ligand$|Cells_CP_AreaShape_AreaLog2|Nuclei_CP_AreaShape_AreaLog2|Cytoplasm_CP_Intensity_IntegratedIntensity_KRT5Log2|Cytoplasm_CP_Intensity_IntegratedIntensity_KRT19Log2|Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2|Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2|Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2|Nuclei_CP_Intensity_IntegratedIntensity_EdULog2|Nuclei_CP_Intensity_MedianIntensity_DapiLog2|Nuclei_CP_Intensity_MedianIntensity_EdULog2|Nuclei_PA_Cycle_DNA2NProportionLogit|Nuclei_PA_Cycle_DNA4NProportionLogit|Nuclei_PA_Gated_EdUPositiveProportionLogit",colnames(nomMEPS), value=TRUE), with=FALSE])
    nomMEPSCurated <- nomMEPSCurated[,grep("RUV3$|_SE|RLE$|ECMpRank",colnames(nomMEPSCurated), value=TRUE, invert=TRUE), with=FALSE]

    setkey(nomMEPSCurated,Ligand,MEP)
write.csv(nomMEPSCurated,file = "HMEC240LMEPSforValidation.csv",row.names = FALSE)

```

###Spot Level Responses


```{r, fig.width=10, fig.height=18}
dt <- l3SS14[grepl("BMP",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("Spot level EdU+ Response by ECMp")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter(aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```


```{r, fig.width=10, fig.height=18}
dt <- l3SS14[grepl("BMP",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess), FUN=median), y=btLogit(Cytoplasm_PA_Gated_KRT19PositiveProportionLogitRUV3Loess)))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized KRT19+")+
  ggtitle("Spot level KRT19+ by ECMp")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```


```{r, fig.width=10, fig.height=18}
dt <- l3SS14[grepl("BMP",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized DNA4N\n(Logit)")+
  ggtitle("Spot level DNA4N Response by ECMp")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```



```{r ,eval=FALSE}
dt <- l4Merge
dt <- dt[grepl("BMP4|BMP6|BMP7|Wnt5a|HGF|FGF2",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed), by=Ligand]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, size=Spot_PA_SpotCellCountLog2RUV3Loess))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(xlim = c(6.5,8))+
  xlab("Ligand")+ylab("Normalized EdU+")+
  ggtitle("Nominated MEP EdU+ Response by Ligand")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2RUV3Loess, y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  coord_cartesian(xlim = c(6.5,8))+
  xlab("Normalized Spot Cell Count")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ vs Spot Cell Count")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

p <- ggplot(dt, aes(x=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3LoessBacktransformed, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Normalized DNA 4N")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ vs DNA 4N")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)


p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2RUV3Loess, y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3LoessBacktransformed, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(xlim = c(6.5,8))+
  xlab("Normalized Spot Cell Count")+ylab("Normalized DNA 4N\n(Logit)")+
  ggtitle("MEP DNA 4N vs Spot Cell Count")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2RUV3Loess, y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  coord_cartesian(xlim = c(6.5,8))+
  xlab("Normalized Spot Cell Count")+ylab("Normalized KRT5")+
  ggtitle("MEP KRT5 vs Spot Cell Count")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)


```


###Heatmaps

The following heatmaps are the summarized values of each MEP across the replicates of the common signal dataset.  

Spot values are median summarized within each plate to get MEP values for each staining set. 

The MEP values of each staining set are mean summarized and displayed in the heatmaps below.  


```{r medianHeatMaps, fig.width=4.5, fig.height=3.5}

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3Loess"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUVLoess"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3Loess", titleExpression=titleExpression, limits=limits)


```

###Clustered Heatmaps
The clustered heatmaps display the same data as above but with unsupervised clustering in the rows and columns using the complete linkage method which finds similar clusters. These maps use three colors to highlight the data sturcture however the white color is merely the center of the data, it does not have specific biological meaning.  

<br>

```{r medianHeatMaps2, fig.width=9, fig.height=5.5}

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUVLoess"
plotLEHmap(l4nMean, hclustfun = "hclust", fill="Spot_PA_SpotCellCountLog2RUV3Loess", titleExpression=titleExpression, limits=limits)

```
