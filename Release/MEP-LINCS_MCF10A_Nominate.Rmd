
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8X00","",dt$Barcode), sep="_")
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle, xlim=NULL, ylim=NULL, colorByCtrls=TRUE, highlightName=NULL){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  
  if(is.null(highlightName)){
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
      geom_point(size = rel(.5), alpha = .5) +
      labs(colour = legendTitle)+
      ggtitle(title)+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
  } else {
    #Dim out all MEPs except the selected
    dimColour<-"cornflowerblue"
    p12 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p23 <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
    
    p13 <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3])) +
      geom_point(size = rel(.5), alpha = .5, colour = dimColour) +
      labs(colour = legendTitle)+
      ggtitle(paste(title, "with",highlightName, "highlighted"))+
      guides(colour=FALSE)+
      coord_cartesian(xlim=xlim, ylim=ylim)+
      theme(legend.text=element_text(size = 6),
            plot.title=element_text(size = rel(.7)))
  }
  
  if(colorByCtrls){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .4)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl("NID1",rownames(m$x)),]),colour="chocolate",size = rel(.5), alpha = .4)
  }
  
  if(!is.null(highlightName)){
    p12 <- p12 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p23 <- p23 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
    p13 <- p13 + geom_point(data=data.frame(m$x[grepl(highlightName,rownames(m$x)),]),colour="gold",size = rel(.5), alpha = .8)
  }
  
  print(p12)
  print(p23)
  print(p13)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}

shortenHA <- function(x){
  x$ECMp <- gsub("hyaluronicacid","HA",x$ECMp)
  x$ECMp <- gsub("lessthan","<",x$ECMp)
  x$ECMp <- gsub("greaterthan",">",x$ECMp)
  x$MEP <- paste(x$ECMp,x$Ligand,sep = "_")
  return(x)
}

addOmeroIDs <- function(dt){
  if(any(grepl("^ImageID$",colnames(dt)))){
    dt <- dt[,OmeroDetailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroThumbnailURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',ImageID,'/"',' target="_blank">Omero</a>')]
    dt <- dt[,OmeroImageURL := paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',ImageID,'/"',' target="_blank">Omero</a>')]
  }
  return(dt)
}

```



```{r setup}

library("ggplot2")
library(scales)
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)
library(RUVnormalize)
library(ruv)
library(Rtsne)

#Use x structure for future fleixbility
x <- data.frame(cellLine="MCF10A",
                drug= "none",
                analysisVersion="av1.6",
                rawDataVersion="v2",
                stringsAsFactors = FALSE)
#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol <- selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
PCAOnly <- TRUE
cellLine <- x[["cellLine"]]

l3n <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l4 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_CS_",x[["drug"]], "_",x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

#Match the FBA wells up as replicates and change to common names
tmp <- l4[grepl("FBS",l4$Ligand),]
suffixes <- sort(sub("FBS","",unique(tmp$Ligand)))
replacements <- rep(paste0("_P",1:8), times=3)
for(i in 1:24){
  l4$MEP[grepl(suffixes[i],l4$MEP)] <- sub(suffixes[i],replacements[i],l4$MEP[grepl(suffixes[i],l4$MEP)])
  l4$Ligand[grepl(suffixes[i],l4$Ligand)] <- sub(suffixes[i],replacements[i],l4$Ligand[grepl(suffixes[i],l4$Ligand)])
  }

l3SS1 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS1_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS2 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS2_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS3 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS3_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level3.txt")), showProgress = FALSE)))

l3SS3 <- l3SS3[!grepl("CSF2",l3SS3$Ligand),]

l4SS1 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS1_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

l4SS2 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS2_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))

l4SS3 <- addOmeroIDs(shortenHA(fread(unique(paste0("../AnnotatedData/",x[["cellLine"]], "_SS3_",x[["drug"]], "_",x[["rawDataVersion"]], "_", x[["analysisVersion"]],"_Level4.txt")), showProgress = FALSE)))
l4SS3 <- l4SS3[!grepl("CSF2",l4SS3$Ligand),]


medianSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMedians <- dtKeep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMedians)
}

meanSummarizel4 <- function(dt){
  #median summarize the MEP replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well"]
  return(dtMeans)
}

meanSummarizel3 <- function(dt){
  #median summarize the Spot replicates in a datatable
  #Select all signal names and the minimal metadata
  dtNames <- grep("^Ligand$|^ECMp$|MEP|^Well$|PrintSpot|_CP_|_PA_",x = names(dt), value = TRUE)
  
  #Create a datatable of the signals and minimal metadata
  dtKeep <- dt[, dtNames, with = FALSE]
  dtMeans <- dtKeep[, lapply(.SD, numericMean), keyby = "Ligand,ECMp,MEP,Well,PrintSpot"]
  return(dtMeans)
}

numericMean <- function(x){
  as.numeric(mean(x, na.rm=TRUE))
}

#Create a data.table that holds every spot in the cell line
#that can be used to index to the images
l3SS123 <- rbindlist(list(l3SS1[!grepl("FBS",l3SS1$MEP),],l3SS2[!grepl("FBS",l3SS2$MEP),],l3SS3[!grepl("FBS",l3SS3$MEP),]),use.names=TRUE,fill=TRUE)

# #Merge the spot level data
# l3nMean <- meanSummarizel3(l3n[!grepl("FBS",l3n$MEP),])
# l3SS1SS2 <- merge(l3SS1[!grepl("FBS",l3SS1$MEP),grep("MEP|PrintSpot|MitoTracker",colnames(l3SS1), value=TRUE), with=FALSE],
#                   l3SS2[!grepl("FBS",l3SS2$MEP),grep("MEP|PrintSpot|EdU|Fibrillarin",colnames(l3SS2), value=TRUE), with=FALSE],by = c("MEP","PrintSpot"))
# l3Merge <- merge(l3SS1SS2,
#                  l3SS3[!grepl("FBS",l3SS3$MEP),grep("MEP|PrintSpot|KRT",colnames(l3SS3), value=TRUE), with=FALSE],by = c("MEP","PrintSpot"))
# l3Merge <- merge(l3Merge,l3nMean,by = c("MEP","PrintSpot"))

l4nMean <- meanSummarizel4(l4)
l4SS1SS2 <- merge(l4SS1[!grepl("FBS",l4SS1$MEP),grep("MEP|MitoTracker",colnames(l4SS1), value=TRUE), with=FALSE],
                  l4SS2[!grepl("FBS",l4SS2$MEP),grep("MEP|EdU|Fibrillarin",colnames(l4SS2), value=TRUE), with=FALSE],by = "MEP")

l4SS1SS2FBS <- merge(l4SS1[,grep("MEP|MitoTracker",colnames(l4SS1), value=TRUE), with=FALSE],
                     l4SS2[,grep("MEP|EdU|Fibrillarin",colnames(l4SS2), value=TRUE), with=FALSE],by = "MEP")

l4Merge <- merge(l4SS1SS2,
                 l4SS3[!grepl("FBS",l4SS3$MEP),grep("MEP|KRT",colnames(l4SS3), value=TRUE), with=FALSE],by = "MEP")

l4MergeFBS <- merge(l4SS1SS2FBS,
                    l4SS3[,grep("MEP|KRT",colnames(l4SS3), value=TRUE), with=FALSE],by = "MEP")

l4Merge <- merge(l4Merge, l4nMean[!grepl("FBS",l4nMean$MEP),], by="MEP")

l4MergeFBS <- merge(l4MergeFBS, l4nMean, by="MEP")

```

<br>

#MEP-LINCS MCF10A MEP Nominations 
####date: `r Sys.Date()`

##Introduction
This analysis is of the MEP-LINCS MCF10A MEMA experiments performed in eight well plates. The data is collected at the cell level from images captured on an automated Nikon microscope. The cell level data is summarized for each MEMA spot, RUV3 and loess normalized, then replicate spots are summarized to the MEP level.  

The MEP-level dataset is stored and manipulated as a matrix where each of the `r dim(l4Merge)[1]` rows are a unique MEP and each of the `r dim(l4Merge)[2]` columns are signals or metadata. Some signals are based on the DAPI staining that is present in all wells. This creates three replicate ligand wells which each have ~fifteen replicates of spotted ECM proteins. The rest of the signals are based on unique stains and the ~fifteen replicate spots are all in the same well. It's important to note that the MEP level data comes from three different experiments run over three week period.

The Spot-level dataset is a matrix where each of the `r dim(l3SS123)[1]` rows is a spot and each of the `r dim(l3SS123)[2]` columns are signals or metadata. The spot level data is a sparse matrix where the each row has values from one staining set and NA values for the other two.

###Cell Cycle 
The cell cycle boxplots are based on gating the cells on their total DAPI signals into 2N or 4N classes. This data is RUV3 and loess normalized and then summarized across all staining sets where each ligand has three replicates and there are 24 control wells. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

```{r CellCycleBoxplots, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-3,0))+
  xlab("Ligand")+ylab("Normalized DNA4N\n(Logit)")+
  ggtitle("MEP DNA4N Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)
```


###Proliferation Boxplots
The boxplots show the RUV3 and loess normalized MEP level data for the gated EdU+ proliferation signal stratifed by the ligands. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  


```{r EdUBoxplotsFull, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)

```


###Spot Cell Count
The spot cell count boxplots are based on the DAPI signals in all wells. This data is RUV3 and loess normalized and then summarized across all staining sets where each ligand has three replicates and there are 24 control wells. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

```{r SCCBoxplots, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Spot_PA_SpotCellCountLog2RUV3Loess, FUN=median), y=Spot_PA_SpotCellCountLog2RUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized Spot Cell Count\n(Log2)")+
  ggtitle("MEP Spot Cell Count Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)
```

###MEP Level Data
The interactive datatable of the MEP level data displays MEPs filtered on keywords and sorted by values.


```{r datatable}

colNames <- c("MEP","Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess", "Spot_PA_SpotCellCountLog2RUV3Loess", "Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess","Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess")
colNamesDisplay <- c("MEP","Normed EdU+ Prop.","Normed SCC (log2)","Normed DNA 4N Prop.", "Normed KRT5", "Normed MitoTracker")

dt <- setorder(dt,Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)
datatable(format(dt[, colNames, with=FALSE], digits=3, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)
```

###Spot Level Data
The interactive datatable of the spot level data displays spots filtered on keywords and sorted by values. There is one image of each spot which is displayed by clicking on the Omero link (OHSU Gray Lab Omero account needed).  

```{r}
#Setup for spots to display images
dt <- l3SS123[!grepl("NID1|ELN",l3SS123$ECMp),]
colNamesSpots <- c(colNames[1],"Barcode","Well","ArrayRow","ArrayColumn","OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"Barcode","Well","ArrayRow","ArrayColumn","Image Link",colNamesDisplay[2:length(colNamesDisplay)])
dt <- setorder(dt, -Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=3, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```

###Lineage Boxplots
The boxplots show the RUV3 and loess normalized MEP level data for the KRT5 cytoplasmic median intensity signal stratifed by the ligands.  

```{r KRT5BoxplotsFull, fig.width=8, fig.height=5}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Ligand")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("MEP Cytoplasmic KRT5 Median Intensity by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.1),alpha=.5)
print(p)

```

###Lineage and Proliferation
The scatter plot below shows the normalized KRT5 median intensity vs the normalized EdU+ measured proliferation. The spot size represents the relative number of cells. The colors represent the ligands. The ECM protein is dispalyed in the tool tip box that appears while hovering over a spot.  

```{r, fig.width=10, fig.height=7}

dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, colour=Ligand, size=Spot_PA_SpotCellCountLog2, text=paste("ECMp:",ECMp)))+
  geom_point(alpha=.4)+
  guides(colour=FALSE, size=FALSE)+
  #coord_cartesian(ylim = c(7,13))+
  xlab("Normalized EdU+\n(Logit)")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("MEP KRT5 vs Proliferation")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
#print(p)
ggplotly(p)

```


```{r PCAData, eval=TRUE}


###PCA Unbiased Analysis  

#Get a PCA model from the raw data
rawFVNames <- grep("Log2|Logit", grep("ECMp|Ligand|MEP|Barcode|Well|StainingSet|Loess|RUV3",colnames(l4nMean),invert = TRUE, value = TRUE), value=TRUE)
rawPCAModel <- createPCAModel(dt=l4nMean, fvNames = rawFVNames)

#Get a PCA model from the RUV3 data
RUV3Names <- grep("Loess",grep("Log2RUV3$|LogitRUV3$",colnames(l4nMean), value=TRUE),value=TRUE,invert=TRUE)
RUV3PCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3Names)

#Get a PCA model from the RUV3Loess data
RUV3LoessNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4nMean), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessPCAModel <- createPCAModel(dt=l4nMean, fvNames = RUV3LoessNames)

#Get a PCA model from the RUV3Loess of all signals
RUV3LoessMEPNames <- grep("LoessRUV3",grep("Log2RUV3Loess$|LogitRUV3Loess$",colnames(l4Merge), value=TRUE), value=TRUE, invert=TRUE)
RUV3LoessMEPPCAModel <- createPCAModel(dt=l4Merge, fvNames = RUV3LoessMEPNames)

RUV3LoessMEPFBSPCAModel <- createPCAModel(dt=l4MergeFBS, fvNames = RUV3LoessMEPNames)


```

<br>

###PCA of All MEP Signals
The following scatter plots show principal component values of the MEPs after PCA of all MEP signals. 

FBS MEPs are colored black, Nidogen 1 MEPS are brown, a selected ligand, ECM protein or combination is gold and the rest of the MEPS are light blue. The selected MEP(s) are described in each plot title.   

Below are the signals used in the MEP PCA model. 

`r RUV3LoessMEPNames `

<br>



```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP2")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP3")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP4")

```


```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP5")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP6")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "BMP7")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "HGF")

```

```{r, fig.height=2, fig.width=3}

plotPCs(m = RUV3LoessMEPFBSPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4nMean$Ligand", title = "PCA of All MEP Signals\n", legendTitle = "Barcode", xlim = c(-15,15), ylim=c(-10,10), highlightName = "Wnt5a")

```

```{r MEPPCADatatable}
dt <- data.frame(RUV3LoessMEPFBSPCAModel$x)
dt$MEP <- rownames(dt)
dt<- data.table(dt)
colNames <- c("MEP","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9")
colNamesDisplay <- c("MEP","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9")

dt <- setorder(dt,PC1)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

```


### tSNE of all MEP Signals

```{r tSNE_Data}

data_matrix <- scale(as.matrix(l4Merge[,RUV3LoessMEPNames, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15)
l4Merge <- cbind(l4Merge,data_tsne$Y)

```


```{r plottSNELigand,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=Ligand, text=paste("ECMp:",ECMp)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A MEPs Coloured by Ligand"))+
  guides(colour = FALSE)
ggplotly(p)

```


```{r plottSNEECMp,fig.width=8, fig.height=5, eval=TRUE}

p <- ggplot(l4Merge, aes(x=V1, y=V2, colour=ECMp, text=paste("Ligand:",Ligand)))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of MCF10A MEPs Coloured by ECM Protein"))+
  guides(colour =FALSE)
ggplotly(p)

```

```{r plottSNEFeatures,fig.width=3, fig.height=3, eval=TRUE}

tmp <- lapply(c(RUV3LoessMEPNames),function(sigName){
  p <- ggplot(l4Merge, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

```


##Nomination Details
Twenty-five MEPs are nominated for validation based on EdU(12), KRT5(4) and cell cycle responses as measured by total DAPI(2). To evaluate normalization results, each selected ligand's COL1 MEPs(6) are chosen along with one NID1 MEP(1).

###MEPs chosen by EdU Response
Based on review of the EdU and PCA responses, ligands BMP6, BMP7 and BMP4 are included in the nomination set. Four MEPS are chosen from each ligand. The two MEPS with the highest and the two with the lowest normalized EdU response. These are named in the boxplots below.  

```{r, fig.width=4.5, fig.height=3.5}
dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt <- dt[grepl("BMP4|BMP6|BMP7",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess), by=Ligand]

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("Nominated MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=ECMp),size=rel(.5),alpha=.5)

p <- p+geom_text(data=dt[grepl("^1$|^45$",ECMpRank)|grepl("COL1",ECMp),],aes(label=ECMp),nudge_x = 0.2, colour="blue")

p <- p+geom_text(data=dt[grepl("^2$|^46$",ECMpRank),],aes(label=ECMp),nudge_x = -0.2, colour="blue")
print(p)

#Save BMP7 MEPs for comparison in DNA4N
BMP7MEPs <- dt[(grepl("^1$|^45$|^2$|^46$",ECMpRank)|grepl("COL1",ECMp))&grepl("BMP7",dt$Ligand),][["MEP"]]
```

###MEPs chosen on KRT5 Response
Four MEPs are chosen based on high and low KRT5 response.  

```{r, fig.width=4, fig.height=3.5}
dt <- l4Merge[!grepl("ELN",l4Merge$ECMp),]
dt <- dt[grepl("HGF|FGF2",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess), by=Ligand]

p <- ggplot(dt, aes(x=reorder(Ligand, Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("Nominated MEP KRT5 Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=ECMp),size=rel(.5),alpha=.5)

p <- p+geom_text(data=dt[(grepl("^1$|^2$",ECMpRank)|grepl("COL1|NID1",ECMp))&grepl("HGF",Ligand),],aes(label=ECMp),nudge_x = 0.15, colour="blue")

p <- p+geom_text(data=dt[(grepl("^45$",ECMpRank)|grepl("COL1",ECMp))&grepl("FGF2",Ligand),],aes(label=ECMp),nudge_x = 0.2, colour="blue")

p <- p+geom_text(data=dt[grepl("^46$",ECMpRank)&grepl("FGF2",Ligand),],aes(label=ECMp),nudge_x = -0.2, colour="blue")
print(p)

```

###MEPs chosen on DAPI DNA Response
Two new MEPs are chosen based on high DNA4N values. These can be compared to the BMP7 MEPs which have low DNA4N values.  

```{r, fig.width=4, fig.height=3.5}
dt <- l4Merge[!grepl("NID1|ELN",l4Merge$ECMp),]
dt <- dt[grepl("Wnt5a|BMP7",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess), by=Ligand]

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized DNA4N\n(Log2)")+
  ggtitle("Nominated MEP DNA4N Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=ECMp),size=rel(.5),alpha=.5)

p <- p+geom_text(data=dt[(grepl("^45$",ECMpRank)&grepl("Wnt5a",Ligand)),],aes(label=ECMp),nudge_x = -0.2, colour="blue")

p <- p+geom_text(data=dt[((grepl("^46$",ECMpRank)|grepl("COL1",ECMp))&grepl("Wnt5a",Ligand)),],aes(label=ECMp),nudge_x = 0.2, colour="blue")

#use BMP7MEPs selected from EdU response
p <- p+geom_text(data=dt[(MEP %in% BMP7MEPs[c(1)]),],aes(label=ECMp),nudge_x = 0, colour="blue")
p <- p+geom_text(data=dt[(MEP %in% BMP7MEPs[c(3,5)]),],aes(label=ECMp),nudge_x = -0.4, colour="blue")
p <- p+geom_text(data=dt[(MEP %in% BMP7MEPs[c(2,4)]),],aes(label=ECMp),nudge_x = 0.4, colour="blue")

print(p)

```

###Spot Level Responses


```{r, fig.width=10, fig.height=18}
dt <- l3SS2[grepl("BMP|HGF|^EGF$|Wnt5a",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(colour=FALSE)+
  coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("Spot level EdU+ Response by ECMp")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter(aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```


```{r, fig.width=10, fig.height=18}
dt <- l3SS3[grepl("BMP|HGF|^EGF$|Wnt5a",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, FUN=median), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized KRT5\n(Log2)")+
  ggtitle("Spot level KRT5 Response by ECMp")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```


```{r, fig.width=10, fig.height=18}
dt <- l3SS123[grepl("BMP|HGF|^EGF$|Wnt5a",Ligand),]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  guides(colour=FALSE)+
  #coord_cartesian(ylim = c(-8,0))+
  xlab("ECMp")+ylab("Normalized DNA4N\n(Logit)")+
  ggtitle("Spot level DNA4N Response by ECMp")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p + geom_jitter( aes(colour=factor(Spot)),size=rel(.5),alpha=.5)

print(p)

```


###Multi-signal plots

```{r }
dt <- l4Merge
dt <- dt[grepl("BMP4|BMP6|BMP7|Wnt5a|HGF|FGF2",dt$Ligand),]

dt <- dt[,ECMpRank := rank(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess), by=Ligand]

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, size=Spot_PA_SpotCellCountLog2RUV3Loess))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(xlim = c(6.5,8))+
  xlab("Ligand")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("Nominated MEP EdU+ Response by Ligand")+
  facet_wrap(~Ligand, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2RUV3Loess, y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  coord_cartesian(xlim = c(6.5,8))+
  xlab("Normalized Spot Cell Count")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("MEP EdU+ vs Spot Cell Count")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

p <- ggplot(dt, aes(x=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Normalized DNA 4N")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("MEP EdU+ vs DNA 4N")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)


p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2RUV3Loess, y=Nuclei_PA_Cycle_DNA4NProportionLogitRUV3Loess, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  coord_cartesian(xlim = c(6.5,8))+
  xlab("Normalized Spot Cell Count")+ylab("Normalized DNA 4N\n(Logit)")+
  ggtitle("MEP DNA 4N vs Spot Cell Count")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

p <- ggplot(dt, aes(x=Spot_PA_SpotCellCountLog2RUV3Loess, y=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, colour=ECMp))+
  geom_point(alpha=.5)+
  guides(fill=FALSE, colour=FALSE)+
  coord_cartesian(xlim = c(6.5,8))+
  xlab("Normalized Spot Cell Count")+ylab("Normalized KRT5\n(Logit)")+
  ggtitle("MEP KRT5 vs Spot Cell Count")+
  facet_wrap(~Ligand)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)


```


###Heatmaps

The following heatmaps are the summarized values of each MEP across the replicates of the common signal dataset.  

Spot values are median summarized within each plate to get MEP values for each staining set. 

The MEP values of each staining set are mean summarized and displayed in the heatmaps below.  


```{r medianHeatMaps, fig.width=4.5, fig.height=3.5}

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3", titleExpression=titleExpression, limits=limits)

limits=quantile(l4nMean[["Spot_PA_SpotCellCountLog2RUV3Loess"]], probs=c(.005, .995), na.rm=TRUE)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3Loess"
plotLEHmap(l4nMean, fill="Spot_PA_SpotCellCountLog2RUV3Loess", titleExpression=titleExpression, limits=limits)


```

###Clustered Heatmaps
The clustered heatmaps display the same data as above but with unsupervised clustering in the rows and columns using the complete linkage method which finds similar clusters. These maps use three colors to highlight the data sturcture however the white color is merely the center of the data, it does not have specific biological meaning.  

<br>

```{r medianHeatMaps2, fig.width=9, fig.height=5.5}

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3"
plotLEHmap(l4nMean,  hclustfun = "hclust",fill="Spot_PA_SpotCellCountLog2RUV3", titleExpression=titleExpression, limits=limits)

limits=c(.05, .95)
titleExpression <-"Spot_PA_SpotCellCountLog2RUV3Loess"
plotLEHmap(l4nMean, hclustfun = "hclust", fill="Spot_PA_SpotCellCountLog2RUV3Loess", titleExpression=titleExpression, limits=limits)

```

###Calculate RLE Values
The relative log expression (RLE) values are the residuals where each item has had the median of all such items subtracted. The advantage of this is that all boxes will (nominally) be centered about zero, and systematic deviations from that are more readily noticed. In the ligand RLE boxplots, the groupings are all ECM proteins paired with each ligand within one staining set. In the ECM protein RLE boxplots, the groupings are all ligands paired with the ECM protein within each staining set.  

<br>

```{r SCC}

dt <- l4[,list(Barcode,Ligand,Spot_PA_SpotCellCountLog2LigandRLE,
               Spot_PA_SpotCellCountLog2RUV3LigandRLE,
               Spot_PA_SpotCellCountLog2RUV3LoessLigandRLE)]

dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Spot_PA_SpotCellCountLog2LigandRLE","Spot_PA_SpotCellCountLog2RUV3LigandRLE","Spot_PA_SpotCellCountLog2RUV3LoessLigandRLE"), variable.name = "Processed",value.name = "SpotCellCountLog2LigandRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3LigandRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"

p <- ggplot(dt, aes(x = factor(Ligand), y = SpotCellCountLog2LigandRLE, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by Ligand at Each Normalization Stage (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(dt[grepl("FBS", dt$Ligand),], aes(x = factor(Ligand), y = SpotCellCountLog2LigandRLE, colour = Processed))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by Ligand at Each Normalization Stage (FBS wells Only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(dt[!grepl("FBS", dt$Ligand),], aes(x = factor(Ligand), y = SpotCellCountLog2LigandRLE, colour = Processed))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by Ligand at Each Normalization Stage (Ligand wells Only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

dt <- l4[,list(Barcode,ECMp,Spot_PA_SpotCellCountLog2ECMpRLE, Spot_PA_SpotCellCountLog2RUV3ECMpRLE, Spot_PA_SpotCellCountLog2RUV3LoessECMpRLE)]
dt <- melt(dt,id.vars=c("Barcode","ECMp"),measure.vars=c("Spot_PA_SpotCellCountLog2ECMpRLE","Spot_PA_SpotCellCountLog2RUV3ECMpRLE","Spot_PA_SpotCellCountLog2RUV3LoessECMpRLE"), variable.name = "Processed",value.name = "SpotCellCountLog2ECMpRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3ECMpRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"


p <- ggplot(dt, aes(x = factor(ECMp), y = SpotCellCountLog2ECMpRLE))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by ECM Protein at Each Normalization Stage (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(ECMp), y = SpotCellCountLog2ECMpRLE, colour=Processed))+geom_boxplot()+
  ggtitle(paste("MEP Spot Cell Count RLE by ECM Protein at Each Normalization Stage (full dataset)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

```


```{r log2AreaBoxplotsControlsOnly, eval=any(grepl("Nuclei_CP_AreaShape_AreaLog2",colnames(l4)))&!PCAOnly}

dt <- l4[grepl("FBS",l4$Ligand),list(Barcode,Ligand,Nuclei_CP_AreaShape_AreaLog2LigandRLE,
                                     Nuclei_CP_AreaShape_AreaLog2RUV3LigandRLE,
                                     Nuclei_CP_AreaShape_AreaLog2RUV3LoessLigandRLE)]

dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Nuclei_CP_AreaShape_AreaLog2LigandRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LigandRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessLigandRLE"), variable.name = "Processed",value.name = "AreaLog2LigandRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3LigandRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"

p <- ggplot(dt, aes(x = reorder(Barcode, AreaLog2LigandRLE, FUN=median), y = AreaLog2LigandRLE, colour = Ligand))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area(log2) RLE by Barcode (FBS wells only)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  guides(colour=guide_legend(ncol=3))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(Ligand), y = AreaLog2LigandRLE, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by Ligand (FBS wells only)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(Ligand), y = AreaLog2LigandRLE, colour = Processed))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by Ligand (FBS wells only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

dt <- l4[grepl("FBS",l4$Ligand),list(Barcode,ECMp,Nuclei_CP_AreaShape_AreaLog2ECMpRLE, Nuclei_CP_AreaShape_AreaLog2RUV3ECMpRLE, Nuclei_CP_AreaShape_AreaLog2RUV3LoessECMpRLE)]
dt <- melt(dt,id.vars=c("Barcode","ECMp"),measure.vars=c("Nuclei_CP_AreaShape_AreaLog2ECMpRLE","Nuclei_CP_AreaShape_AreaLog2RUV3ECMpRLE","Nuclei_CP_AreaShape_AreaLog2RUV3LoessECMpRLE"), variable.name = "Processed",value.name = "AreaLog2ECMpRLE", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2 RLE"
dt$Processed[(!grepl("Loess",dt$Processed))&grepl("RUV3ECMpRLE$",dt$Processed)] <- "RUV3 RLE"
dt$Processed[(!grepl("LoessRUV3",dt$Processed))&grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess RLE"

p <- ggplot(dt, aes(x = factor(ECMp), y = AreaLog2ECMpRLE))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by ECM Protein (FBS wells only)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(ECMp), y = AreaLog2ECMpRLE, colour=Processed))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Area (log2) RLE by ECM Protein (FBS wells only)"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

```

###Correlation Across Staining Sets
The raw, RUV3 and RUV3Loess versions of the spot cell count signal for each staining set are plotted against each other to show the correlation of results at the MEP level.


```{r compareDatasetsSCC, fig.height=3, fig.width=3}

plotSSs <- function(dt, signalName){
  #Organize the normalized spot cell count by staining sets
  dtc <- dcast(dt,MEP~StainingSet,value.var=signalName)
  xlim<-quantile(c(dtc$SS1,dtc$SS2,dtc$SS3),probs = c(.01,.99), na.rm = TRUE)
  ylim<-xlim
  
  p <- ggplot(dtc,aes(x=SS1,y=SS2))+
    geom_point(size=rel(.5), alpha=.5)+
    geom_smooth(method = "lm")+
    coord_cartesian(xlim, ylim)+
    annotate("text", label=paste0("r=",round(cor(dtc$SS1,dtc$SS2,method = "pearson", use="complete.obs"),2)), x = xlim[1]+.1*xlim[2], y = xlim[2], size = rel(3), colour="red")+
    xlab(paste("SS1",signalName))+ylab(paste("SS2",signalName))+
    ggtitle(paste(signalName, "of SS2 vs SS1"))+
    theme(axis.title=element_text(size=rel(.5)),axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p)) 
  
  p <- ggplot(dtc,aes(x=SS2,y=SS3))+
    geom_point(size=rel(.5), alpha=.5)+
    geom_smooth(method = "lm")+
    coord_cartesian(xlim, ylim)+ 
    annotate("text",label=paste0("r=",round(cor(dtc$SS2,dtc$SS3,method = "pearson", use="complete.obs"),2)), x = xlim[1]+.1*xlim[2], y = xlim[2], size = rel(3), colour="red")+
    xlab(paste("SS2",signalName))+ylab(paste("SS3",signalName))+
    ggtitle(paste(signalName, "of SS3 vs SS2"))+
    theme(axis.title=element_text(size=rel(.5)),axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p)) 
  
  p <- ggplot(dtc,aes(x=SS1,y=SS3))+
    geom_point(size=rel(.5), alpha=.5)+
    geom_smooth(method = "lm")+
    coord_cartesian(xlim, ylim)+
    annotate("text",label=paste0("r=",round(cor(dtc$SS1,dtc$SS3,method = "pearson", use="complete.obs"),2)), x = xlim[1]+.1*xlim[2], y = xlim[2], size = rel(3), colour="red")+
    xlab(paste("SS1",signalName))+ylab(paste("SS3",signalName))+
    ggtitle(paste(signalName, "of SS3 vs SS1"))+
    theme(axis.title=element_text(size=rel(.5)),axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p)) 
}

tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2")
tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2RUV3")
tmp <- plotSSs(dt=l4,signalName = "Spot_PA_SpotCellCountLog2RUV3Loess")
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_AreaLog2RUV3LoessRUV3Loess")
# 
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_IntegratedIntensity_DapiLog2RUV3LoessRUV3Loess")
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_Intensity_MedianIntensity_DapiLog2RUV3LoessRUV3Loess")
# 
# if(any(grepl("Nuclei_PA_AreaShape_EccentricityLogit", colnames(l4)))){
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogit")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3Loess")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3LoessRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_AreaShape_EccentricityLogitRUV3LoessRUV3Loess")
# }
# 
# if(any(grepl("Nuclei_CP_AreaShape_EccentricityLogit", colnames(l4)))){
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogit")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3Loess")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3LoessRUV3")
#   tmp <- plotSSs(dt=l4,signalName = "Nuclei_CP_AreaShape_EccentricityLogitRUV3LoessRUV3Loess")
# }
# 
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogit")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3LoessRUV3")
# tmp <- plotSSs(dt=l4,signalName = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3LoessRUV3Loess")

```

###Pseudo Images of SpotCellCount
The following plots show the raw and normalized Spot Cell Count values at the plate level for three replicate plates.  

```{r pseudoImages,  fig.width=3, fig.height=3.2}
create8WellPseudoImage <- function(DT, pr, prDisplay,highThresh = .99, lowThresh = .01){
  #find high ad low values
  highThreshValue<-quantile(DT[[pr]],probs = highThresh,na.rm=TRUE)
  lowThreshValue<-quantile(DT[[pr]],probs = lowThresh,na.rm=TRUE)
  p <- ggplot(DT, aes_string(x="ArrayColumn", y="ArrayRow",colour=pr))+
    geom_point(size=rel(.25))+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red", limits=c(lowThreshValue, highThreshValue), oob=squish)+
    guides(colour = guide_legend(prDisplay, keywidth = .5, keyheight = .5))+
    ggtitle(paste("\n\n",prDisplay,"for",unique(DT$CellLine), "cells \nin plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),
          axis.title.x = element_text(size=rel(.5)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.4)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
}
l3n$Well_Ligand <- paste(l3n$Well,l3n$Ligand,sep="_")

for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[1],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[9],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[17],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[2],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[10],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[18],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[3],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[11],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[19],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[4],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[12],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[20],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[5],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[13],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[21],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[6],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[14],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[22],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[7],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[15],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[23],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}
for(signalName in c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3Loess")){
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[8],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[16],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
  p <- create8WellPseudoImage(l3n[l3n$Barcode==unique(l3n$Barcode)[24],],pr=signalName, prDisplay=gsub("Spot_PA_SpotCellCount","SCC",signalName), lowThresh = .05, highThresh = .95)
  print(p)
}

```
