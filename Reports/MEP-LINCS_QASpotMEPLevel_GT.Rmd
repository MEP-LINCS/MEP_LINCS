
```{r "setup", include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

#Author: Mark Dane, copyright 2015-2017

library(MEMA)
library(tidyverse)
library(RColorBrewer)
library(d3heatmap)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
#Command line arguments
path <- "/eppec/storage/groups/heiserlab/lincs"
studyName <- "hcc1143_low_serum"
```


```{r readLevel2and4Data, echo=FALSE}

#identify barcodes for getting imageID metadata
barcodes <- c("LI8V01171", "LI8V01172", "LI8V01173a", "LI8V01174","LI8V01175", "LI8V01176", "LI8V01177", "LI8V01178", "LI8V01179")

l2 <- lapply(barcodes, function(barcode, path){
  sd <- read_csv(paste0(path,"/",barcode,"/Analysis/",barcode,"_level2.csv"))
}, path=path) %>%
  bind_rows()
colnames(l2) <- make.names(colnames(l2))

barcodes <- unique(l2$Barcode)

spotQuality <- read_csv("ECMp_Spot_Class.csv",col_types = cols(
  ECMp = col_character(),
  Spot_Quality = col_character(),
  Fragmented = col_logical()))

# k <- unique(l2$k)
# CellLine <- unique(l2$CellLine)
# StainingSet <- unique(l2$StainingSet)
# wellQAThresh <- unique(l2$QA_lowWellQAThreshold)
# lowRegionCellCountThreshold <- unique(l2$QA_lowRegionCellCountThreshold)
# lowSpotCellCountThreshold <-unique(l2$QA_lowSpotCellCountThreshold)
# 
# #Use imageIDs to add URLs
#   l2$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l2$ImageID,'/"',' target="_blank">Omero</a>')
#   l2$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l2$ImageID,'/"',' target="_blank">Omero</a>')
#   l2$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l2$ImageID,'/"',' target="_blank">Omero</a>')

#Shorten reagent names for display


#merge in spot quality data
l2 <- l2 %>%
  left_join(spotQuality, by="ECMp") %>%
  mutate(Barcode_Well_Ligand = paste0(Barcode, "_",Well,"_", Ligand))


```


##MEP-LINCS Spot Level Quality Assessment Report
## `r studyName` 
####date: `r Sys.Date()`

###Summary
This report provides Quality Assessment (QA) of the `r studyName` MEP-LINCS Microenvironment Microarray (MEMA) data.


```{r Heatmaps_QAScores, fig.width=3.7,fig.height=4}
for(barcode in barcodes){
  dtb <- l2 %>%
    filter(Barcode == barcode) 
  
p <- create8WellPseudoImage(dtb, pr = "Spot_PA_SpotCellCount",prDisplay = "Spot Cell Count")
    suppressWarnings(print(p))
} 
```

The following histograms show the raw spot cell counts for each array.  

```{r SCCHistograms, fig.width=3.7,fig.height=4, eval=TRUE}
xLimits <- quantile(l2$Spot_PA_SpotCellCount, probs=c(0,.995))
yLimits <- c(0,75)

for(barcode in barcodes){
  dtb <- l2 %>%
    filter(Barcode == barcode) 
  
  p <- ggplot(dtb, aes(x=Spot_PA_SpotCellCount))+
    geom_histogram(binwidth = 5)+
    coord_cartesian(xlim=xLimits, ylim=yLimits)+
    ggtitle(paste("\n Spot Cell Count Histogram of plate",unique(dtb$Barcode)))+
    xlab("Spot Cell Count")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)),
          axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.7)),
          plot.title = element_text(size = rel(.8)),
          strip.text = element_text(size = rel(.5)),
          legend.text=element_text(size = rel(.3)),
          legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well_Ligand, ncol=4)
  suppressWarnings(print(p))
  
}

```

<br>

###Spot Cell Count Boxplots
Boxplots of the spot cell counts show the values stratified by plate, well and ligand. The blue lines show the dataset median. Each boxplot summarizes data from ~700 spots.     

```{r SCCBoxplots, fig.height=5}

p <- ggplot(l2, aes(x=factor(Barcode), y=Spot_PA_SpotCellCount, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  xlab("")+ylab("Spot Cell Count")+
  ggtitle("Spot Cell Count by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Spot_PA_SpotCellCount), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=factor(Barcode_Well_Ligand), y=Spot_PA_SpotCellCount, colour=Well))+
  geom_boxplot(outlier.size = .5)+
  xlab("")+ylab("Spot Cell Count")+
  ggtitle("Spot Cell Count by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Spot_PA_SpotCellCount), colour="blue", alpha=.5)
print(p)

```


```{r SCCBoxplotsbyLigand, fig.height=5}

p <- ggplot(l2, aes(x=factor(Ligand), y=Spot_PA_SpotCellCount, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Ligand",y="Spot Cell Count",colour="Barcode", title="Spot Cell Count by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Spot_PA_SpotCellCount), colour="blue", alpha=.5)
print(p)


p <- ggplot(l2, aes(x=reorder(factor(Ligand),X = Spot_PA_SpotCellCount, FUN = median), y=Spot_PA_SpotCellCount, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Ligand",y="Spot Cell Count",colour="Barcode", title="Spot Cell Count by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Spot_PA_SpotCellCount), colour="blue", alpha=.5)
print(p)

```

###DAPI Boxplots

DAPI stains the DNA of each nucleus and is used to idenitify the nuclear regions and quantify the amount of DNA. Boxplots of the DAPI intensities show the values stratified by plate and well. Each boxplot summarizes data from ~700 spots.  

```{r DAPIBoxplots, fig.height=5}

p <- ggplot(l2, aes(x=factor(Barcode), y=log2(Nuclei_CP_Intensity_MedianIntensity_Dapi), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Ligand",y="Median Intensity DAPI (log2)",colour="Well", title="Median DAPI Intensity per Spot by Well and Barcode")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = log2(median(l2$Nuclei_CP_Intensity_MedianIntensity_Dapi)), colour="blue", alpha=.5)
print(p)

```


```{r, child='MEP-LINCS_EdUText.Rmd', eval="Nuclei_CP_Intensity_MedianIntensity_EdU" %in% colnames(l2)}
```



```{r rawEdUBoxplots, fig.height=5,  eval="Nuclei_CP_Intensity_MedianIntensity_EdU" %in% colnames(l2)}

p <- ggplot(l2, aes(x=factor(Barcode), y=log2(Nuclei_CP_Intensity_MedianIntensity_EdU), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Barcode",y="Median Intensity EdU (log2)",colour="Well", title="Median EdU Intensity per Spot by Well and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = log2(median(l2$Nuclei_CP_Intensity_MedianIntensity_EdU)), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=factor(Barcode_Well_Ligand), y=log2(Nuclei_CP_Intensity_MedianIntensity_EdU), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Barcode",y="Median Intensity EdU (log2)",colour="Well", title="Median EdU Intensity per Spot by Well and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = log2(median(l2$Nuclei_CP_Intensity_MedianIntensity_EdU)), colour="blue", alpha=.5)
print(p)

```

```{r rawEdUBoxplotsbyWell, fig.height=5,  eval="Nuclei_CP_Intensity_MedianIntensity_EdU" %in% colnames(l2)}

p <- ggplot(l2, aes(x=factor(Well), y=log2(Nuclei_CP_Intensity_MedianIntensity_EdU), colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Well",y="Median Intensity EdU (log2)",colour="Barcode", title="Median EdU Intensity per Spot by Well and Barcode")+xlab("")+ylab("Median Intensity EdU (log2)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = log2(median(l2$Nuclei_CP_Intensity_MedianIntensity_EdU)), colour="blue", alpha=.5)
print(p)

```


```{r rawEdUBoxplotsbyLigand, fig.height=5, eval="Nuclei_PA_Gated_EdUPositiveProportion" %in% colnames(l2)}

p <- ggplot(l2, aes(x=factor(Ligand), y=Nuclei_PA_Gated_EdUPositiveProportion, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(y=c(0,1))+
  labs(x="Ligand",y="EdU+ Proportion", colour="Barcode", title="EdU+ Proportion per Spot by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Nuclei_PA_Gated_EdUPositiveProportion), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=reorder(factor(Ligand), X = Nuclei_PA_Gated_EdUPositiveProportion, FUN = median), y=Nuclei_PA_Gated_EdUPositiveProportion, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  coord_cartesian(y=c(0,1))+
  labs(x="Ligand",y="EdU+ Proportion", colour="Barcode", title="EdU+ Proportion per Spot by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Nuclei_PA_Gated_EdUPositiveProportion), colour="blue", alpha=.5)
print(p)


```





```{r, child='MEP-LINCS_Krt14Krt19Text.Rmd', eval=length(setdiff(c("Cytoplasm_CP_Intensity_MedianIntensity_KRT14","Cytoplasm_CP_Intensity_MedianIntensity_KRT19"),colnames(l2)))==0}

```



```{r rawKrt14Boxplots, fig.height=5, eval="Cytoplasm_CP_Intensity_MedianIntensity_KRT14" %in% colnames(l2)}

p <- ggplot(l2, aes(x=factor(Barcode), y=log2(Cytoplasm_CP_Intensity_MedianIntensity_KRT14), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  xlab("")+ylab("Median Intensity KRT14 (log2)")+
  ggtitle("Median Intensity KRT14 per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(log2(l2$Cytoplasm_CP_Intensity_MedianIntensity_KRT14)), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=factor(Barcode_Well_Ligand), y=log2(Cytoplasm_CP_Intensity_MedianIntensity_KRT14), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  xlab("")+ylab("Median Intensity KRT14 (log2)")+
  ggtitle("Median Intensity KRT14 per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(log2(l2$Cytoplasm_CP_Intensity_MedianIntensity_KRT14)), colour="blue", alpha=.5)
print(p)


p <- ggplot(l2, aes(x=factor(Ligand), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT14, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  #coord_cartesian(y=c(0,1))+
  labs(x="Ligand",y="KRT14 Intensity", colour="Barcode", title="KRT14 Intensity by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Cytoplasm_CP_Intensity_MedianIntensity_KRT14), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=reorder(factor(Ligand), X = Cytoplasm_CP_Intensity_MedianIntensity_KRT14, FUN = median, na.rm=TRUE), y=Cytoplasm_CP_Intensity_MedianIntensity_KRT14, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
   labs(x="Ligand",y="KRT14 Intensity", colour="Barcode", title="KRT14 Intensity by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Cytoplasm_CP_Intensity_MedianIntensity_KRT14, na.rm=TRUE), colour="blue", alpha=.5)
print(p)

```






```{r rawVIMBoxplots, fig.height=5, eval="Cytoplasm_CP_Intensity_MedianIntensity_VIM" %in% colnames(l2)}

p <- ggplot(l2, aes(x=factor(Barcode), y=log2(Cytoplasm_CP_Intensity_MedianIntensity_VIM), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  xlab("")+ylab("Median Intensity VIM (log2)")+
  ggtitle("Median Intensity VIM per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(log2(l2$Cytoplasm_CP_Intensity_MedianIntensity_VIM)), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=factor(Barcode_Well_Ligand), y=log2(Cytoplasm_CP_Intensity_MedianIntensity_VIM), colour=Well))+
  geom_boxplot(outlier.size = .5)+
  xlab("")+ylab("Median Intensity VIM (log2)")+
  ggtitle("Median Intensity VIM per Spot by Well and Barcode ")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(log2(l2$Cytoplasm_CP_Intensity_MedianIntensity_VIM)), colour="blue", alpha=.5)
print(p)


p <- ggplot(l2, aes(x=factor(Ligand), y=Cytoplasm_CP_Intensity_MedianIntensity_VIM, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  #coord_cartesian(y=c(0,1))+
  labs(x="Ligand",y="Median Intensity VIM", colour="Barcode", title="VIM Intensity by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Cytoplasm_CP_Intensity_MedianIntensity_VIM), colour="blue", alpha=.5)
print(p)

p <- ggplot(l2, aes(x=reorder(factor(Ligand), Cytoplasm_CP_Intensity_MedianIntensity_VIM, FUN = median, na.rm=TRUE), y=Cytoplasm_CP_Intensity_MedianIntensity_VIM, colour=factor(Barcode)))+
  geom_boxplot(outlier.size = .5)+
  labs(x="Ligand",y="Median Intensity VIM", colour="Barcode", title="VIM Intensity by Ligand and Barcode")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.8)))
p <- p + geom_hline(yintercept = median(l2$Cytoplasm_CP_Intensity_MedianIntensity_VIM, na.rm=TRUE), colour="blue", alpha=.5)
print(p)

```




```{r, child='MEP-LINCS_ProliferationText.Rmd', eval="Nuclei_PA_Gated_EdUPositiveProportion" %in% colnames(l2)}
```


```{r ProliferationHistogramFull, eval="Nuclei_PA_Gated_EdUPositiveProportion" %in% colnames(l2)}

dt <- l2

p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EdUPositiveProportion))+geom_histogram(binwidth = .001)+
  ggtitle(paste("\n\n","MEP , EdU+ Proportion Distribution"))+
  ylab("Count")+xlab("EdU+ Proportion ()")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```

```{r ProliferationRawHistogram, eval="Nuclei_PA_Gated_EdUPositiveProportion" %in% colnames(l2)}

dt <- l2

p <- ggplot(dt, aes(x=Nuclei_PA_Gated_EdUPositiveProportion))+geom_histogram(binwidth = .001)+
  ggtitle(paste("MEP EdU+ Proportion Distribution"))+
  ylab("Count")+xlab("EdU+ Proportion")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```


```{r ProliferationByLigandFull, , eval=any(grepl("Nuclei_PA_Gated_EdUPositiveProportion",colnames(dt)))}

p <- ggplot(dt, aes(x = reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportion, FUN=median), y = Nuclei_PA_Gated_EdUPositiveProportion, colour = Barcode))+geom_boxplot()+
  coord_cartesian(ylim = c(0,1))+
  ggtitle(paste("MEP , EdU+ Proportion by Ligand"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r ProliferationByECMpFull, eval=any(grepl("Nuclei_PA_Gated_EdUPositiveProportion",colnames(dt)))}

p <- ggplot(dt, aes(x = reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportion, FUN=median), y = Nuclei_PA_Gated_EdUPositiveProportion))+geom_boxplot()+
    coord_cartesian(ylim = c(0,1))+
  ggtitle(paste("MEP , EdU+ Proportion by ECM Protein"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```




```{r, child='MEP-LINCS_LineageText.Rmd', eval="Cytoplasm_PA_Intensity_LineageRatio" %in% colnames(l2)}

```

```{r lineageRatioHistogram, eval=any(grepl("Cytoplasm_PA_Intensity_LineageRatio",colnames(dt)))}

p <- ggplot(dt, aes(x=Cytoplasm_PA_Intensity_LineageRatio))+geom_histogram(binwidth = .02)+
  ggtitle(paste("MEP Lineage Ratio Distribution"))+
  ylab("Count")+xlab("Lineage Ratio")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```

```{r LineageRatioByLigand, eval=any(grepl("Cytoplasm_PA_Intensity_LineageRatio",colnames(dt)))}

p <- ggplot(dt, aes(x = reorder(Ligand, Cytoplasm_PA_Intensity_LineageRatio, FUN=median), y = Cytoplasm_PA_Intensity_LineageRatio, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("\n\nMEP Lineage Ratio by Ligand"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```

```{r lineageRatioByECMp, eval=any(grepl("Cytoplasm_PA_Intensity_LineageRatio",colnames(dt)))}

p <- ggplot(dt, aes(x = reorder(ECMp, Cytoplasm_PA_Intensity_LineageRatio, FUN=median), y = Cytoplasm_PA_Intensity_LineageRatio))+geom_boxplot()+
  ggtitle(paste("MEP LineageRatio by ECM Protein"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```


```{r KRT5ByECMp, eval=any(grepl("Cytoplasm_CP_Intensity_MedianIntensity_KRT5",colnames(dt)))}

p <- ggplot(dt, aes(x = reorder(ECMp, Cytoplasm_CP_Intensity_MedianIntensity_KRT5, FUN=median), y = Cytoplasm_CP_Intensity_MedianIntensity_KRT5))+geom_boxplot()+
  ggtitle(paste("MEP  KRT5 by ECM Protein"))+
  xlab("")+ylab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
suppressWarnings(print(p))

```


```{r, child='MEP-LINCS_SpotQADNAText.Rmd', eval="Nuclei_PA_Cycle_DNA2NProportion" %in% colnames(l2)}
```

<br>


```{r DNAHistogramFull, eval="Nuclei_PA_Cycle_DNA2NProportion" %in% colnames(l2)}

dt <- l2

p <- ggplot(dt, aes(x=Nuclei_PA_Cycle_DNA2NProportion))+
  geom_histogram(binwidth = .003)+
  ggtitle(paste("Spot DNA 2n Proportion Histogam"))+
  ylab("Count")+xlab("DNA 2n Proportion")+
  theme(strip.text = element_text(size = 5))
suppressWarnings(print(p))
```


```{r, child='MEP-LINCS_PCAText.Rmd', eval=FALSE}
```

<br>

```{r createPCAModel, eval=FALSE}

createPCAModel <- function(dt, fvNames,verbose=FALSE){
  #Delete rows with NA values
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- dt %>%
    select(fvNames) %>%
    summarise_all(sd, na.rm=TRUE) %>%
    unlist()
  if(any(stdDevs==0)&verbose)  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
dtn <- dt[fvNames]
dtn <- dtn[complete.cases(dtn),]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dtn, scale.= TRUE)
  rownames(PCAModel$x)<-paste(dt$MEP,gsub("LI8V0","",dt$Barcode), sep="_")
  return(list(PCAModel, dt))
}

dt <- l2
nrPCs <- 9
###PCA Unbiased Analysis  
PCFVNames <- grep("CP|GT",colnames(l2),value=TRUE)
PCFVNames <- grep("Euler|MaximumRadius|_SE|_RobustZ|Method",PCFVNames,invert = TRUE, value = TRUE)

#Get the PCFVs
l2PCAModel <- createPCAModel(dt,PCFVNames)

#Extract the first PCs of each MEP into a matrix
l2pcvDT <- l2PCAModel[[1]]$x %>%
  as.tibble() %>%
  mutate(Barcode = dt$Barcode,
         MEP = dt$MEP)
  [,1:nrPCs],Barcode =dt$Barcode, MEP = dt$MEP)

l2pcvDT <- data.table(l2PCAModel$x[,1:nrPCs],Barcode =dt$Barcode, MEP = dt$MEP)

#Convert to dataframe for use in D3heatmap
l2pcvDT <- data.frame(l2pcvDT)
rownames(l2pcvDT) <- l2pcvDT$MEP
l2pcvDT <- l2pcvDT[,!(names(l2pcvDT) %in% c("MEP", "Barcode"))]

```

```{r PCAHeatmap, fig.height=8, fig.width=7,eval=FALSE}
#Plot the heat map of the entire dataset
d3heatmap(l2pcvDT, scale="column", colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE)
```

```{r, fig.height=3, fig.width=4, eval=FALSE}

var <- l2PCAModel$sd[1:nrPCs]^2
var.percent <- var/sum(var) * 100
barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main  = paste("PCA Scree Plot"))

p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC2, col = l2$Barcode)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Barcode")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC3, col = l2$Barcode)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Barcode")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC2, y = PC3, col = l2$Barcode)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Barcode")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC2, col = l2$Well)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Well")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC3, col = l2$Well)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Well")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC2, y = PC3, col = l2$Well)) +
  geom_point(size = rel(.7), alpha = .8) +
  labs(colour = "Well")+
  theme(legend.text=element_text(size = 6))+
  guides(colour = guide_legend(override.aes = list(size=6)))
print(p)

if(grepl("SS1",StainingSet)){
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC2, col = l2$Cytoplasm_CP_Intensity_IntegratedIntensity_MitoTracker)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Total MitoTracker")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC2, col = l2$Cells_CP_AreaShape_Perimeter)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Perimeter ProportionStatus")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
} else if (ss=="SS2|SSA"){
  
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC2, col = l2$Nuclei_CP_Intensity_MedianIntensity_EdURUVLoess)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Median Intensity EdU")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  
} else if (ss=="SS3|SS4"){
  
  
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC1, y = PC2, col = l2$Cytoplasm_PA_Intensity_LineageRatio)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC3, y = PC4, col = l2$Cytoplasm_PA_Intensity_LineageRatio)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC5, y = PC6, col = l2$Cytoplasm_PA_Intensity_LineageRatio)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
  p <- ggplot(data.frame(l2PCAModel$x), aes(x = PC7, y = PC8, col = l2$Cytoplasm_PA_Intensity_LineageRatio)) +
    geom_point(size = rel(.7), alpha = .8) +
    labs(colour = "Lineage Ratio")+
    theme(legend.text=element_text(size = 6))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  print(p)
  
}
```



##Supplemental Material


###MEMA Layout
All MEMAs in the experiment are in separate wells and have the same design of 48 ECM proteins spotted in 35 rows and 20 columns. The proteins are randomly assigned to spots in the top 30 rows. Rows 31-35 are replicates of rows 1-5. There is a higher number of COL1 spots (shown as black triangles) throughout the array that are control spots used to evaluate spatial variations. The upper left and bottom right corners of each MEMA are image fiducials in the 488nm channel and there are four blank spots for checking orientation in all channels.  

```{r Content Layout,echo=FALSE, message=FALSE, warnings=FALSE, fig.height=6, fig.width=5, eval=exists("l2")}

#Select the A row wells and delete the blanks
df <- l2 %>%
  filter(str_detect(Well,"A"))

p <- ggplot(data=df[!grepl("COL1",df$ECMp),],aes(x = ArrayColumn, y = ArrayRow, fill=ECMp))+
  geom_point(shape=21, size = 2.7)+
  guides(fill=FALSE)+
  theme(legend.text = element_text(size = rel(.5)),legend.title=element_text(size = rel(.5)),plot.title=element_text(size = rel(.8)))+
  scale_y_reverse()+
  xlab("")+ylab("")+
  ggtitle(" \n\nLINCS MEMA A Row Layout")
p <- p+geom_point(data = df[grepl("COL1",df$ECMp),], shape=24, fill="black")
print(p)

```

###Replicate Count
The median replicate count is `r  sprintf("%3.2f",median(table(df$ECMp)))` and the range of the replicate counts is `r range(table(df$ECMp))`.  

```{r Layout Replicate Count,echo=FALSE, message=FALSE, warnings=FALSE, fig.width=6.5, fig.height=8, eval=dim(df)[1]>0}

p <- ggplot(df, aes(x=ECMp))+
  geom_bar(width=.8)+geom_hline(yintercept = median(table(df$ECMp)), colour="blue")+
  scale_y_log10()+
  ggtitle(" \n\nCount of Replicate ECM Proteins In Each MEMA")+
  xlab("Printed ECM Protein")+ylab("Number of spots")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(.8)),axis.title.y = element_text(size=rel(.8)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))

print(p)

```

###Stain Pseudo images
The pseudo images of each well's raw signals are shown in the plots below. Wells that could not be sucessfully imaged due to focus issues are missing from the pseudoimages.

```{r Pseudoimages_all_stains, echo=FALSE, fig.width=3.7,fig.height=4, eval=TRUE}

for(barcode in barcodes){
  dtb <- l2 %>%
    filter(Barcode == barcode) 
  
  p <- create8WellPseudoImage(dtb, pr = "Nuclei_CP_Intensity_MedianIntensity_Dapi", prDisplay = "Median DAPI")
  suppressWarnings(print(p))
  
 
  if (any(grepl("EdU",colnames(dtb))))  {    
    p <- create8WellPseudoImage(dtb, pr = "Nuclei_CP_Intensity_MedianIntensity_EdU",prDisplay = "EdU")
    suppressWarnings(print(p))
  } 
  
  if (any(grepl("KRT14",colnames(dtb))))  {
    
    p <- create8WellPseudoImage(dtb, pr = "Cytoplasm_CP_Intensity_MedianIntensity_KRT14", prDisplay = "KRT14")
    suppressWarnings(print(p))
  }
  
   if (any(grepl("VIM",colnames(dtb))))  {    
    p <- create8WellPseudoImage(dtb, pr = "Cytoplasm_CP_Intensity_MedianIntensity_VIM", prDisplay ="VIM")
    suppressWarnings(print(p))
  }
}
```

```{r, , fig.height=10,  eval="Nuclei_PA_Gated_EdUPositiveProportion" %in% colnames(l2)}

  p <- ggplot(l2, aes(y=Nuclei_PA_Gated_EdUPositiveProportion, x=Well, colour=Well))+
    geom_boxplot()+
    xlab("Well")+
    coord_cartesian( ylim=c(0,1))+
    ggtitle("EdU+ Proportion by Well")+
    facet_wrap(~Barcode)+
    theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  print(p)

```
