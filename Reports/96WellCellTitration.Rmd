---
title: "MCF10A Cell Titrate 96"
author: "Mark Dane"
date: "3/16/2017"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    source_code: embed
---



```{r "setup", include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

#Author: Mark Dane, copyright 2015-2017

library(MEMA)
library(ggplot2)
library(stringr)


path <- "/lincs/share/lincs_user/study"
studyName <- "MCF10A_Cell_Titrate_96"

```


```{r readWriteLevel3and4Data, echo=FALSE}

l3 <- fread(paste0(path,"/",studyName,"/Annotated/",studyName,"_Level3.tsv"),verbose = FALSE, showProgress = FALSE)
l4 <- fread(paste0(path,"/",studyName,"/Annotated/",studyName,"_Level4.tsv"),verbose = FALSE, showProgress = FALSE)

```

###Experiment Overview

```{r cellCountLayout, fig.width=12,fig.height=8}

dt <- unique(l3[,.(Well, Ligand, Barcode, ECMp,Spot_PA_SpotCellCount, ArrayRow, ArrayColumn)])
dt$Well_Ligand <-paste(dt$Well,dt$Ligand,sep="_")
dt$WellRow <- factor(gsub("[[:digit:]]*","",dt$Well),levels = c("B","A"))
dt$WellCol <- as.integer(gsub("[[:alpha:]]","",dt$Well))

p <- ggplot(l3, aes(x=ArrayColumn, y=ArrayRow, colour=Spot_PA_SpotCellCount))+
  geom_point(size=rel(2))+
  scale_y_reverse()+
  scale_x_continuous(breaks= c(min(l3$ArrayColumn),round(mean(c(min(l3$ArrayColumn),max(l3$ArrayColumn)))),max(l3$ArrayColumn)))+
  scale_colour_gradient(low = "white", high = "red")+
  guides(colour = guide_legend("Spot Cell Count", keywidth = .5, keyheight = .5))+
  ggtitle(paste("Spot Cell Count for",unique(l3$CellLine), "cells in plate",unique(l3$Barcode)))+
  xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(1)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)), strip.text = element_text(size = 5))+
  facet_wrap(~Well, ncol=12)
 p
 

p <- ggplot(dt, aes(x =WellCol, y=WellRow, label=factor(Drug1Conc)))+
  geom_text()+
  labs(x="Well Column", y="Well Row",title="Drug Concentrations in Each Well\n(nmolar)")

p
```


***
This experiment used `r length(unique(l3$Barcode))` `r length(unique(l3$Well))` well plates containing `r length(unique(l3$Ligand))-1` ligands plus PBS and `r length(unique(l3$Drug))-1` drug at `r length(unique(l3$Drug1Conc))-1` concentrations plus DMSO.


###Cell Count and EdU+ Drug Response Curves - Compare cell responses to different drug doses and ligands on collagen 1 spots.


```{r drugResponseCurves, fig.width=9,fig.height=9}

#Add error bars to summarized replicate data
dt <- l4[ECMp=="COL1",]
dt <- dt[dt$Drug=="neratinib",]
dt$Drug_Ligand <-paste(dt$Drug,dt$Ligand,sep="_")
p <- ggplot(dt, aes(x=log10(Drug1Conc), y=Spot_PA_SpotCellCount, colour=Ligand))+
  geom_point()+
  labs(x="Drug Concentration (log nM)",
       y="Raw Spot Cell Count",
       title="Cell Count Neratinib Drug Responses\n with Different Ligands+COL1")
p <- p + geom_point(data=l4[ECMp=="COL1"&Drug=="DMSO",], aes(x=Drug1Conc ,y=Spot_PA_SpotCellCount), shape=17, size=rel(3), alpha=.6)
p <- p + geom_errorbar(aes(ymin=Spot_PA_SpotCellCount-Spot_PA_SpotCellCount_SE, ymax=Spot_PA_SpotCellCount+Spot_PA_SpotCellCount_SE, colour=Ligand), width=.1)
p <- p + stat_smooth(se=FALSE, span=.9)
p <- p + annotate("text",x=log10(32),y=10,label="32nM", colour="blue")
p <- p + annotate("text",x=log10(64),y=0,label="64nM", colour="blue")
p <- p + geom_vline(xintercept = log10(32), alpha = .2, colour="blue")
p <- p + geom_vline(xintercept = log10(64), alpha = .2, colour="blue")
p


p <- ggplot(dt, aes(x=log10(Drug1Conc), y=Nuclei_PA_Gated_EdUPositiveProportion, colour=Ligand))+
  geom_point()+
  labs(x="Drug Concentration (log nM)",
       y="EdU+ Proportion",
       title="EdU+ Responses to Neratinib\n with Different Ligands+COL1")
p <- p + geom_point(data=l4[ECMp=="COL1"&Drug=="DMSO",], aes(x=Drug1Conc ,y=Nuclei_PA_Gated_EdUPositiveProportion), shape=17, size=rel(3), alpha=.6)
p <- p + geom_errorbar(aes(ymin=Nuclei_PA_Gated_EdUPositiveProportion-Nuclei_PA_Gated_EdUPositiveProportion_SE, ymax=Nuclei_PA_Gated_EdUPositiveProportion+Nuclei_PA_Gated_EdUPositiveProportion_SE, colour=Ligand), width=.1)
p <- p + stat_smooth(se=FALSE, span=.9)
p <- p + geom_point(data=l4[ECMp=="COL1"&Drug=="DMSO",], aes(x=Drug1Conc ,y=Nuclei_PA_Gated_EdUPositiveProportion), shape=17, size=rel(3), alpha=.6)
p <- p + annotate("text",x=log10(32),y=.01,label="32nM", colour="blue")
p <- p + annotate("text",x=log10(64),y=-.01,label="64nM", colour="blue")
p <- p + geom_vline(xintercept = log10(32), alpha = .2, colour="blue")
p <- p + geom_vline(xintercept = log10(64), alpha = .2, colour="blue")
p

```

***
Compare the spot cell counts and EdU+ proportions in the collagen 1 spots paired with different ligands and neratinib drug concentrations. 

The triangles are the DMSO values. Error bars are the standard error from the ~100 replicate collagen 1 spots. All replicates are spots from the same well, there are no replicate wells.

Previous experiments established the GR50 for neratinib in MCF10A cells to be concentration of 64nM. The MCF10A_Neratinib_2 experiment used a concentration of  32nM.


