
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)
```


```{r }
#Author: Mark Dane, copyright 2015

source("./MEPLINCSFunctions.R")

```



```{r setup,cache=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)
library(Rtsne)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

l1 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine,"_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level1.txt"), showProgress = FALSE)
l2 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine,"_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level2.txt"), showProgress = FALSE)
l3 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level3.txt"), showProgress = FALSE)
l4 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level4.txt"), showProgress = FALSE)

barcodes <- sort(unique(l3$Barcode))


#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.7

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

# https://meplincs.ohsu.edu/webclient/

if(!analysisVersion=="v1"){
  l3$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}

```


#MEP-LINCS `r cellLine` `r ss` Phase 1 Analysis  
####date: `r Sys.Date()`

<br>

##Introduction  
The LINCS `r cellLine` `r ss` experiment was performed with cells grown in `r length(barcodes)` 8-well plates. The `r ss` staining set includes, DAPI, `r unique(l4$Endpoint488)`, `r unique(l4$Endpoint555)` and `r unique(l4$Endpoint647)`. Color images of the cells at each spot were gathered on a Nikon automated microscope. The CP Pipeline `r rawDataVersion` performed the segmentation and the analysis pipeline is `r analysisVersion`.

Intensity, position and morphology data are gathered for each cell, merged with the experiment metadata, normalized with `r unique(l3$NormMethod)`, filtered and summarized. 


```{r Filtering, echo=FALSE}

#Remove the fiducial and blank data
setkey(l3,ECMp)
l3F <- l3[!grepl("fiducial|Fiducial|blank|PBS",l3$ECMp),]
l3F <- l3F[!grepl("FBS", l3F$Ligand)]

#Remove failed QA wells
l3F <- l3F[!l3F$QA_LowWellQA]
l4F <- createl4(l3F)
#Add Robust Z Scores of the normalized Spot Cell Counts #across the entire staining set
l4F <- l4F[,Spot_PA_SpotCellCountLog2RUV3Loess_RobustZ := RZScore(Spot_PA_SpotCellCountLog2RUV3Loess)]

if (grepl("SS2",ss)){
  #Add Robust Z Score of the Edu Signal
  l4F <- l4F[,Nuclei_PA_Gated_EduPositiveProportionRUV3Loess_RobustZ := RZScore(Nuclei_PA_Gated_EduPositiveProportionRUV3Loess)]
}

if (grepl("SS3",ss)){
  #Add Robust Z Scores of the normalized lineage ratios
  l4F <- l4F[, Cytoplasm_PA_Intensity_LineageRatioRUV3Loess_RobustZ:= RZScore(Cytoplasm_PA_Intensity_LineageRatioRUV3Loess)]
  
}

#Filter for high spot occupancy and good quality DAPI####
l3HF <- l3F[l3F$Spot_PA_SpotCellCount > HFSCCThresh]
l3HF <- l3HF[!l3HF$QA_LowDAPIQuality]
l3HF <- l3HF[!l3HF$QA_LowRegionCellCount]
l4HF <- createl4(l3HF)
l4HF <- l4HF[l4HF$Spot_PA_ReplicateCount >= HFRepThresh]

```

<br>

##Filtering
A highly filtered dataset termed "HF" is created as follows. Spots with less than `r HFSCCThresh` cells, wells with QA scores below `r wellQAThresh `, wells with low quality DAPI, MEPS with less than `r HFRepThresh` replicates and the FBS control wells are removed from further analysis of the dataset. The full and HF datasets contain `r length(unique(l4$MEP))` and `r length(unique(l4HF$MEP))` MEPs, respectively.  

<br>

```{r, child='MEP-LINCS_RUV3Text.Rmd', eval=unique(l3$NormMethod)=="RUV3"}
```


```{r, child='MEP-LINCS_RUV3LoessResidualsText.Rmd', eval=unique(l3$NormMethod)=="RUV3LoessResiduals"}
```


##Spot Cell Count Analysis
The spot cell count analysis identifies MEPs with extreme population sizes. The normalized spot cell counts in the plot below are summarized by the median and standard error of their replicates. Hovering over the the interactive plot below shows the MEP identities. Clicking and dragging over a section of the plot will zoom into the selected location. Double clicking on the zooomed plot will restore the original plot. The first spot cell count plot is for the entire dataset while the second plot is for the HF dataset.

<br>


```{r SCCByMEPFull, fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Spot_PA_SpotCellCountLog2RUV3Loess), y = Spot_PA_SpotCellCountLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Spot_PA_SpotCellCountLog2RUV3Loess-Spot_PA_SpotCellCountLog2RUV3Loess_SE, ymax=Spot_PA_SpotCellCountLog2RUV3Loess+Spot_PA_SpotCellCountLog2RUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Spot Cell Count")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Spot Cell Count Normalized (Full dataset)")

p <- p + geom_point(aes(y=Spot_PA_SpotCellCountLog2RUV3Loess),colour = "darkblue", alpha = .5)

ggplotly(p)

```


```{r SCCByMEPHF, fig.width=8, fig.height=6}

dt <- l4HF

p <- ggplot(dt, aes(x =reorder(MEP, Spot_PA_SpotCellCountLog2RUV3Loess), y = Spot_PA_SpotCellCountLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Spot_PA_SpotCellCountLog2RUV3Loess-Spot_PA_SpotCellCountLog2RUV3Loess_SE, ymax=Spot_PA_SpotCellCountLog2RUV3Loess+Spot_PA_SpotCellCountLog2RUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Spot Cell Count")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Spot Cell Count Normalized (HF dataset)")

p <- p + geom_point(aes(y=Spot_PA_SpotCellCountLog2RUV3Loess),colour = "darkblue", alpha = .5)

ggplotly(p)

```



###Normalized Spot Cell Counts

The interactive heatmaps below are arranged by unsupervised clustering of the rows and columns and colored by the normalized spot cell count. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.  The first heatmap is for the full dataset and the second is for the HF dataset.

```{r SCCHeatmapFull, fig.width=8, fig.height=5}

#Cast to get  into ligands and barcodes into rows
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUV3Loess,Barcode)]),Barcode+Ligand~ECMp, value.var = "Spot_PA_SpotCellCountLog2RUV3Loess")

rownames(df) <- df$Ligand
rowPal <- brewer.pal(8,"Dark2")
barcodeCols <- rowPal[as.factor(df$Barcode)]

#Cast again to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Spot_PA_SpotCellCountLog2RUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt")

```


```{r SCCHeatmapHF, fig.width=8, fig.height=5}

#Cast to get  into ligands and barcodes into rows
df <- dcast(data.frame(l4HF[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUV3Loess,Barcode)]),Barcode+Ligand~ECMp, value.var = "Spot_PA_SpotCellCountLog2RUV3Loess")

rownames(df) <- df$Ligand
rowPal <- brewer.pal(8,"Dark2")
barcodeCols <- rowPal[as.factor(df$Barcode)]

#Cast again to get ligands into columns
df <- dcast(data.frame(l4HF[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Spot_PA_SpotCellCountLog2RUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]



d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt")

```

<br>

##Interactive Datatables   
The first datatable below shows the MEP summarized values while the second table shows the spot-level data. The spot-level datatable includes links to the images stored in OHSU's Omero database.  

The tables can be sorted by the values in any column, filtered by any search term and adjusted to display from 5 to 100 rows.  

A useful mining method to use the first table to identify a MEP of interest as this table uses robust methods to summarize the replicates, then view the individual replicate data and images in the second table.  

<br> 


```{r SCCTable}
if(any(grepl("SS1",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed MitoTracker Intnsity","Replicate Count")
} else if (any(grepl("SS2",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Nuclei_PA_Gated_EduPositiveLogitRUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Replicate Count")
} else if (any(grepl("SS3",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
  
} else stop("Unknown staining set name")

dt <- setorder(l4F,-Spot_PA_SpotCellCountLog2RUV3Loess)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

colNamesSpots <- c(colNames[1],"OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"IMage Link",colNamesDisplay[2:length(colNamesDisplay)])
setkey(dt,"Ligand")

dt <- setorder(l3F, -Spot_PA_SpotCellCountLog2RUV3Loess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```

<br>

##DNA Content Analysis

All cells are stained with DAPI and auto0gated as DNA 2N or 4N. The proportion of 2N and 4N cells at each spot is calculated and will always sum to 1. The proportions are logit transformed then RUV3 and loess normalized. Lower normalized values have smaller 2N populations and therefore larger 4N populations.

The first plot below is for the full dataset and the second plot is for the HF dataset.  

<br>

```{r DNA2NByMEPFull, fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess), y = Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess-Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE, ymax=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess+Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("DNA 2N Proportion Ratio")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by DNA Proportion Normalized (Full dataset)")

p <- p + geom_point(aes(y=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess),colour = "blue", alpha = .5)

ggplotly(p)

```

<br>

```{r DNA2NByMEP, fig.width=8, fig.height=6}

setkey(l4HF,"Ligand")
dt <- l4HF[!grepl("FBS",l4HF$Ligand)]

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess), y = Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess-Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE, ymax=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess+Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("DNA 2N Proportion Ratio")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by DNA Proportion Normalized (HF dataset)")

p <- p + geom_point(aes(y=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess),colour = "blue", alpha = .5)

ggplotly(p)

```


###Normalized DNA 2N Heatmaps

The interactive heatmaps below are arranged by unsupervised clustering of the rows and columns and colored by the normalized DNA 2N proportions. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.  The first heatmap is for the full dataset and the second is for the HF dataset.  

```{r DNA2NHeatmapFull, fig.width=8, fig.height=5}

#Cast to get  into ligands and barcodes into rows
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess,Barcode)]),Barcode+Ligand~ECMp, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")

rownames(df) <- df$Ligand
rowPal <- brewer.pal(8,"Dark2")
barcodeCols <- rowPal[as.factor(df$Barcode)]

#Cast again to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt")

```


```{r DNA2NHeatmapHF, fig.width=8, fig.height=5}

#Cast to get  into ligands and barcodes into rows
df <- dcast(data.frame(l4HF[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess,Barcode)]),Barcode+Ligand~ECMp, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")

rownames(df) <- df$Ligand
rowPal <- brewer.pal(8,"Dark2")
barcodeCols <- rowPal[as.factor(df$Barcode)]

#Cast again to get ligands into columns
df <- dcast(data.frame(l4HF[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt")

```



```{r, child='MEP-LINCS_MitoText.Rmd', eval=grepl("SS1",ss)}
```

<br>

```{r MitoTrackerByMEP, eval=grepl("SS1",ss), fig.width=8, fig.height=6}
setkey(l4HF,"Ligand")
dt <- l4HF[!"FBS"]

p <- ggplot(dt, aes(x =reorder(MEP, Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess), y = Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess))+
  geom_errorbar(aes(ymin=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess-Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess_SE, ymax=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess+Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized, MitoTracker Intensity Ratio")+
  coord_cartesian(ylim=c(.9*min(dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess), 1.1*max(dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerRUV3Loess)))+
  geom_point(colour = "green", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by MitoTracker Intensity with SE Bars")

ggplotly(p)
```


```{r, child='MEP-LINCS_ProliferationText.Rmd', eval=grepl("SS2",ss)}
```



```{r NormedProliferationByMEPFull,eval=grepl("SS2",ss), fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess), y = Nuclei_PA_Gated_EduPositiveLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Gated_EduPositiveLogitRUV3Loess-Nuclei_PA_Gated_EduPositiveLogitRUV3Loess_SE, ymax=Nuclei_PA_Gated_EduPositiveLogitRUV3Loess+Nuclei_PA_Gated_EduPositiveLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized, EdU+ Proportion Ratio")+
  geom_point(colour = "red", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by EdU+ Proportion (Normalized, Full Dataset)")

ggplotly(p)
```



```{r NormedProliferationByMEPHF,eval=grepl("SS2",ss), fig.width=8, fig.height=6}

dt <- l4HF

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess), y = Nuclei_PA_Gated_EduPositiveLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Gated_EduPositiveLogitRUV3Loess-Nuclei_PA_Gated_EduPositiveLogitRUV3Loess_SE, ymax=Nuclei_PA_Gated_EduPositiveLogitRUV3Loess+Nuclei_PA_Gated_EduPositiveLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized, EdU+ Proportion Ratio")+
  geom_point(colour = "red", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by EdU+ Proportion (Normalized, HF Dataset)")

ggplotly(p)
```


```{r, child='MEP-LINCS_ProliferationHeatMapsText.Rmd', eval=grepl("SS2",ss)}
```


```{r EdUHeatmapFull, fig.width=8, fig.height=5, eval=grepl("SS2",ss)}

#Cast to get  into ligands and barcodes into rows
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Gated_EduPositiveLogitRUV3Loess,Barcode)]),Barcode+Ligand~ECMp, value.var = "Nuclei_PA_Gated_EduPositiveLogitRUV3Loess")

rownames(df) <- df$Ligand
rowPal <- brewer.pal(8,"Dark2")
barcodeCols <- rowPal[as.factor(df$Barcode)]

#Cast again to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Gated_EduPositiveLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Gated_EduPositiveLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt")

```


```{r EdUHeatmapHF, fig.width=8, fig.height=5, eval=grepl("SS2",ss)}

#Cast to get  into ligands and barcodes into rows
df <- dcast(data.frame(l4HF[,list(ECMp,Ligand,Nuclei_PA_Gated_EduPositiveLogitRUV3Loess,Barcode)]),Barcode+Ligand~ECMp, value.var = "Nuclei_PA_Gated_EduPositiveLogitRUV3Loess")

rownames(df) <- df$Ligand
rowPal <- brewer.pal(8,"Dark2")
barcodeCols <- rowPal[as.factor(df$Barcode)]

#Cast again to get ligands into columns
df <- dcast(data.frame(l4HF[,list(ECMp,Ligand,Nuclei_PA_Gated_EduPositiveLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Gated_EduPositiveLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt")

```


```{r, child='MEP-LINCS_LineageText.Rmd',eval=grepl("SS3",ss)}
```

```{r LineageRatioByMEP,eval=grepl("SS3",ss), fig.width=8, fig.height=6}

dt <- l4HF

p <- ggplot(dt, aes(x =reorder(MEP, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess), y = Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess-Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess_SE, ymax=Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess+Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized, Logged Lineage Ratio")+
  geom_point(colour = "blue", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Logged Lineage Ratio with SE Bars")

ggplotly(p)
```



```{r LineageMarkers, echo=FALSE, fig.width=8, fig.height=6,eval=grepl("SS3",ss)}

dt <- l4HF

p <- ggplot(dt, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5RUV3Loess, y = Cytoplasm_CP_Intensity_MedianIntensity_KRT19RUV3Loess, colour = Ligand))+
  geom_point(alpha=.5)+
  guides(colour=FALSE)+
  xlab("KRT5")+ylab("KRT19")+
  ggtitle("MEP Normalized Lineage Marker Intensities by Ligand")
(gg <- ggplotly(p))
```



##Unbiased Analysis

The unbiased analysis method is:  
Median summarize the cell level data at each spot  
Normalize the spot level data using RUV3 and loess methods  
Median summarize the normalized replicate spot values to the MEP level  
Perform hierarchical clustering on a curated feature vector of MEP intensities and morphologies  

The heatmap below is arranged by unsupervised clustering on the euclidean distance between the non-linearly compressed, scaled feature vectors. The rows are MEPs and the columns are the features. The squares are colored by the normalized MEP feature values.  

Clicking and dragging will zoom in on a section. Double clicking on the zoomed image will return to the full heatmap. This enables identifying MEPS that elicit similar responses on endpoints of interest.  

<br> 

```{r}

lowQALigands <- unique(l3$Ligand[l3$QA_LowWellQA])
fvDT <- filterl4RUV3(l4, lowQALigands)
setkey(fvDT, MEP)
fvDT <- fvDT[!grepl("FBS|Fiducial|fiducial|blank|PBS",fvDT$MEP),]
fvDT <- fvDT[,Barcode := NULL]

#Shorten the feature names
setnames(fvDT,grep("Barcode|MEP",colnames(fvDT), value = TRUE, invert = TRUE),gsub(".*_","",gsub("RUV3Loess","",grep("Barcode|MEP",colnames(fvDT), value = TRUE, invert = TRUE))))
#Remove when not needed
if("2NProportion" %in% colnames(fvDT)) setnames(fvDT,"2NProportion","DNA2NProportion")

#Convert to dataframe for use in D3heatmap
fvDT <- data.frame(fvDT)
rownames(fvDT) <- fvDT$MEP

fvDT <- fvDT[,!(names(fvDT) %in% c("MEP"))]
```


```{r, fig.height=8, fig.width=7, eval = TRUE}
fvDTC <- apply(fvDT,2,fvZoom, min=.02, max=.98)
d3heatmap(fvDTC, scale="column", colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE)

```

##tSNE Maps
The tSNE algorithm is run on the curated feature vectors reducing the dataset to 2 dimensions. The maps are then colored by the barcodes and features to determine how MEPS are similar. 

<br>

```{r createtSNE}

tSNEParameters <- grep("MEP|Ligand|ECMp|Replicate|Barcode",colnames(filterl4RUV3(l4, lowQALigands)), invert=TRUE, value=TRUE)
data_matrix <- scale(as.matrix(dt[,tSNEParameters, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix)
dtt <- cbind(dt,data_tsne$Y)

```

```{r plottSNEBarcode,fig.width=4, fig.height=3}

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "Barcode"))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of Barcode"))+
  #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
  guides(colour = guide_legend(title.theme = element_text(angle=0, size=12),override.aes = list(size=rel(.7),alpha=1)))
print(p)

```


```{r plottSNEFeatures,fig.width=3, fig.height=3}

tmp <- lapply(c(tSNEParameters),function(sigName){
  p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

```


```{r ggplotlytSNEMEPs,fig.width=3, fig.height=2.8}

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "ECMp"))+
  geom_point(size=rel(.8), alpha=.5)+
  ggtitle(paste("tSNE plot by ECMp"))+
  #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
   guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

(gg <- ggplotly(p))

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "Ligand"))+
  geom_point(size=rel(.8), alpha=.5)+
  ggtitle(paste("tSNE plot by Ligand"))+
  #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
   guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
(gg <- ggplotly(p))
```

```{r plottSNEMEPs,fig.width=3, fig.height=3 }
p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "MEP"))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot by MEP"))+
  #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
   guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

```


