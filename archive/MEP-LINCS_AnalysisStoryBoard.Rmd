---
title: MEP-LINCS `r cellLine` `r ss` Analysis  
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)


```


```{r }
#Author: Mark Dane, copyright 2015

source("MEPLINCSFunctions.R")

numericMedianUniqueMetadata<-function(x){
  if(is.numeric(x)){
    as.numeric(median(x))
  } else {
    if(!length(unique(x))==1){
      stop("metadata of summarized values must be identical")
    } else{
      unique(x)
    }
  }
}

summarizeFBS <- function(dt){
  #Summarize all by ligand and ECMp
  #This will only change the FBS data
  dtFBS <- dt[grepl("FBS",dt$Ligand),]
  #Add an na for the barcode valuesas they are not unique
  dtFBS$Barcode <- NA
  #Find the medians or the unique metadata values
  dtFBSMedians <- dtFBS[, lapply(.SD, numericMedianUniqueMetadata), keyby = "Ligand,ECMp"]
  #Delete the FBS wells from the original dt
  dt <- dt[!grepl("FBS",dt$Ligand),]
  #Bind in the summarized FBS values
  dt <- rbind(dt,dtFBSMedians)
  return(dt)
}

btLogit <- function(x){
  2^x/(1+2^x)
}
```



```{r setup,cache=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(Rtsne)
library(readxl)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
l3 <- fread(paste0("../AnnotatedData/",cellLine, "_",ss,"_Level3.txt"), showProgress = FALSE)
l4 <- fread(paste0("../AnnotatedData/",cellLine, "_",ss,"_Level4.txt"), showProgress = FALSE)
barcodes <- sort(unique(l3$Barcode))

#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.6

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3


#Make k parameter visible
k <- unique(l3$k)

if(!analysisVersion=="v1"){
  l3$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}

```




###Introduction  
The LINCS `r cellLine` `r ss` experiment was performed with cells grown in `r length(barcodes)` 8-well plates. The `r ss` staining set includes, DAPI, `r unique(l4$Endpoint488)`, `r unique(l4$Endpoint555)` and `r unique(l4$Endpoint647)`. Color images of the cells at each spot were gathered on a Nikon automated microscope. The CP Pipeline `r rawDataVersion` performed the segmentation and the analysis pipeline is `r analysisVersion`.

Intensity, position and morphology data are gathered for each cell, merged with the experiment metadata, normalized with `r unique(l3$NormMethod)`, filtered and summarized. 


```{r Filtering}

#Remove the fiducial and blank data
setkey(l3,ECMp)
l3F <- l3[!grepl("fiducial|Fiducial|blank|PBS",l3$ECMp),]

#Remove failed QA wells
#Read in manually cureated list
PoorQualityWells <- read_excel("~/GrayLabData/dane/MEP-LINCS/PoorQualityWells.xlsx")
PoorQualityWells$QA_LowWellQA <- TRUE
l3F <- l3F[,QA_LowWellQA :=NULL]
l3F <- merge(l3F,PoorQualityWells,by=c("Barcode","Well"),all=TRUE)
l3F$QA_LowWellQA[is.na(l3F$QA_LowWellQA)]<-FALSE

#Delete wells that have been flagged for low well quality
l3F <- l3F[!l3F$QA_LowWellQA]
l3F <- l3F[l3F$QAScore>wellQAThresh]

#Combine FBS replicates
l3FFBS <- l3F
l3FFBS$Ligand[grepl("FBS",l3FFBS$Ligand)] <- gsub("_.*","",l3FFBS$Ligand[grepl("FBS",l3FFBS$Ligand)])
l4F <- createl4(l3FFBS,  seNames=c("DNA2N","SpotCellCount","EdU","MitoTracker","KRT","Lineage","Fibrillarin"))
#Summarize the FBS MEPs
l4F <- summarizeFBS(l4F)

#Add Robust Z Scores of the normalized Spot Cell Counts #across the entire staining set
l4F <- l4F[,Spot_PA_SpotCellCountLog2RUV3Loess_RobustZ := RZScore(Spot_PA_SpotCellCountLog2RUV3Loess)]

if (grepl("SS2|SS4",ss)){
  #Add Robust Z Score of the EdU Signal
  l4F <- l4F[,Nuclei_PA_Gated_EdUPositiveProportionRUV3Loess_RobustZ := RZScore(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)]
}

if (grepl("SS3|SS4",ss)){
  #Add Robust Z Scores of the normalized lineage ratios
  
  l4F <- l4F[, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess_RobustZ:= RZScore(Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess)]
}

```




###Spot Cell Count Analysis identifies MEPs with extreme population sizes. 


```{r SCCByMEPFull, fig.width=8, fig.height=6}
dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Spot_PA_SpotCellCountLog2RUV3Loess), y = Spot_PA_SpotCellCountLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Spot_PA_SpotCellCountLog2RUV3Loess-Spot_PA_SpotCellCountLog2RUV3Loess_SE, ymax=Spot_PA_SpotCellCountLog2RUV3Loess+Spot_PA_SpotCellCountLog2RUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized Spot Cell Count")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized Spot Cell Count (Full dataset)")

p <- p + geom_point(aes(y=Spot_PA_SpotCellCountLog2RUV3Loess),colour = "darkblue", alpha = .5)

ggplotly(p)

```


*** 

The normalized spot cell counts in the plot below are summarized by the median and standard error of their replicates. Hovering over the the interactive plot below shows the MEP identities. Clicking and dragging over a section of the plot will zoom into the selected location. Double clicking on the zooomed plot will restore the original plot.



###Normalized Spot Cell Counts


```{r SCCHeatmapFull, fig.width=8, fig.height=5}
#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Spot_PA_SpotCellCountLog2RUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```

***

The interactive heatmap is arranged by unsupervised clustering of the rows and columns and colored by the normalized spot cell count. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.  


###The MEP-Level Interactive Datatable shows the MEP summarized values.



```{r SCCTable}
if(any(grepl("SS1",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed MitoTracker Intnsity","Replicate Count")
} else if (any(grepl("SS2|SS4|SS6",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Replicate Count")
} else if (any(grepl("SS3|SS4",ss))){
  if (cellLine=="MCF10A"){
    colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUV3","Cytoplasm_PA_Intensity_LineageRatioLog2RUV3", "Spot_PA_ReplicateCount")
    colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
  }else{
    colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess", "Spot_PA_ReplicateCount")
    colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
    
  }
} else stop("Unknown staining set name")

dt <- setorder(l4F,-Spot_PA_SpotCellCountLog2RUV3Loess)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

```

***
This table can be sorted by the values in any column, filtered by any search term and adjusted to display from 5 to 100 rows.  

A useful mining method to use this to identify a MEP of interest as this table uses robust methods to summarize the replicates, then view the individual replicate data and images in the spot-level table.  


###The Spot-Level Interactive Datatable includes links to the images stored in OHSU's Omero database.

```{r}
colNamesSpots <- c(colNames[1],"ArrayRow","ArrayColumn","OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"ArrayRow","ArrayColumn","Image Link",colNamesDisplay[2:length(colNamesDisplay)])
setkey(dt,"Ligand")

dt <- setorder(l3F, -Spot_PA_SpotCellCountLog2RUV3Loess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```
 

The tables can be sorted by the values in any column, filtered by any search term and adjusted to display from 5 to 100 rows.  

A useful mining method to use the first table to identify a MEP of interest and then view the individual replicate data and images in the spot-level table.  


###DNA Content Analysis 


```{r DNA2NByMEPFull, fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess), y = Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess-Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE, ymax=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess+Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized DNA 2N Proportion Ratio")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized DNA Proportion (Full dataset)")

p <- p + geom_point(aes(y=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess),colour = "blue", alpha = .5)

ggplotly(p)

```

***
All cells are stained with DAPI and autogated as DNA 2N or 4N. The proportion of 2N and 4N cells at each spot is calculated and will always sum to 1. The proportions are logit transformed then RUV3 and loess normalized. Lower normalized values have smaller 2N populations and therefore larger 4N populations.


###Normalized DNA 2N Heatmaps


```{r DNA2NHeatmapFull, fig.width=8, fig.height=5}

#Cast again to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```

***
The interactive heatmap is arranged by unsupervised clustering of the rows and columns and colored by the normalized DNA 2N proportions. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.    

