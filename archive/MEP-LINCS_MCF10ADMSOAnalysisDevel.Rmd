---
title: MEP-LINCS MCF10A DMSO Analysis
author: Mark Dane
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    source_code: embed
    runtime: shiny
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

```

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(ggplot2)

```

```{r functions}
#Author: Mark Dane, copyright 2016
#Stored and run from MEP-LINCS/MEP_LINCS/Release

source("MEPLINCSFunctions.R")
source("MEP-LINCS QANorm Functions.R")

btLogit <- function(x){
  2^x/(1+2^x)
}
```


```{r setup}

library("ggplot2")
library("data.table")
library(scales)
library("knitr")
library("gplots")
library(DT)
library(d3heatmap)
library(plotly)
library(Rtsne)
library(readxl)

#Items to be generalized
datasetName <- "MCF10ADMSO"
cellLine <- "MCF10A"

#Read in the data.table that holds every spot in the cell line
#and can be used to index to the images
l3C <- fread(unique(paste0("../AnnotatedData/",datasetName, "_SSF","_Level3.txt")), showProgress = FALSE)
#Add backtransformed values for some logit transformed signals
l3C <- l3C[,Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess)]
l3C <- l3C[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)]
l3C <- addOmeroIDs(l3C)
#Read in the MEP-Level datasset for the cell line
l4C <- fread(unique(paste0("../AnnotatedData/",datasetName, "_SSF","_Level4.txt")), showProgress = FALSE)

#Add backtransformed values for some logit transformed signals
l4C <- l4C[,Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Cycle_DNA2NProportionLogitRUVLoess)]
l4C <- l4C[,Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed:= btLogit(Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess)]


#Read in curated signals with descriptions
level4Signals <- read_excel("/graylab/share/dane/MEP-LINCS/MEP_LINCS/FeatureDescriptionsLevel4.xls")

```



###Introduction
This analysis is of the MEP-LINCS `r cellLine`  MEMA experiments performed in eight well plates. The data is collected at the cell level from images captured on an automated Nikon microscope. The cell level data is summarized for each MEMA spot, RUV and loess normalized, then replicate spots are summarized to the MEP level.  

The MEP-level dataset is stored and manipulated as a matrix where each of the `r dim(l4C)[1]` rows are a unique MEP and each of the `r dim(l4C)[2]` columns are signals or metadata.

The Spot-level dataset is a matrix where each of the `r dim(l3C)[1]` rows is a spot and each of the `r dim(l3C)[2]` columns are signals or metadata. The spot level data is a sparse matrix where the each row has values from one staining set and NA values for the other.


###Proliferation Boxplots


```{r EdUBoxplotsFull, fig.width=12, fig.height=5}

dt <- l4C[!grepl("NID1|ELN",l4C$ECMp),]
dt$gsColours <- "Samples"
dt$gsColours[grepl("BMP",dt$Ligand)] <- "Selected"
dt$gsColours[grepl("FBS",dt$Ligand)] <- "NegCtrl"
dt$gsColours <- factor(dt$gsColours,levels=c("Samples","Selected","NegCtrl"),ordered=TRUE)
textOrdered <- levels(reorder(dt$Ligand, dt$Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoess, FUN=median))
textColourVec <- rep("black",length.out=length(textOrdered))
textColourVec[grepl("BMP",textOrdered)] <- "gold"
textColourVec[grepl("FBS",textOrdered)] <- "blue"

p <- ggplot(dt, aes(x=reorder(Ligand, Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed, fill=gsColours))+
  geom_boxplot(outlier.colour = NA, alpha=.5)+
  scale_fill_manual(values = c("transparent", "gold", "blue",muted("red")))+
  guides(fill=FALSE, colour=FALSE)+
  #coord_cartesian(ylim = c(-6,-1.5))+
  xlab("Ligand")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ Response by Ligand")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7), colour=textColourVec), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=ECMp),size=rel(.3),alpha=.5)
print(p)


```

***
These box plots show the RUV and loess normalized MEP level data for the gated EdU+ proliferation signal stratified by the ligands. The BMP values are highlighted as these are part of the validation datasets. The NID1 and ELN data are filtered due to low cell counts that create extreme values.  

###Proliferation Boxplots by ECMp Protein


```{r EdUBoxplotsECMp, fig.width=12, fig.height=5}

dt <- l4C

p <- ggplot(dt, aes(x=reorder(ECMp, Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed, FUN=median), y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUVLoessBacktransformed))+
  geom_boxplot(outlier.colour = NA, alpha=.5, fill="transparent")+
  guides(fill=FALSE, colour=FALSE)+
  xlab("ECM Protein")+ylab("Normalized EdU+")+
  ggtitle("MEP EdU+ Response by ECM Protein")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

p <- p +  geom_jitter(aes(colour=Ligand),size=rel(.3),alpha=.5)
print(p)


```

***
These box plots show the RUV and loess normalized MEP level data for the gated EdU+ proliferation signal stratified by the ECM protein.

###Explore Selected Signals


```{r}
#find the curated signals and their values that are in this dataset
dt <- l4C[,level4Signals$Binding[level4Signals$Binding %in% colnames(l4C)], with=FALSE]
#Reduce the level4 signals to those that are available
dtSignals <- level4Signals[level4Signals$Binding %in% colnames(l4C),]
#dt <- setnames(dt,colnames(dt),level4Signals$Name[level4Signals$Binding %in% colnames(dt)])

fillRow(height = "100%", flex = c(NA, 1), 
        verticalLayout(
          selectInput("xaxis", "X Axis:", choices = dtSignals$Name, selected="Spot Cell Count"),
          selectInput("yaxis", "Y Axis:", choices = dtSignals$Name, "EdU+ Proportion (normalized)"),
          selectInput("colour", "Colour by:", choices = dtSignals$Name, "Ligand"),
          selectInput("ligands","Filter on Ligands", choices=unique(l4C$Ligand), multiple=TRUE, selectize=TRUE),
          selectInput("ECMps","Filter on ECM Proteins", choices=unique(l4C$ECMp), multiple=TRUE, selectize=TRUE),
          numericInput("SCCThreshold","Spot Cell Count Threshold",value = 0),
          plotOutput("scatterPlot", height = "100%")),
        
        output$scatterPlot <- renderPlotly({
          dt <- dt[dt$Spot_PA_SpotCellCount>=input$SCCThreshold,]
          if (!is.null(input$ligands)) dt <- dt[Ligand %in% input$ligands,]
          if (!is.null(input$ECMps)) dt <- dt[ECMp %in% input$ECMps,]
          xaxisBinding <- dtSignals$Binding[dtSignals$Name==input$xaxis]
          yaxisBinding <- dtSignals$Binding[dtSignals$Name==input$yaxis]
          colourBinding <- dtSignals$Binding[dtSignals$Name==input$colour]
          
          p <- ggplot(dt, aes_string(x=xaxisBinding, y= yaxisBinding, colour=colourBinding))+
            geom_point()+
            labs(x=input$xaxis, y=input$yaxis)
          if (is.null(input$ECMps)|(!length(input$ECMps)==1)) p <- p+stat_smooth(span=1,se=FALSE)
          ggplotly(p)
        })
)
```

***
x axis: 
`r renderText({dtSignals$Description[dtSignals$Name==input$xaxis]})`

y axis: 
`r renderText({dtSignals$Description[dtSignals$Name==input$yaxis]})`


