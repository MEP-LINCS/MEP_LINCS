---
title: "MCF10A EGF Titrate2"
author: "Mark Dane"
date: "4/20/2017"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    source_code: embed
---



```{r "setup", include=FALSE}
knitr::opts_chunk$set(fig.width=9, fig.height=6,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

#Author: Mark Dane, copyright 2015-2017

library(MEMA)
library(magrittr)
library(ggplot2)
library(stringr)
library(scales)


path <- "/lincs/share/grossse/LI900502/Analysis/v1/LI900502_Main.txt"
studyName <- "mcf10a_egf_titrate2"

```


```{r readGateSummarize, echo=FALSE}
#Get and clean the cell level raw data from the server
rd <- fread(paste0(path),verbose = FALSE, showProgress = FALSE) %>%
  convertColumnNames() %>%
  setnames("Well", "WellIndex")
#Get the well level data from the server
md <- MEMA:::getWellMetadata(fn = "/lincs/share/grossse/LI900502/Analysis/LI900502.xlsx")
#Merge the data and metadata
cell <- merge(md,rd,by="WellIndex")
#Gate the EduIntensities into EdU+
cell$EdUPositive <- 1
cell$EdUPositive[cell$MeanIntensity650>16] <- 2

cell$CellCycleState <- gateOnlocalMinima(cell$TotalIntensity377)
cell <- cell[,WellCellCount := .N, by="Well"]
cell <- cell[,EdUPositiveProportion := sum(EdUPositive==2)/WellCellCount, by="Well"]
cell <- cell[,DNA2nProportion := sum(CellCycleState==1)/WellCellCount, by="Well"]

#Summarize to the well level
parameterNames <- grep("Intensity|Elongation|Perimeter|Area|Proportion|Count",colnames(cell),value = TRUE)
well <- cell[, lapply(.SD, numericMedian), by = "Well",.SDcols = parameterNames] %>%
  merge(md, by="Well")
well <- well[,ArrayRow := factor(gsub("[[:digit:]]*","",Well),levels = c("H","G","F","E","D","C","B","A"))]
well <- well[,ArrayColumn := as.integer(gsub("[[:alpha:]]","",Well))]

```

###Experiment Overview

```{r cellCountLayout}


 p <- ggplot(well, aes(x=ArrayColumn, y=as.factor(LigandConc), colour=WellCellCount))+
  geom_point(size=18)+
  scale_colour_gradient(low = "white", high = "red")+
  guides(colour = guide_legend("Well Cell Count", keywidth = .5, keyheight = .5))+
  ggtitle(paste("Well Cell Count for",studyName))+
  xlab("")+ylab("EGF Concentration (ng/ml)")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(1)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)), strip.text = element_text(size = 5))
 p
 
 p <- ggplot(well, aes(x=ArrayColumn, y=as.factor(LigandConc), colour=EdUPositiveProportion))+
  geom_point(size=18)+
  scale_colour_gradient(low = "white", high = "red")+
  guides(colour = guide_legend("EdU Positive Proportion", keywidth = .5, keyheight = .5))+
  ggtitle(paste("EdU Positive Proportion for",studyName))+
  xlab("")+ylab("EGF Concentration (ng/ml)")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(1)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)), strip.text = element_text(size = 5))
 p
 
 
```

***

This is a continuation of the previous experiment to test the ability of different levels of EGF to promote the growth and proliferation of MCF10A. The changes in this experiment are to increase the number of cells and refine the EGF dose range to identify optimal conditions for MEMA experiments. The previous experiments established an experimental media condition (lacking EGF) that allowed MCF10A cells to survive, but did not promote any growth. 

We wish to titrate in different levels of EGF to identify conditions that give partial growth relative to the full medium condition. We will utilize Experimental Medium (5% HS, + Cholera Toxin, + Hydrocortisone at their standard levels) and spike in differing amounts of EGF. 

This experiment will be run in duplicate by Rebecca and Kaylyn. 

A higher number of cells should be plated in experimental medium in two Ibidi 96 well Cell-treat optical bottom plates (4000/well), reflecting the fact that growth is impaired compared to full medium conditions. Only one row of the first plate (time 0) needs to be plated. The full plate for the second plate should be plated. Cells will be allowed to adhere O/N then the following day, the time 0 plate will be fixed and stained with DAPI and cell mask. 

For the experimental plate, each row of cells will receive a different dose of EGF as follows: Row Number 1. 20ng/ml EGF (standard amount for MCF10A) 2. 0.5 ng/ml EGF 3. 100 pg/ml EGF 4. 75 pg/ml EGF 5. 50 pg/ml EGF 6. 25 pg/ml EGF 7. 10 pg/ml EGF 8. No EGF

Cells will be incubated for 71h. EdU will be added for 1h, then cells will be fixed and stained (DAPI, cell mask, and EdU). EdU staining for the 0h plate is not necessary. 

Omero images are at https://meplincs.ohsu.edu/webclient/?show=screen-1563



###Cell Count and EdU+ Proportion Boxplots

```{r boxplots}

dt <- well
p <- ggplot(dt, aes(x=as.factor(LigandConc), y=WellCellCount))+
 geom_boxplot(fill="transparent", outlier.colour = NA, alpha=.5)+
  labs(x="EGF Concentration (ng/ml)",
       y="Well Cell Count",
       title="Well Cell Count at EGF Concentrations")+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(),size=rel(1),alpha=.5)
p

p <- ggplot(dt, aes(x=as.factor(LigandConc), y=EdUPositiveProportion))+
 geom_boxplot(fill="transparent", outlier.colour = NA, alpha=.5)+
  labs(x="EGF Concentration (ng/ml)",
       y="EdU+ Proportion",
       title="EdU+ Proportion at EGF Concentrations")+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
p <- p +  geom_jitter(aes(),size=rel(1),alpha=.5)
p
```


***
Each boxplot summarizes a row in the well plate. Each dot summarizes the nine images from each well.

###QA Plots

```{r horseshoePlots}

p <- ggplot(cell, aes(x=log2(TotalIntensity377), y=log2(MeanIntensity650), colour=EdUPositive))+
  geom_point(size=rel(.2), alpha=.2)+
  labs(x="Total DAPI Intensity (log2)",
       y= "Mean EDU Intenisty (log2)",
       title = "Cell Cycle based on EdU and DAPI")+
  guides(colour=FALSE)+
    facet_wrap(~LigandConc, labeller = labeller(LigandConc = label_both))
p

p <- ggplot(cell, aes(x=log2(TotalIntensity377)))+
  geom_bar(binwidth = .01)+
  labs(x="Total DAPI Intensity (log2)",
       y= "count",
       title = "Histogram of Total DAPI")+
    facet_wrap(~LigandConc, labeller = labeller(LigandConc = label_both))
p

p <- ggplot(cell, aes(x=log2(MeanIntensity650)))+
  geom_histogram(binwidth = .01)+
  labs(x="Mean EdU Intensity (log2)",
       y= "count",
       title = "Histogram of Mean EdU Intensity (log2)")+
    facet_wrap(~LigandConc, labeller = labeller(LigandConc = label_both))
p
```

***
Each dot in the scatterplots is a cell. The blue dots show cells gated as EdU+. Each figure shows all cells measured in all wells for the labeled EGF concentration.  

EGF concentrations are in ng/ml
