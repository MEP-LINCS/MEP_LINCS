
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

```


```{r functions}
#Author: Mark Dane, copyright 2015

source("~/Documents/MEP-LINCS/MEPLINCSFunctions.R")

createl4KeepRaw <- function (l3) 
{
  #Select all signal names and the minimal metadata
  l4Names <- grep("^Ligand|^ECMp|Barcode|MEP|^Well$|_CP_|_PA_",x = names(l3), value = TRUE)
  l4Names <- grep("_SE", l4Names, value = TRUE, invert = TRUE)
  l4Keep <- l3[, l4Names, with = FALSE]
  l4DT <- l4Keep[, lapply(.SD, numericMedian), keyby = "Ligand,ECMp,MEP,Barcode,Well"]
  return(l4DT)
}

createPCAModel <- function(dt,fvNames){
  #delete any non-varying signals that cannot be scaled to unit variance
  stdDevs <- apply(dt[,fvNames, with=FALSE], 2, sd)
  if(any(stdDevs==0))  cat(paste("Deleting",fvNames[stdDevs==0], "due to 0 variance\n"))
  fvNames <- fvNames[!stdDevs==0]
  PCAModel <- prcomp(as.formula(paste(" ~ ", paste(fvNames, collapse = "+"))), data = dt, scale= TRUE)
  rownames(PCAModel$x)<-dt$MEP
  return(PCAModel)
}

plotPCs <- function(m, PCs, colour, title, legendTitle){
  if(!(length(PCs)==3&class(m)=="prcomp")) stop("PCs must have a length of 3 and m must be of class prcomp")
  p <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[2], colour = colour)) +
    geom_point(size = rel(.5), alpha = .5) +
    labs(colour = legendTitle)+
    ggtitle(title)+
    theme(legend.text=element_text(size = 6),
          plot.title=element_text(size = rel(.7)))+
    guides(colour = guide_legend(override.aes = list(size=6)))
  p <- p + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .5)
  print(p)
  
  p <- ggplot(data.frame(m$x), aes_string(x = PCs[2], y = PCs[3], colour = colour)) +
    geom_point(size = rel(.5), alpha = .5) +
    labs(colour = legendTitle)+
    ggtitle(title)+
    theme(legend.text=element_text(size = 6),
          plot.title=element_text(size = rel(.7)))+
    guides(colour = guide_legend(override.aes = list(size=6)))
    p <- p + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .5)
  print(p)
  
  p <- ggplot(data.frame(m$x), aes_string(x = PCs[1], y = PCs[3], colour = colour)) +
    geom_point(size = rel(.5), alpha = .5) +
    labs(colour = legendTitle)+
    ggtitle(title)+
    theme(legend.text=element_text(size = 6),
          plot.title=element_text(size = rel(.7)))+
    guides(colour = guide_legend(override.aes = list(size=6)))
    p <- p + geom_point(data=data.frame(m$x[grepl("FBS",rownames(m$x)),]),colour="black",size = rel(.5), alpha = .5)
  print(p)
  
}

plotScree <- function(m,nrPCs=9,main  = paste("PCA Scree Plot for",cellLine,ss)){
  var <- m$sd[1:nrPCs]^2
  var.percent <- var/sum(var) * 100
  barplot(var.percent, xlab="PC", ylab="Percent Variance", names.arg=1:length(var.percent), las=1, ylim=c(0,max(var.percent)), col="gray", main=main)
}

```


```{r setup,cache=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(corrplot)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)

l3 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level3.txt"), showProgress = FALSE)
l3 <- l3[,grep("AnnotID",colnames(l3),invert=TRUE, value=TRUE), with=FALSE]
l3 <- l3[!grepl("PBS|blank|Blank|Nidogen|NID1",l3$ECMp)]
l3 <- l3[!grepl("TGFB2",l3$Ligand)]
l3 <- l3[!grepl("Brevican_CXCL12_AGB0414021|CEACAM6_CXCL12_AGB0414021|Cadherin-8 Fc Chimera_CXCL12_AGB0414021|Decorin_CXCL12_AGB0414021|Integrin A3B1_CXCL12_AGB0414021",l3$MEP)]
  

#Make the FBS in each plate unique
l3$Ligand[grepl("FBS",l3$Ligand)] <- paste("FBS",sub("LI8XXX00","",l3$Barcode[grepl("FBS",l3$Ligand)]))
l3$MEP<- paste(l3$ECMp,l3$Ligand,sep="_")

l4 <- createl4KeepRaw(l3)

# l4 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine, "_",ss,"_",rawDataVersion,"_",analysisVersion,"_Level4.txt"), showProgress = FALSE)
# l4 <- l4[,grep("AnnotID",colnames(l4),invert=TRUE, value=TRUE), with=FALSE]
# l4$Ligand[grepl("FBS",l4$Ligand)] <- paste("FBS",sub("LI8XXX00","",l4$Barcode[grepl("FBS",l4$Ligand)]))
# l4$MEP<- paste(l4$ECMp,l4$Ligand,sep="_")

barcodes <- sort(unique(l4$Barcode))

#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.8

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3

#Spot cell count threshold for HF dataset
HFSCCThresh <- 20

#Replicate count threshold for HF Dataset
HFRepThresh <- 3

# https://meplincs.ohsu.edu/webclient/

if(!analysisVersion=="v1"){
  l3$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}

```


#MEP-LINCS `r cellLine` `r ss` Phase 1 PCA Normalization Evaluation
####date: `r Sys.Date()`

##Summary
The MEP-LINCS `r cellLine` `r ss` datasets include four levels of high content imaging data from on Microenvironment Microarrays (MEMAs). After QA filtering, there are `r nrow(l4[!grepl("PBS|Fiducial",l4$ECMp),][!grepl("FBS",l4$Ligand)])` Microenvironment Perturbations (MEPs) that are pairwise combinations of `r length(unique(l4$ECMp[!grepl("PBS|Fiducial",l4$ECMp)]))` printed ECM proteins and `r length(unique(l4$Ligand[!grepl("FBS",l4$Ligand)]))` ligands or growth factors.  

###Filtering
All MEPs with ligand TGFB2, ECM protein Nidogen 1 and specific MEPs Brevican_CXCL12_AGB0414021, CEACAM6_CXCL12_AGB0414021, Cadherin-8 Fc Chimera_CXCL12_AGB0414021, Decorin_CXCL12_AGB0414021 and Integrin A3B1_CXCL12_AGB0414021 have been removed from the analysis due to poor DAPI quality and spatial artifacts in the cell counts. 

<br>
```{r PCARawData, eval=TRUE}


###PCA Unbiased Analysis  
# The unbiased analysis is extended by using Principal Component Analysis (PCA) to reduce the dimensions of the feature vector.
# 
# The unbiased PCA analysis method is:
# Use PCA to transform the entire raw feature set to a much smaller number of principal components (PCFV).  
# Perform unsupervised hierarchical clustering of the first `r nrPCs` PCFVs.  
# 


#Get a PCA model from the raw data
rawFVNames <- grep("ECMp|Ligand|MEP|Barcode|Well|Loess|RUV3",colnames(l4),invert = TRUE, value = TRUE)
rawPCAModel <- createPCAModel(dt=l4, fvNames = rawFVNames)

#print(rownames(rawPCAModel$x[rawPCAModel$x[,"PC2"]>(6),]))

#Get a PCA model from the RUV3 data
RUV3Names <- grep("RUV3$",colnames(l4), value=TRUE)
RUV3PCAModel <- createPCAModel(dt=l4, fvNames = RUV3Names)

#Get a PCA model from the RUV3Loess data
RUV3LoessNames <- grep("RUV3Loess$",colnames(l4), value=TRUE)
RUV3LoessPCAModel <- createPCAModel(dt=l4, fvNames = RUV3LoessNames)

```


```{r plotRawPCA, fig.height=3, fig.width=4}
plotScree(m = rawPCAModel, main=list("PCA Scree Plot of Raw Data",cex = .9))

plotPCs(m = rawPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

plotPCs(m = rawPCAModel,PCs = c("PC4","PC5","PC6"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

plotPCs(m = rawPCAModel,PCs = c("PC7","PC8","PC9"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

```

```{r plotRUV3PCA, fig.height=3, fig.width=4}
plotScree(m = RUV3PCAModel, main=list("PCA Scree Plot of RUV3 Normalized Data",cex = .9))

plotPCs(m = RUV3PCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4$Barcode", title = "PCA of RUV3 Normalized Data", legendTitle = "Barcode")

plotPCs(m = RUV3PCAModel,PCs = c("PC4","PC5","PC6"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

plotPCs(m = RUV3PCAModel,PCs = c("PC7","PC8","PC9"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

```

```{r plotRUV3LoessPCA, fig.height=3, fig.width=4}
plotScree(m = RUV3LoessPCAModel, main=list("PCA Scree Plot of RUV3Loess Normalized Data",cex = .9))

plotPCs(m = RUV3LoessPCAModel,PCs = c("PC1","PC2","PC3"),colour = "l4$Barcode", title = "PCA of RUV3Loess Normalized Data", legendTitle = "Barcode")

plotPCs(m = RUV3LoessPCAModel,PCs = c("PC4","PC5","PC6"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

plotPCs(m = RUV3LoessPCAModel,PCs = c("PC7","PC8","PC9"),colour = "l4$Barcode", title = "PCA of Raw Data", legendTitle = "Barcode")

```

```{r SCC}

dt <- l4[,list(Barcode,Ligand,Spot_PA_SpotCellCountLog2, Spot_PA_SpotCellCountLog2RUV3, Spot_PA_SpotCellCountLog2RUV3Loess )]
dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3","Spot_PA_SpotCellCountLog2RUV3Loess"), variable.name = "Processed",value.name = "SpotCellCount", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2"
dt$Processed[grepl("RUV3$",dt$Processed)] <- "RUV3"
dt$Processed[grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess"

p <- ggplot(dt, aes(x = reorder(Barcode, SpotCellCount, FUN=median), y = SpotCellCount, colour = Ligand))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Spot Cell Count by Barcode (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
    guides(colour=guide_legend(ncol=3))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(Ligand), y = SpotCellCount, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Spot Cell Count by Ligand (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

dt <- l4[,list(Barcode,ECMp,Spot_PA_SpotCellCountLog2, Spot_PA_SpotCellCountLog2RUV3, Spot_PA_SpotCellCountLog2RUV3Loess )]
dt <- melt(dt,id.vars=c("Barcode","ECMp"),measure.vars=c("Spot_PA_SpotCellCountLog2","Spot_PA_SpotCellCountLog2RUV3","Spot_PA_SpotCellCountLog2RUV3Loess"), variable.name = "Processed",value.name = "SpotCellCount", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLog2"
dt$Processed[grepl("RUV3$",dt$Processed)] <- "RUV3"
dt$Processed[grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess"

p <- ggplot(dt, aes(x = factor(ECMp), y = SpotCellCount))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Spot Cell Count by ECM Protein (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(ECMp), y = SpotCellCount, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized Spot Cell Count by ECM Protein and Barcode (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$SpotCellCount), colour="blue", alpha=.5)
suppressWarnings(print(p))

```


```{r EdU}

dt <- l4[,list(Barcode,Ligand,Nuclei_PA_Gated_EduPositiveLogit, Nuclei_PA_Gated_EduPositiveLogitRUV3, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess )]
dt <- melt(dt,id.vars=c("Barcode","Ligand"),measure.vars=c("Nuclei_PA_Gated_EduPositiveLogit","Nuclei_PA_Gated_EduPositiveLogitRUV3","Nuclei_PA_Gated_EduPositiveLogitRUV3Loess"), variable.name = "Processed",value.name = "EdU", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLogit"
dt$Processed[grepl("RUV3$",dt$Processed)] <- "RUV3"
dt$Processed[grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess"

p <- ggplot(dt, aes(x = factor(Barcode), y = EdU, colour = Ligand))+geom_boxplot()+
  ggtitle(paste("MEP Normalized EdU Positive Proportion by Barcode (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
    guides(colour=guide_legend(ncol=3))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$EdU), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(Ligand), y = EdU, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized EdU Positive Proportion by Ligand (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$EdU), colour="blue", alpha=.5)
suppressWarnings(print(p))

dt <- l4[,list(Barcode,ECMp,Nuclei_PA_Gated_EduPositiveLogit, Nuclei_PA_Gated_EduPositiveLogitRUV3, Nuclei_PA_Gated_EduPositiveLogitRUV3Loess )]

dt <- melt(dt,id.vars=c("Barcode","ECMp"),measure.vars=c("Nuclei_PA_Gated_EduPositiveLogit","Nuclei_PA_Gated_EduPositiveLogitRUV3","Nuclei_PA_Gated_EduPositiveLogitRUV3Loess"), variable.name = "Processed",value.name = "EdU", variable.factor = FALSE)
dt$Processed[!grepl("RUV3",dt$Processed)] <- "RawLogit"
dt$Processed[grepl("RUV3$",dt$Processed)] <- "RUV3"
dt$Processed[grepl("RUV3Loess",dt$Processed)] <- "RUV3Loess"

p <- ggplot(dt, aes(x = factor(ECMp), y = EdU))+geom_boxplot()+
  ggtitle(paste("MEP Normalized EdU Positive Proportion by ECM Protein (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$EdU), colour="blue", alpha=.5)
suppressWarnings(print(p))

p <- ggplot(dt, aes(x = factor(ECMp), y = EdU, colour = Barcode))+geom_boxplot()+
  ggtitle(paste("MEP Normalized EdU Positive Proportion by ECM Protein and Barcode (full dataset)"))+
  xlab("")+ylab("")+
  facet_wrap(~Processed, ncol=1)+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
#p <- p+geom_hline(yintercept = median(dt$EdU), colour="blue", alpha=.5)
suppressWarnings(print(p))

```


```{r PCAHeatmap, fig.height=8, fig.width=7, eval=FALSE}

###Interactive Heatmaps
The following heatmaps show the unsupervised clustering on the first 9 PCs for the Raw, RUV3 and RUV3Loess datasets.

<br>
  
#Plot heat maps of the three models
d3heatmap(rawPCAModel$x[,1:9], scale="column", col=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE)
d3heatmap(RUV3PCAModel$x[,1:9], scale="column", col=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE)
d3heatmap(RUV3LoessPCAModel$x[,1:9], scale="column", col=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE)

```

<br>

###Principal Components for the Raw Dataset
```{r RawLoessPCAdatatable}

datatable(format(round(rawPCAModel$x[,1:9],2)), options = list(pageLength = 5))

```

<br>

###Principal Components for the RUV3 Dataset
```{r RUV3PCAdatatable}

datatable(format(round(RUV3PCAModel$x[,1:9],2)), options = list(pageLength = 5))

```

<br>

###Principal Components for the RUV3Loess Dataset
```{r RUV3LoessPCAdatatable}

datatable(format(round(RUV3LoessPCAModel$x[,1:9],2)), options = list(pageLength = 5))

```


<br>

###Principal Components within a well on raw level 3 data
```{r RawPCAlevel3}

#Get a PCA model from the raw data
rawFVNames <- grep("ECMp|Ligand|MEP|Barcode|Well|Loess|RUV3",colnames(l4),invert = TRUE, value = TRUE)
rawPCAModel <- createPCAModel(dt=l4, fvNames = rawFVNames)


```
